(()=>{var de=Object.create;var N=Object.defineProperty,fe=Object.defineProperties,le=Object.getOwnPropertyDescriptor,pe=Object.getOwnPropertyDescriptors,he=Object.getOwnPropertyNames,Y=Object.getOwnPropertySymbols,ue=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var V=(n,t,e)=>t in n?N(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,k=(n,t)=>{for(var e in t||(t={}))K.call(t,e)&&V(n,e,t[e]);if(Y)for(var e of Y(t))_e.call(t,e)&&V(n,e,t[e]);return n},F=(n,t)=>fe(n,pe(t));var W=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var ge=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of he(t))!K.call(n,r)&&r!==e&&N(n,r,{get:()=>t[r],enumerable:!(i=le(t,r))||i.enumerable});return n};var D=(n,t,e)=>(e=n!=null?de(ue(n)):{},ge(t||!n||!n.__esModule?N(e,"default",{value:n,enumerable:!0}):e,n));var v=(n,t,e)=>new Promise((i,r)=>{var o=c=>{try{d(e.next(c))}catch(p){r(p)}},a=c=>{try{d(e.throw(c))}catch(p){r(p)}},d=c=>c.done?i(c.value):Promise.resolve(c.value).then(o,a);d((e=e.apply(n,t)).next())});var Q=W((Ie,I)=>{var C={};C.useBlobBuilder=function(){try{return new Blob([]),!1}catch(n){return!0}}();C.useArrayBufferView=!C.useBlobBuilder&&function(){try{return new Blob([new Uint8Array([])]).size===0}catch(n){return!0}}();I.exports.binaryFeatures=C;var X=I.exports.BlobBuilder;typeof window!="undefined"&&(X=I.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder);function P(){this._pieces=[],this._parts=[]}P.prototype.append=function(n){typeof n=="number"?this._pieces.push(n):(this.flush(),this._parts.push(n))};P.prototype.flush=function(){if(this._pieces.length>0){var n=new Uint8Array(this._pieces);C.useArrayBufferView||(n=n.buffer),this._parts.push(n),this._pieces=[]}};P.prototype.getBuffer=function(){if(this.flush(),C.useBlobBuilder){for(var n=new X,t=0,e=this._parts.length;t<e;t++)n.append(this._parts[t]);return n.getBlob()}else return new Blob(this._parts)};I.exports.BufferBuilder=P});var ee=W((Me,Z)=>{var ye=Q().BufferBuilder,G=Q().binaryFeatures,ve={unpack:function(n){var t=new h(n);return t.unpack()},pack:function(n){var t=new u;t.pack(n);var e=t.getBuffer();return e}};Z.exports=ve;function h(n){this.index=0,this.dataBuffer=n,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}h.prototype.unpack=function(){var n=this.unpack_uint8();if(n<128)return n;if((n^224)<32)return(n^224)-32;var t;if((t=n^160)<=15)return this.unpack_raw(t);if((t=n^176)<=15)return this.unpack_string(t);if((t=n^144)<=15)return this.unpack_array(t);if((t=n^128)<=15)return this.unpack_map(t);switch(n){case 192:return null;case 193:return;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return;case 213:return;case 214:return;case 215:return;case 216:return t=this.unpack_uint16(),this.unpack_string(t);case 217:return t=this.unpack_uint32(),this.unpack_string(t);case 218:return t=this.unpack_uint16(),this.unpack_raw(t);case 219:return t=this.unpack_uint32(),this.unpack_raw(t);case 220:return t=this.unpack_uint16(),this.unpack_array(t);case 221:return t=this.unpack_uint32(),this.unpack_array(t);case 222:return t=this.unpack_uint16(),this.unpack_map(t);case 223:return t=this.unpack_uint32(),this.unpack_map(t)}};h.prototype.unpack_uint8=function(){var n=this.dataView[this.index]&255;return this.index++,n};h.prototype.unpack_uint16=function(){var n=this.read(2),t=(n[0]&255)*256+(n[1]&255);return this.index+=2,t};h.prototype.unpack_uint32=function(){var n=this.read(4),t=((n[0]*256+n[1])*256+n[2])*256+n[3];return this.index+=4,t};h.prototype.unpack_uint64=function(){var n=this.read(8),t=((((((n[0]*256+n[1])*256+n[2])*256+n[3])*256+n[4])*256+n[5])*256+n[6])*256+n[7];return this.index+=8,t};h.prototype.unpack_int8=function(){var n=this.unpack_uint8();return n<128?n:n-(1<<8)};h.prototype.unpack_int16=function(){var n=this.unpack_uint16();return n<32768?n:n-(1<<16)};h.prototype.unpack_int32=function(){var n=this.unpack_uint32();return n<Math.pow(2,31)?n:n-Math.pow(2,32)};h.prototype.unpack_int64=function(){var n=this.unpack_uint64();return n<Math.pow(2,63)?n:n-Math.pow(2,64)};h.prototype.unpack_raw=function(n){if(this.length<this.index+n)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+n+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+n);return this.index+=n,t};h.prototype.unpack_string=function(n){for(var t=this.read(n),e=0,i="",r,o;e<n;)r=t[e],r<128?(i+=String.fromCharCode(r),e++):(r^192)<32?(o=(r^192)<<6|t[e+1]&63,i+=String.fromCharCode(o),e+=2):(o=(r&15)<<12|(t[e+1]&63)<<6|t[e+2]&63,i+=String.fromCharCode(o),e+=3);return this.index+=n,i};h.prototype.unpack_array=function(n){for(var t=new Array(n),e=0;e<n;e++)t[e]=this.unpack();return t};h.prototype.unpack_map=function(n){for(var t={},e=0;e<n;e++){var i=this.unpack(),r=this.unpack();t[i]=r}return t};h.prototype.unpack_float=function(){var n=this.unpack_uint32(),t=n>>31,e=(n>>23&255)-127,i=n&8388607|8388608;return(t===0?1:-1)*i*Math.pow(2,e-23)};h.prototype.unpack_double=function(){var n=this.unpack_uint32(),t=this.unpack_uint32(),e=n>>31,i=(n>>20&2047)-1023,r=n&1048575|1048576,o=r*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(e===0?1:-1)*o};h.prototype.read=function(n){var t=this.index;if(t+n<=this.length)return this.dataView.subarray(t,t+n);throw new Error("BinaryPackFailure: read index out of range")};function u(){this.bufferBuilder=new ye}u.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};u.prototype.pack=function(n){var t=typeof n;if(t==="string")this.pack_string(n);else if(t==="number")Math.floor(n)===n?this.pack_integer(n):this.pack_double(n);else if(t==="boolean")n===!0?this.bufferBuilder.append(195):n===!1&&this.bufferBuilder.append(194);else if(t==="undefined")this.bufferBuilder.append(192);else if(t==="object")if(n===null)this.bufferBuilder.append(192);else{var e=n.constructor;if(e==Array)this.pack_array(n);else if(e==Blob||e==File||n instanceof Blob||n instanceof File)this.pack_bin(n);else if(e==ArrayBuffer)G.useArrayBufferView?this.pack_bin(new Uint8Array(n)):this.pack_bin(n);else if("BYTES_PER_ELEMENT"in n)G.useArrayBufferView?this.pack_bin(new Uint8Array(n.buffer)):this.pack_bin(n.buffer);else if(e==Object||e.toString().startsWith("class"))this.pack_object(n);else if(e==Date)this.pack_string(n.toString());else if(typeof n.toBinaryPack=="function")this.bufferBuilder.append(n.toBinaryPack());else throw new Error('Type "'+e.toString()+'" not yet supported')}else throw new Error('Type "'+t+'" not yet supported');this.bufferBuilder.flush()};u.prototype.pack_bin=function(n){var t=n.length||n.byteLength||n.size;if(t<=15)this.pack_uint8(160+t);else if(t<=65535)this.bufferBuilder.append(218),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(219),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(n)};u.prototype.pack_string=function(n){var t=me(n);if(t<=15)this.pack_uint8(176+t);else if(t<=65535)this.bufferBuilder.append(216),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(217),this.pack_uint32(t);else throw new Error("Invalid length");this.bufferBuilder.append(n)};u.prototype.pack_array=function(n){var t=n.length;if(t<=15)this.pack_uint8(144+t);else if(t<=65535)this.bufferBuilder.append(220),this.pack_uint16(t);else if(t<=4294967295)this.bufferBuilder.append(221),this.pack_uint32(t);else throw new Error("Invalid length");for(var e=0;e<t;e++)this.pack(n[e])};u.prototype.pack_integer=function(n){if(n>=-32&&n<=127)this.bufferBuilder.append(n&255);else if(n>=0&&n<=255)this.bufferBuilder.append(204),this.pack_uint8(n);else if(n>=-128&&n<=127)this.bufferBuilder.append(208),this.pack_int8(n);else if(n>=0&&n<=65535)this.bufferBuilder.append(205),this.pack_uint16(n);else if(n>=-32768&&n<=32767)this.bufferBuilder.append(209),this.pack_int16(n);else if(n>=0&&n<=4294967295)this.bufferBuilder.append(206),this.pack_uint32(n);else if(n>=-2147483648&&n<=2147483647)this.bufferBuilder.append(210),this.pack_int32(n);else if(n>=-9223372036854776e3&&n<=9223372036854776e3)this.bufferBuilder.append(211),this.pack_int64(n);else if(n>=0&&n<=18446744073709552e3)this.bufferBuilder.append(207),this.pack_uint64(n);else throw new Error("Invalid integer")};u.prototype.pack_double=function(n){var t=0;n<0&&(t=1,n=-n);var e=Math.floor(Math.log(n)/Math.LN2),i=n/Math.pow(2,e)-1,r=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),a=t<<31|e+1023<<20|r/o&1048575,d=r%o;this.bufferBuilder.append(203),this.pack_int32(a),this.pack_int32(d)};u.prototype.pack_object=function(n){var t=Object.keys(n),e=t.length;if(e<=15)this.pack_uint8(128+e);else if(e<=65535)this.bufferBuilder.append(222),this.pack_uint16(e);else if(e<=4294967295)this.bufferBuilder.append(223),this.pack_uint32(e);else throw new Error("Invalid length");for(var i in n)n.hasOwnProperty(i)&&(this.pack(i),this.pack(n[i]))};u.prototype.pack_uint8=function(n){this.bufferBuilder.append(n)};u.prototype.pack_uint16=function(n){this.bufferBuilder.append(n>>8),this.bufferBuilder.append(n&255)};u.prototype.pack_uint32=function(n){var t=n&4294967295;this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255)};u.prototype.pack_uint64=function(n){var t=n/Math.pow(2,32),e=n%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};u.prototype.pack_int8=function(n){this.bufferBuilder.append(n&255)};u.prototype.pack_int16=function(n){this.bufferBuilder.append((n&65280)>>8),this.bufferBuilder.append(n&255)};u.prototype.pack_int32=function(n){this.bufferBuilder.append(n>>>24&255),this.bufferBuilder.append((n&16711680)>>>16),this.bufferBuilder.append((n&65280)>>>8),this.bufferBuilder.append(n&255)};u.prototype.pack_int64=function(n){var t=Math.floor(n/Math.pow(2,32)),e=n%Math.pow(2,32);this.bufferBuilder.append((t&4278190080)>>>24),this.bufferBuilder.append((t&16711680)>>>16),this.bufferBuilder.append((t&65280)>>>8),this.bufferBuilder.append(t&255),this.bufferBuilder.append((e&4278190080)>>>24),this.bufferBuilder.append((e&16711680)>>>16),this.bufferBuilder.append((e&65280)>>>8),this.bufferBuilder.append(e&255)};function be(n){var t=n.charCodeAt(0);return t<=2047?"00":t<=65535?"000":t<=2097151?"0000":t<=67108863?"00000":"000000"}function me(n){return n.length>600?new Blob([n]).size:n.replace(/[^\u0000-\u007F]/g,be).length}});var T=W((Pe,j)=>{"use strict";var Ce=Object.prototype.hasOwnProperty,g="~";function M(){}Object.create&&(M.prototype=Object.create(null),new M().__proto__||(g=!1));function we(n,t,e){this.fn=n,this.context=t,this.once=e||!1}function te(n,t,e,i,r){if(typeof e!="function")throw new TypeError("The listener must be a function");var o=new we(e,i||n,r),a=g?g+t:t;return n._events[a]?n._events[a].fn?n._events[a]=[n._events[a],o]:n._events[a].push(o):(n._events[a]=o,n._eventsCount++),n}function O(n,t){--n._eventsCount===0?n._events=new M:delete n._events[t]}function _(){this._events=new M,this._eventsCount=0}_.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Ce.call(e,i)&&t.push(g?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};_.prototype.listeners=function(t){var e=g?g+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,o=i.length,a=new Array(o);r<o;r++)a[r]=i[r].fn;return a};_.prototype.listenerCount=function(t){var e=g?g+t:t,i=this._events[e];return i?i.fn?1:i.length:0};_.prototype.emit=function(t,e,i,r,o,a){var d=g?g+t:t;if(!this._events[d])return!1;var c=this._events[d],p=arguments.length,y,l;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),p){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,r),!0;case 5:return c.fn.call(c.context,e,i,r,o),!0;case 6:return c.fn.call(c.context,e,i,r,o,a),!0}for(l=1,y=new Array(p-1);l<p;l++)y[l-1]=arguments[l];c.fn.apply(c.context,y)}else{var ce=c.length,E;for(l=0;l<ce;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),p){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,i);break;case 4:c[l].fn.call(c[l].context,e,i,r);break;default:if(!y)for(E=1,y=new Array(p-1);E<p;E++)y[E-1]=arguments[E];c[l].fn.apply(c[l].context,y)}}return!0};_.prototype.on=function(t,e,i){return te(this,t,e,i,!1)};_.prototype.once=function(t,e,i){return te(this,t,e,i,!0)};_.prototype.removeListener=function(t,e,i,r){var o=g?g+t:t;if(!this._events[o])return this;if(!e)return O(this,o),this;var a=this._events[o];if(a.fn)a.fn===e&&(!r||a.once)&&(!i||a.context===i)&&O(this,o);else{for(var d=0,c=[],p=a.length;d<p;d++)(a[d].fn!==e||r&&!a[d].once||i&&a[d].context!==i)&&c.push(a[d]);c.length?this._events[o]=c.length===1?c[0]:c:O(this,o)}return this};_.prototype.removeAllListeners=function(t){var e;return t?(e=g?g+t:t,this._events[e]&&O(this,e)):(this._events=new M,this._eventsCount=0),this};_.prototype.off=_.prototype.removeListener;_.prototype.addListener=_.prototype.on;_.prefixed=g;_.EventEmitter=_;typeof j!="undefined"&&(j.exports=_)});var A=D(ee()),ke={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],sdpSemantics:"unified-plan"},f=new class{constructor(){this.CLOUD_HOST="0.peerjs.com";this.CLOUD_PORT=443;this.chunkedMTU=16300;this.defaultConfig=ke;this.pack=A.pack;this.unpack=A.unpack;this._dataCount=1}validateId(n){return!n||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(n)}chunk(n){let t=[],e=n.size,i=Math.ceil(e/f.chunkedMTU),r=0,o=0;for(;o<e;){let a=Math.min(e,o+f.chunkedMTU),d=n.slice(o,a),c={__peerData:this._dataCount,n:r,data:d,total:i};t.push(c),o=a,r++}return this._dataCount++,t}blobToArrayBuffer(n,t,e){let i=new n;return i.onload=function(r){r.target&&e(r.target.result)},i.readAsArrayBuffer(t),i}binaryStringToArrayBuffer(n){let t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)&255;return t.buffer}randomToken(){return Math.random().toString(36).substr(2)}isSecure(){return location.protocol==="https:"}};var ae=D(T());var xe="PeerJS: ";var q=class{constructor(){this._logLevel=0}get logLevel(){return this._logLevel}set logLevel(t){this._logLevel=t}log(...t){this._logLevel>=3&&this._print(3,...t)}warn(...t){this._logLevel>=2&&this._print(2,...t)}error(...t){this._logLevel>=1&&this._print(1,...t)}setLogFunction(t){this._print=t}_print(t,...e){let i=[xe,...e];for(let r in i)i[r]instanceof Error&&(i[r]="("+i[r].name+") "+i[r].message);t>=3?console.log(...i):t>=2?console.warn("WARNING",...i):t>=1&&console.error("ERROR",...i)}},s=new q;var ne=D(T());var R=class extends ne.EventEmitter{constructor({secure:e,host:i,port:r,path:o,key:a,pingInterval:d=5e3,polyfills:c}){var y;super();this._disconnected=!0;this._id=null;this._messagesQueue=[];this.alive=!1;this._destroyed=!1;this.pingInterval=d;let p=e?"wss://":"ws://";this._baseUrl=p+i+":"+r+o+"peerjs?key="+a,this.WebSocketConstructor=(y=c==null?void 0:c.WebSocket)!=null?y:window.WebSocket}get messagesQueue(){return this._messagesQueue}get destroyed(){return this._destroyed}start(e,i){if(this._destroyed)throw new Error("Socket was destroyed!");if(this._id=e,!!this._socket||!this._disconnected)return;let r=`${this._baseUrl}&id=${e}&token=${i}`;this._socket=new this.WebSocketConstructor(r),this._disconnected=!1,this._socket.onmessage=o=>{if(this._destroyed)return;let a;try{a=JSON.parse(o.data),s.log("Server message received:",a)}catch(d){s.log("Invalid server message",o.data);return}this.emit("message",a)},this._socket.onclose=o=>{this._disconnected||this._destroyed||(s.log("Socket closed.",o),this._cleanup(),this._disconnected=!0,this.emit("disconnected"))},this._socket.onopen=()=>{this._disconnected||this._destroyed||(s.log("Socket open"),this.emit("open"),this._sendQueuedMessages(),this._scheduleHeartbeat())}}_scheduleHeartbeat(){this._wsPingTimer=setTimeout(()=>{this._sendHeartbeat()},this.pingInterval)}_sendHeartbeat(){if(this._destroyed)return;if(!this._wsOpen()){s.log("Cannot send heartbeat, because socket closed");return}let e=JSON.stringify({type:"HEARTBEAT"});this._socket.send(e),this._scheduleHeartbeat()}_wsOpen(){return!!this._socket&&this._socket.readyState===1}_sendQueuedMessages(){let e=[...this._messagesQueue];this._messagesQueue=[];for(let i of e)this.send(i);e.length>0&&s.log(`${e.length} queued messages was sent`)}send(e){if(this._destroyed)throw new Error("Socket was destroyed!");if(!e.type){this.emit("error","Invalid message");return}if(!this.alive)return;if(this._id==null||!this._wsOpen()){this._messagesQueue.push(e);return}let i=JSON.stringify(e);this._socket.send(i)}close(){this._disconnected||(this._cleanup(),this._id=null,this._disconnected=!0)}_cleanup(){this._socket&&(this._socket.onopen=this._socket.onmessage=this._socket.onclose=null,this._socket.close(),this._socket=void 0),clearTimeout(this._wsPingTimer)}destroy(){this._destroyed||(this.close(),this._messagesQueue.length=0,this._destroyed=!0)}};function Ee(){}var w=class{constructor(t){this.connection=t}get webRtc(){var t,e;return(e=(t=this.connection.provider.options.polyfills)==null?void 0:t.WebRTC)!=null?e:window}startConnection(t){let e=this._startPeerConnection();if(this.connection.peerConnection=e,this.connection.type==="media"&&t._stream&&this._addTracksToConnection(t._stream,e),t.originator){if(this.connection.type==="data"){let i=this.connection,r={ordered:!!t.reliable},o=e.createDataChannel(i.label,r);i.initialize(o)}this._makeOffer()}else this.handleSDP("OFFER",t.sdp)}_startPeerConnection(){s.log("Creating RTCPeerConnection.");let t=this.webRtc.RTCPeerConnection,e=new t(this.connection.provider.options.config);return this._setupListeners(e),e}_setupListeners(t){let e=this.connection.peer,i=this.connection.connectionId,r=this.connection.type,o=this.connection.provider;s.log("Listening for ICE candidates, remote streams and data channels."),t.onicecandidate=a=>{!a.candidate||!a.candidate.candidate||(s.log(`Received ICE candidates for ${e}:`,a.candidate),o.socket.send({type:"CANDIDATE",payload:{candidate:a.candidate,type:r,connectionId:i},dst:e}))},t.oniceconnectionstatechange=()=>{switch(t.iceConnectionState){case"failed":s.log("iceConnectionState is failed, closing connections to "+e),this.connection.emit("error",new Error("Negotiation of connection to "+e+" failed.")),this.connection.close();break;case"closed":s.log("iceConnectionState is closed, closing connections to "+e),this.connection.emit("error",new Error("Connection to "+e+" closed.")),this.connection.close();break;case"connected":s.log("iceConnectionState changed to connected on the connection with "+e);break;case"disconnected":s.log("iceConnectionState changed to disconnected on the connection with "+e);break;case"completed":s.log("iceConnectionState changed to completed on the connection with "+e),t.onicecandidate=Ee;break}this.connection.emit("iceStateChanged",t.iceConnectionState)},t.ondatachannel=a=>{s.log("Received data channel");let d=a.channel;o.getConnection(e,i).initialize(d)},t.ontrack=a=>{s.log("Received remote stream");let d=a.streams[0],c=o.getConnection(e,i);if(c.type==="media"){let p=c;this._addStreamToMediaConnection(d,p)}}}cleanup(){s.log("Cleaning up PeerConnection to "+this.connection.peer);let t=this.connection.peerConnection;if(!t)return;this.connection.peerConnection=null,t.onicecandidate=t.oniceconnectionstatechange=t.ondatachannel=t.ontrack=null;let e=t.signalingState!=="closed",i=!1;if(this.connection.type==="data"){let o=this.connection.dataChannel;o&&(i=!!o.readyState&&o.readyState!=="closed")}(e||i)&&t.close()}_makeOffer(){return v(this,null,function*(){let t=this.connection.peerConnection,e=this.connection.provider;try{let i=yield t.createOffer(this.connection.options.constraints);if(t.signalingState==="closed")return;s.log("Created offer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp);try{yield t.setLocalDescription(i),s.log("Set localDescription:",i,`for:${this.connection.peer}`);let r={sdp:i,type:this.connection.type,connectionId:this.connection.connectionId,metadata:this.connection.metadata};if(this.connection.type==="data"){let o=this.connection;r=F(k({},r),{label:o.label,reliable:o.reliable,serialization:o.serialization})}e.socket.send({type:"OFFER",payload:r,dst:this.connection.peer})}catch(r){r!="OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer"&&(e.emitError("webrtc",r),s.log("Failed to setLocalDescription, ",r))}}catch(i){e.emitError("webrtc",i),s.log("Failed to createOffer, ",i)}})}_makeAnswer(){return v(this,null,function*(){let t=this.connection.peerConnection,e=this.connection.provider;try{let i=yield t.createAnswer();if(t.signalingState==="closed")return;s.log("Created answer."),this.connection.options.sdpTransform&&typeof this.connection.options.sdpTransform=="function"&&(i.sdp=this.connection.options.sdpTransform(i.sdp)||i.sdp);try{yield t.setLocalDescription(i),s.log("Set localDescription:",i,`for:${this.connection.peer}`),e.socket.send({type:"ANSWER",payload:{sdp:i,type:this.connection.type,connectionId:this.connection.connectionId},dst:this.connection.peer})}catch(r){e.emitError("webrtc",r),s.log("Failed to setLocalDescription, ",r)}}catch(i){e.emitError("webrtc",i),s.log("Failed to create answer, ",i)}})}handleSDP(t,e){return v(this,null,function*(){let i=this.webRtc.RTCSessionDescription;e=new i(e);let r=this.connection.peerConnection,o=this.connection.provider;s.log("Setting remote description",e);let a=this;try{yield r.setRemoteDescription(e),s.log(`Set remoteDescription:${t} for:${this.connection.peer}`),t==="OFFER"&&(yield a._makeAnswer())}catch(d){o.emitError("webrtc",d),s.log("Failed to setRemoteDescription, ",d)}})}handleCandidate(t){return v(this,null,function*(){s.log("handleCandidate:",t);let e=t.candidate,i=t.sdpMLineIndex,r=t.sdpMid,o=this.connection.peerConnection,a=this.connection.provider;try{let d=this.webRtc.RTCIceCandidate;yield o.addIceCandidate(new d({sdpMid:r,sdpMLineIndex:i,candidate:e})),s.log(`Added ICE candidate for:${this.connection.peer}`)}catch(d){a.emitError("webrtc",d),s.log("Failed to handleCandidate, ",d)}})}_addTracksToConnection(t,e){if(s.log(`add tracks from stream ${t.id} to peer connection`),!e.addTrack)return s.error("Your browser does't support RTCPeerConnection#addTrack. Ignored.");t.getTracks().forEach(i=>{e.addTrack(i,t)})}_addStreamToMediaConnection(t,e){s.log(`add stream ${t.id} to media connection ${e.connectionId}`),e.addStream(t)}};var re=D(T()),x=class extends re.EventEmitter{constructor(e,i,r){super();this.peer=e;this.provider=i;this.options=r;this._open=!1;this.metadata=r.metadata}get open(){return this._open}};var H=class extends x{constructor(e,i,r){super(e,i,r);this._localStream=this.options._stream,this.connectionId=this.options.connectionId||H.ID_PREFIX+f.randomToken(),this._negotiator=new w(this),this._localStream&&this._negotiator.startConnection({_stream:this._localStream,originator:!0})}get type(){return"media"}get localStream(){return this._localStream}get remoteStream(){return this._remoteStream}addStream(e){s.log("Receiving stream",e),this._remoteStream=e,super.emit("stream",e)}handleMessage(e){let i=e.type,r=e.payload;switch(e.type){case"ANSWER":this._negotiator.handleSDP(i,r.sdp),this._open=!0;break;case"CANDIDATE":this._negotiator.handleCandidate(r.candidate);break;default:s.warn(`Unrecognized message type:${i} from peer:${this.peer}`);break}}answer(e,i={}){if(this._localStream){s.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");return}this._localStream=e,i&&i.sdpTransform&&(this.options.sdpTransform=i.sdpTransform),this._negotiator.startConnection(F(k({},this.options._payload),{_stream:e}));let r=this.provider._getMessages(this.connectionId);for(let o of r)this.handleMessage(o);this._open=!0}close(){this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this._localStream=null,this._remoteStream=null,this.provider&&(this.provider._removeConnection(this),this.provider=null),this.options&&this.options._stream&&(this.options._stream=null),this.open&&(this._open=!1,super.emit("close"))}},B=H;B.ID_PREFIX="mc_";var oe=D(T());var U=class extends oe.EventEmitter{constructor(e){super();this.fileReader=e;this._queue=[];this._processing=!1;this.fileReader.onload=i=>{this._processing=!1,i.target&&this.emit("done",i.target.result),this.doNextTask()},this.fileReader.onerror=i=>{s.error("EncodingQueue error:",i),this._processing=!1,this.destroy(),this.emit("error",i)}}get queue(){return this._queue}get size(){return this.queue.length}get processing(){return this._processing}enque(e){this.queue.push(e),!this.processing&&this.doNextTask()}destroy(){this.fileReader.abort(),this._queue=[]}doNextTask(){this.size!==0&&(this.processing||(this._processing=!0,this.fileReader.readAsArrayBuffer(this.queue.shift())))}};var $=class extends x{constructor(e,i,r){var o,a;super(e,i,r);this.stringify=JSON.stringify;this.parse=JSON.parse;this._buffer=[];this._bufferSize=0;this._buffering=!1;this._chunkedData={};this.connectionId=this.options.connectionId||$.ID_PREFIX+f.randomToken(),this.label=this.options.label||this.connectionId,this.serialization=this.options.serialization||"binary",this.reliable=!!this.options.reliable,this.FileReaderCtr=(a=(o=i.options.polyfills)==null?void 0:o.FileReader)!=null?a:window.FileReader,this._encodingQueue=new U(new this.FileReaderCtr),this._encodingQueue.on("done",d=>{this._bufferedSend(d)}),this._encodingQueue.on("error",()=>{s.error(`DC#${this.connectionId}: Error occured in encoding from blob to arraybuffer, close DC`),this.close()}),this._negotiator=new w(this),this._negotiator.startConnection(this.options._payload||{originator:!0})}get type(){return"data"}get dataChannel(){return this._dc}get bufferSize(){return this._bufferSize}initialize(e){this._dc=e,this._configureDataChannel()}_configureDataChannel(){(!this.provider.features.binaryBlob||this.provider.features.reliable)&&(this.dataChannel.binaryType="arraybuffer"),this.dataChannel.onopen=()=>{s.log(`DC#${this.connectionId} dc connection success`),this._open=!0,this.emit("open")},this.dataChannel.onmessage=e=>{s.log(`DC#${this.connectionId} dc onmessage:`,e.data),this._handleDataMessage(e)},this.dataChannel.onclose=()=>{s.log(`DC#${this.connectionId} dc closed for:`,this.peer),this.close()}}_handleDataMessage({data:e}){let i=e.constructor,r=this.serialization==="binary"||this.serialization==="binary-utf8",o=e;if(r){if(i===Blob){f.blobToArrayBuffer(this.FileReaderCtr,e,a=>{let d=f.unpack(a);this.emit("data",d)});return}else if(i===ArrayBuffer)o=f.unpack(e);else if(i===String){let a=f.binaryStringToArrayBuffer(e);o=f.unpack(a)}}else this.serialization==="json"&&(o=this.parse(e));if(o.__peerData){this._handleChunk(o);return}super.emit("data",o)}_handleChunk(e){let i=e.__peerData,r=this._chunkedData[i]||{data:[],count:0,total:e.total};if(r.data[e.n]=e.data,r.count++,this._chunkedData[i]=r,r.total===r.count){delete this._chunkedData[i];let o=new Blob(r.data);this._handleDataMessage({data:o})}}close(){this._buffer=[],this._bufferSize=0,this._chunkedData={},this._negotiator&&(this._negotiator.cleanup(),this._negotiator=null),this.provider&&(this.provider._removeConnection(this),this.provider=null),this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this._dc=null),this._encodingQueue&&(this._encodingQueue.destroy(),this._encodingQueue.removeAllListeners(),this._encodingQueue=null),this.open&&(this._open=!1,super.emit("close"))}send(e,i){if(!this.open){super.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));return}if(this.serialization==="json")this._bufferedSend(this.stringify(e));else if(this.serialization==="binary"||this.serialization==="binary-utf8"){let r=f.pack(e);if(!i&&r.size>f.chunkedMTU){this._sendChunks(r);return}this.provider.features.binaryBlob?this._bufferedSend(r):this._encodingQueue.enque(r)}else this._bufferedSend(e)}_bufferedSend(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this._bufferSize=this._buffer.length)}_trySend(e){if(!this.open)return!1;if(this.dataChannel.bufferedAmount>$.MAX_BUFFERED_AMOUNT)return this._buffering=!0,setTimeout(()=>{this._buffering=!1,this._tryBuffer()},50),!1;try{this.dataChannel.send(e)}catch(i){return s.error(`DC#:${this.connectionId} Error when sending:`,i),this._buffering=!0,this.close(),!1}return!0}_tryBuffer(){if(!this.open||this._buffer.length===0)return;let e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this._bufferSize=this._buffer.length,this._tryBuffer())}_sendChunks(e){let i=f.chunk(e);s.log(`DC#${this.connectionId} Try to send ${i.length} chunks...`);for(let r of i)this.send(r,!0)}handleMessage(e){let i=e.payload;switch(e.type){case"ANSWER":this._negotiator.handleSDP(e.type,i.sdp);break;case"CANDIDATE":this._negotiator.handleCandidate(i.candidate);break;default:s.warn("Unrecognized message type:",e.type,"from peer:",this.peer);break}}},m=$;m.ID_PREFIX="dc_",m.MAX_BUFFERED_AMOUNT=8*1024*1024;var z=class{constructor(t){this._options=t}_request(t){var e,i;return((i=(e=this._options.polyfills)==null?void 0:e.fetch)!=null?i:window.fetch)(t)}_buildUrl(t){let i=(this._options.secure?"https://":"http://")+this._options.host+":"+this._options.port+this._options.path+this._options.key+"/"+t;return i+="?ts="+new Date().getTime()+Math.random(),i}retrieveId(){return v(this,null,function*(){let t=this._buildUrl("id");try{let e=yield this._request(t);if(e.status!==200)throw new Error(`Error. Status:${e.status}`);return e.text()}catch(e){s.error("Error retrieving ID",e);let i="";throw this._options.path==="/"&&this._options.host!==f.CLOUD_HOST&&(i=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),new Error("Could not get an ID from the server."+i)}})}listAllPeers(){return v(this,null,function*(){let t=this._buildUrl("peers");try{let e=yield this._request(t);if(e.status!==200){if(e.status===401){let i="";throw this._options.host===f.CLOUD_HOST?i="It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":i="You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",new Error("It doesn't look like you have permission to list peers IDs. "+i)}throw new Error(`Error. Status:${e.status}`)}return e.json()}catch(e){throw s.error("Error retrieving list peers",e),new Error("Could not get list peers from the server."+e)}})}};var se={isUnifiedPlanSupported(n){if(!n&&typeof window!="undefined"&&(n=window),typeof n.RTCRtpTransceiver=="undefined"||!("currentDirection"in n.RTCRtpTransceiver.prototype))return!1;let t,e=!1;try{t=new n.RTCPeerConnection,t.addTransceiver("audio"),e=!0}catch(i){}finally{t&&t.close()}return e}};var b=class extends ae.EventEmitter{constructor(e,i){var o;super();this._id=null;this._lastServerId=null;this._destroyed=!1;this._disconnected=!1;this._open=!1;this._connections=new Map;this._lostMessages=new Map;let r;if(e&&e.constructor==Object?i=e:e&&(r=e.toString()),i=k({debug:0,host:f.CLOUD_HOST,port:f.CLOUD_PORT,path:"/",key:b.DEFAULT_KEY,token:f.randomToken(),config:f.defaultConfig},i),this._options=i,typeof window!="undefined"&&this._options.host==="/"&&(this._options.host=window.location.hostname),this._options.path&&(this._options.path[0]!=="/"&&(this._options.path="/"+this._options.path),this._options.path[this._options.path.length-1]!=="/"&&(this._options.path+="/")),this._options.secure===void 0&&this._options.host!==f.CLOUD_HOST?this._options.secure=f.isSecure():this._options.host==f.CLOUD_HOST&&(this._options.secure=!0),this._options.logFunction&&s.setLogFunction(this._options.logFunction),s.logLevel=this._options.debug||0,this._api=new z(i),this._socket=this._createServerConnection(),this.features=b.getFeatures((o=this._options.polyfills)==null?void 0:o.WebRTC),!this.features.audioVideo&&!this.features.data){this._delayedAbort("browser-incompatible","The current browser does not support WebRTC");return}if(!!r&&!f.validateId(r)){this._delayedAbort("invalid-id",`ID "${r}" is invalid`);return}this.socket.alive=!0,r?this._initialize(r):this._api.retrieveId().then(a=>this._initialize(a)).catch(a=>this._abort("server-error",a))}get id(){return this._id}get options(){return this._options}get open(){return this._open}get socket(){return this._socket}get connections(){let e=Object.create(null);for(let[i,r]of this._connections)e[i]=r;return e}get destroyed(){return this._destroyed}get disconnected(){return this._disconnected}_createServerConnection(){let e=new R(this._options);return e.on("message",i=>{this._handleMessage(i)}),e.on("error",i=>{this._abort("socket-error",i)}),e.on("disconnected",()=>{this.disconnected||(this.emitError("network","Lost connection to server."),this.disconnect())}),e.on("close",()=>{this.disconnected||this._abort("socket-closed","Underlying socket is already closed.")}),e}_initialize(e){this.destroyed||(this._id=e,this.socket.start(e,this._options.token))}_handleMessage(e){let i=e.type,r=e.payload,o=e.src;switch(i){case"OPEN":this._lastServerId=this.id,this._open=!0,this.emit("open",this.id);break;case"ERROR":this._abort("server-error",r.msg);break;case"ID-TAKEN":this._abort("unavailable-id",`ID "${this.id}" is taken`);break;case"INVALID-KEY":this._abort("invalid-key",`API KEY "${this._options.key}" is invalid`);break;case"LEAVE":s.log(`Received leave message from ${o}`),this._cleanupPeer(o),this._connections.delete(o);break;case"EXPIRE":this.emitError("peer-unavailable",`Could not connect to peer ${o}`);break;case"OFFER":{let a=r.connectionId,d=this.getConnection(o,a);if(d&&(d.close(),s.warn(`Offer received for existing Connection ID:${a}`)),r.type==="media")d=new B(o,this,{connectionId:a,_payload:r,metadata:r.metadata}),this._addConnection(o,d),this.emit("call",d);else if(r.type==="data")d=new m(o,this,{connectionId:a,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable}),this._addConnection(o,d),this.emit("connection",d);else{s.warn(`Received malformed connection type:${r.type}`);return}let c=this._getMessages(a);for(let p of c)d.handleMessage(p);break}default:{if(!r){s.warn(`You received a malformed message from ${o} of type ${i}`);return}let a=r.connectionId,d=this.getConnection(o,a);d&&d.peerConnection?d.handleMessage(e):a?this._storeMessage(a,e):s.warn("You received an unrecognized message:",e);break}}}_storeMessage(e,i){this._lostMessages.has(e)||this._lostMessages.set(e,[]),this._lostMessages.get(e).push(i)}_getMessages(e){let i=this._lostMessages.get(e);return i?(this._lostMessages.delete(e),i):[]}connect(e,i={}){if(this.disconnected){s.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");return}let r=new m(e,this,i);return this._addConnection(e,r),r}call(e,i,r={}){if(this.disconnected){s.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");return}if(!i){s.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");return}r._stream=i;let o=new B(e,this,r);return this._addConnection(e,o),o}_addConnection(e,i){s.log(`add connection ${i.type}:${i.connectionId} to peerId:${e}`),this._connections.has(e)||this._connections.set(e,[]),this._connections.get(e).push(i)}_removeConnection(e){let i=this._connections.get(e.peer);if(i){let r=i.indexOf(e);r!==-1&&(i.splice(r,1),i.length===0&&this._connections.delete(e.peer))}this._lostMessages.delete(e.connectionId)}getConnection(e,i){let r=this._connections.get(e);if(!r)return null;for(let o of r)if(o.connectionId===i)return o;return null}_delayedAbort(e,i){setTimeout(()=>{this._abort(e,i)},0)}_abort(e,i){s.error("Aborting!"),this.emitError(e,i),this._lastServerId?this.disconnect():this.destroy()}emitError(e,i){s.error("Error:",i);let r;typeof i=="string"?r=new Error(i):r=i,r.type=e,this.emit("error",r)}destroy(){this.destroyed||(s.log(`Destroy peer with ID:${this.id}`),this.disconnect(),this._cleanup(),this.socket.destroy(),this._destroyed=!0,this.emit("close"))}_cleanup(){for(let e of this._connections.keys())this._cleanupPeer(e),this._connections.delete(e);this.socket.removeAllListeners()}_cleanupPeer(e){let i=this._connections.get(e);if(!!i)for(let r of i)r.close()}disconnect(){if(this.disconnected)return;let e=this.id;s.log(`Disconnect peer with ID:${e}`),this._disconnected=!0,this._open=!1,this.socket.alive=!1,this.socket.close(),this._lastServerId=e,this._id=null,this.emit("disconnected",e)}reconnect(){if(this.disconnected&&!this.destroyed)s.log(`Attempting reconnection to server with ID ${this._lastServerId}`),this._disconnected=!1,this.socket.alive=!0,this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(!this.disconnected&&!this.open)s.error("In a hurry? We're still trying to make the initial connection!");else throw new Error(`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`)}}listAllPeers(e=i=>{}){this._api.listAllPeers().then(i=>e(i)).catch(i=>this._abort("server-error",i))}static getFeatures(e){return!e&&typeof window!="undefined"&&(e=window),b._features||(b._features=b.checkFeatures(e)),b._features}static checkFeatures(e){!e&&typeof window!="undefined"&&(e=window);let i={webRTC:typeof e.RTCPeerConnection!="undefined",audioVideo:!0,data:!1,binaryBlob:!1,reliable:!1,unifiedPlan:!1};if(!i.webRTC)return i;let r;try{r=new e.RTCPeerConnection(f.defaultConfig);let o;try{o=r.createDataChannel("_PEERJSTEST",{ordered:!0}),i.data=!0,i.reliable=!!o.ordered;try{o.binaryType="blob",i.binaryBlob=!0}catch(a){}}catch(a){}finally{o&&o.close()}}catch(o){}finally{r&&r.close()}return i.unifiedPlan=se.isUnifiedPlanSupported(e),i}},S=b;S.DEFAULT_KEY="peerjs";var Ct=S;typeof window!="undefined"&&(window.Peer=S);})();
//# sourceMappingURL=peerjs.min.js.map
