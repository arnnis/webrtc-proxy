{
  "version": 3,
  "sources": ["../node_modules/peerjs-js-binarypack/lib/bufferbuilder.js", "../node_modules/peerjs-js-binarypack/lib/binarypack.js", "../node_modules/eventemitter3/index.js", "../lib/utils.ts", "../lib/peer.ts", "../lib/logger.ts", "../lib/socket.ts", "../lib/negotiator.ts", "../lib/baseconnection.ts", "../lib/mediaconnection.ts", "../lib/encodingQueue.ts", "../lib/dataconnection.ts", "../lib/api.ts", "../lib/supports.ts", "../lib/index.ts"],
  "sourcesContent": ["var binaryFeatures = {};\r\nbinaryFeatures.useBlobBuilder = (function () {\r\n  try {\r\n    new Blob([]);\r\n    return false;\r\n  } catch (e) {\r\n    return true;\r\n  }\r\n})();\r\n\r\nbinaryFeatures.useArrayBufferView = !binaryFeatures.useBlobBuilder && (function () {\r\n  try {\r\n    return (new Blob([new Uint8Array([])])).size === 0;\r\n  } catch (e) {\r\n    return true;\r\n  }\r\n})();\r\n\r\nmodule.exports.binaryFeatures = binaryFeatures;\r\nvar BlobBuilder = module.exports.BlobBuilder;\r\nif (typeof window !== 'undefined') {\r\n  BlobBuilder = module.exports.BlobBuilder = window.WebKitBlobBuilder ||\r\n    window.MozBlobBuilder || window.MSBlobBuilder || window.BlobBuilder;\r\n}\r\n\r\nfunction BufferBuilder () {\r\n  this._pieces = [];\r\n  this._parts = [];\r\n}\r\n\r\nBufferBuilder.prototype.append = function (data) {\r\n  if (typeof data === 'number') {\r\n    this._pieces.push(data);\r\n  } else {\r\n    this.flush();\r\n    this._parts.push(data);\r\n  }\r\n};\r\n\r\nBufferBuilder.prototype.flush = function () {\r\n  if (this._pieces.length > 0) {\r\n    var buf = new Uint8Array(this._pieces);\r\n    if (!binaryFeatures.useArrayBufferView) {\r\n      buf = buf.buffer;\r\n    }\r\n    this._parts.push(buf);\r\n    this._pieces = [];\r\n  }\r\n};\r\n\r\nBufferBuilder.prototype.getBuffer = function () {\r\n  this.flush();\r\n  if (binaryFeatures.useBlobBuilder) {\r\n    var builder = new BlobBuilder();\r\n    for (var i = 0, ii = this._parts.length; i < ii; i++) {\r\n      builder.append(this._parts[i]);\r\n    }\r\n    return builder.getBlob();\r\n  } else {\r\n    return new Blob(this._parts);\r\n  }\r\n};\r\n\r\nmodule.exports.BufferBuilder = BufferBuilder;\r\n", "var BufferBuilder = require('./bufferbuilder').BufferBuilder;\r\nvar binaryFeatures = require('./bufferbuilder').binaryFeatures;\r\n\r\nvar BinaryPack = {\r\n  unpack: function (data) {\r\n    var unpacker = new Unpacker(data);\r\n    return unpacker.unpack();\r\n  },\r\n  pack: function (data) {\r\n    var packer = new Packer();\r\n    packer.pack(data);\r\n    var buffer = packer.getBuffer();\r\n    return buffer;\r\n  }\r\n};\r\n\r\nmodule.exports = BinaryPack;\r\n\r\nfunction Unpacker (data) {\r\n  // Data is ArrayBuffer\r\n  this.index = 0;\r\n  this.dataBuffer = data;\r\n  this.dataView = new Uint8Array(this.dataBuffer);\r\n  this.length = this.dataBuffer.byteLength;\r\n}\r\n\r\nUnpacker.prototype.unpack = function () {\r\n  var type = this.unpack_uint8();\r\n  if (type < 0x80) {\r\n    return type;\r\n  } else if ((type ^ 0xe0) < 0x20) {\r\n    return (type ^ 0xe0) - 0x20;\r\n  }\r\n\r\n  var size;\r\n  if ((size = type ^ 0xa0) <= 0x0f) {\r\n    return this.unpack_raw(size);\r\n  } else if ((size = type ^ 0xb0) <= 0x0f) {\r\n    return this.unpack_string(size);\r\n  } else if ((size = type ^ 0x90) <= 0x0f) {\r\n    return this.unpack_array(size);\r\n  } else if ((size = type ^ 0x80) <= 0x0f) {\r\n    return this.unpack_map(size);\r\n  }\r\n\r\n  switch (type) {\r\n    case 0xc0:\r\n      return null;\r\n    case 0xc1:\r\n      return undefined;\r\n    case 0xc2:\r\n      return false;\r\n    case 0xc3:\r\n      return true;\r\n    case 0xca:\r\n      return this.unpack_float();\r\n    case 0xcb:\r\n      return this.unpack_double();\r\n    case 0xcc:\r\n      return this.unpack_uint8();\r\n    case 0xcd:\r\n      return this.unpack_uint16();\r\n    case 0xce:\r\n      return this.unpack_uint32();\r\n    case 0xcf:\r\n      return this.unpack_uint64();\r\n    case 0xd0:\r\n      return this.unpack_int8();\r\n    case 0xd1:\r\n      return this.unpack_int16();\r\n    case 0xd2:\r\n      return this.unpack_int32();\r\n    case 0xd3:\r\n      return this.unpack_int64();\r\n    case 0xd4:\r\n      return undefined;\r\n    case 0xd5:\r\n      return undefined;\r\n    case 0xd6:\r\n      return undefined;\r\n    case 0xd7:\r\n      return undefined;\r\n    case 0xd8:\r\n      size = this.unpack_uint16();\r\n      return this.unpack_string(size);\r\n    case 0xd9:\r\n      size = this.unpack_uint32();\r\n      return this.unpack_string(size);\r\n    case 0xda:\r\n      size = this.unpack_uint16();\r\n      return this.unpack_raw(size);\r\n    case 0xdb:\r\n      size = this.unpack_uint32();\r\n      return this.unpack_raw(size);\r\n    case 0xdc:\r\n      size = this.unpack_uint16();\r\n      return this.unpack_array(size);\r\n    case 0xdd:\r\n      size = this.unpack_uint32();\r\n      return this.unpack_array(size);\r\n    case 0xde:\r\n      size = this.unpack_uint16();\r\n      return this.unpack_map(size);\r\n    case 0xdf:\r\n      size = this.unpack_uint32();\r\n      return this.unpack_map(size);\r\n  }\r\n};\r\n\r\nUnpacker.prototype.unpack_uint8 = function () {\r\n  var byte = this.dataView[this.index] & 0xff;\r\n  this.index++;\r\n  return byte;\r\n};\r\n\r\nUnpacker.prototype.unpack_uint16 = function () {\r\n  var bytes = this.read(2);\r\n  var uint16 =\r\n    ((bytes[0] & 0xff) * 256) + (bytes[1] & 0xff);\r\n  this.index += 2;\r\n  return uint16;\r\n};\r\n\r\nUnpacker.prototype.unpack_uint32 = function () {\r\n  var bytes = this.read(4);\r\n  var uint32 =\r\n    ((bytes[0] * 256 +\r\n      bytes[1]) * 256 +\r\n      bytes[2]) * 256 +\r\n    bytes[3];\r\n  this.index += 4;\r\n  return uint32;\r\n};\r\n\r\nUnpacker.prototype.unpack_uint64 = function () {\r\n  var bytes = this.read(8);\r\n  var uint64 =\r\n    ((((((bytes[0] * 256 +\r\n      bytes[1]) * 256 +\r\n      bytes[2]) * 256 +\r\n      bytes[3]) * 256 +\r\n      bytes[4]) * 256 +\r\n      bytes[5]) * 256 +\r\n      bytes[6]) * 256 +\r\n    bytes[7];\r\n  this.index += 8;\r\n  return uint64;\r\n};\r\n\r\nUnpacker.prototype.unpack_int8 = function () {\r\n  var uint8 = this.unpack_uint8();\r\n  return (uint8 < 0x80) ? uint8 : uint8 - (1 << 8);\r\n};\r\n\r\nUnpacker.prototype.unpack_int16 = function () {\r\n  var uint16 = this.unpack_uint16();\r\n  return (uint16 < 0x8000) ? uint16 : uint16 - (1 << 16);\r\n};\r\n\r\nUnpacker.prototype.unpack_int32 = function () {\r\n  var uint32 = this.unpack_uint32();\r\n  return (uint32 < Math.pow(2, 31)) ? uint32\r\n    : uint32 - Math.pow(2, 32);\r\n};\r\n\r\nUnpacker.prototype.unpack_int64 = function () {\r\n  var uint64 = this.unpack_uint64();\r\n  return (uint64 < Math.pow(2, 63)) ? uint64\r\n    : uint64 - Math.pow(2, 64);\r\n};\r\n\r\nUnpacker.prototype.unpack_raw = function (size) {\r\n  if (this.length < this.index + size) {\r\n    throw new Error('BinaryPackFailure: index is out of range' +\r\n      ' ' + this.index + ' ' + size + ' ' + this.length);\r\n  }\r\n  var buf = this.dataBuffer.slice(this.index, this.index + size);\r\n  this.index += size;\r\n\r\n  // buf = util.bufferToString(buf);\r\n\r\n  return buf;\r\n};\r\n\r\nUnpacker.prototype.unpack_string = function (size) {\r\n  var bytes = this.read(size);\r\n  var i = 0;\r\n  var str = '';\r\n  var c;\r\n  var code;\r\n\r\n  while (i < size) {\r\n    c = bytes[i];\r\n    if (c < 128) {\r\n      str += String.fromCharCode(c);\r\n      i++;\r\n    } else if ((c ^ 0xc0) < 32) {\r\n      code = ((c ^ 0xc0) << 6) | (bytes[i + 1] & 63);\r\n      str += String.fromCharCode(code);\r\n      i += 2;\r\n    } else {\r\n      code = ((c & 15) << 12) | ((bytes[i + 1] & 63) << 6) |\r\n        (bytes[i + 2] & 63);\r\n      str += String.fromCharCode(code);\r\n      i += 3;\r\n    }\r\n  }\r\n\r\n  this.index += size;\r\n  return str;\r\n};\r\n\r\nUnpacker.prototype.unpack_array = function (size) {\r\n  var objects = new Array(size);\r\n  for (var i = 0; i < size; i++) {\r\n    objects[i] = this.unpack();\r\n  }\r\n  return objects;\r\n};\r\n\r\nUnpacker.prototype.unpack_map = function (size) {\r\n  var map = {};\r\n  for (var i = 0; i < size; i++) {\r\n    var key = this.unpack();\r\n    var value = this.unpack();\r\n    map[key] = value;\r\n  }\r\n  return map;\r\n};\r\n\r\nUnpacker.prototype.unpack_float = function () {\r\n  var uint32 = this.unpack_uint32();\r\n  var sign = uint32 >> 31;\r\n  var exp = ((uint32 >> 23) & 0xff) - 127;\r\n  var fraction = (uint32 & 0x7fffff) | 0x800000;\r\n  return (sign === 0 ? 1 : -1) *\r\n    fraction * Math.pow(2, exp - 23);\r\n};\r\n\r\nUnpacker.prototype.unpack_double = function () {\r\n  var h32 = this.unpack_uint32();\r\n  var l32 = this.unpack_uint32();\r\n  var sign = h32 >> 31;\r\n  var exp = ((h32 >> 20) & 0x7ff) - 1023;\r\n  var hfrac = (h32 & 0xfffff) | 0x100000;\r\n  var frac = hfrac * Math.pow(2, exp - 20) +\r\n    l32 * Math.pow(2, exp - 52);\r\n  return (sign === 0 ? 1 : -1) * frac;\r\n};\r\n\r\nUnpacker.prototype.read = function (length) {\r\n  var j = this.index;\r\n  if (j + length <= this.length) {\r\n    return this.dataView.subarray(j, j + length);\r\n  } else {\r\n    throw new Error('BinaryPackFailure: read index out of range');\r\n  }\r\n};\r\n\r\nfunction Packer () {\r\n  this.bufferBuilder = new BufferBuilder();\r\n}\r\n\r\nPacker.prototype.getBuffer = function () {\r\n  return this.bufferBuilder.getBuffer();\r\n};\r\n\r\nPacker.prototype.pack = function (value) {\r\n  var type = typeof (value);\r\n  if (type === 'string') {\r\n    this.pack_string(value);\r\n  } else if (type === 'number') {\r\n    if (Math.floor(value) === value) {\r\n      this.pack_integer(value);\r\n    } else {\r\n      this.pack_double(value);\r\n    }\r\n  } else if (type === 'boolean') {\r\n    if (value === true) {\r\n      this.bufferBuilder.append(0xc3);\r\n    } else if (value === false) {\r\n      this.bufferBuilder.append(0xc2);\r\n    }\r\n  } else if (type === 'undefined') {\r\n    this.bufferBuilder.append(0xc0);\r\n  } else if (type === 'object') {\r\n    if (value === null) {\r\n      this.bufferBuilder.append(0xc0);\r\n    } else {\r\n      var constructor = value.constructor;\r\n      if (constructor == Array) {\r\n        this.pack_array(value);\r\n      } else if (constructor == Blob || constructor == File || value instanceof Blob || value instanceof File) {\r\n        this.pack_bin(value);\r\n      } else if (constructor == ArrayBuffer) {\r\n        if (binaryFeatures.useArrayBufferView) {\r\n          this.pack_bin(new Uint8Array(value));\r\n        } else {\r\n          this.pack_bin(value);\r\n        }\r\n      } else if ('BYTES_PER_ELEMENT' in value) {\r\n        if (binaryFeatures.useArrayBufferView) {\r\n          this.pack_bin(new Uint8Array(value.buffer));\r\n        } else {\r\n          this.pack_bin(value.buffer);\r\n        }\r\n      } else if ((constructor == Object) || (constructor.toString().startsWith('class'))) {\r\n        this.pack_object(value);\r\n      } else if (constructor == Date) {\r\n        this.pack_string(value.toString());\r\n      } else if (typeof value.toBinaryPack === 'function') {\r\n        this.bufferBuilder.append(value.toBinaryPack());\r\n      } else {\r\n        throw new Error('Type \"' + constructor.toString() + '\" not yet supported');\r\n      }\r\n    }\r\n  } else {\r\n    throw new Error('Type \"' + type + '\" not yet supported');\r\n  }\r\n  this.bufferBuilder.flush();\r\n};\r\n\r\nPacker.prototype.pack_bin = function (blob) {\r\n  var length = blob.length || blob.byteLength || blob.size;\r\n  if (length <= 0x0f) {\r\n    this.pack_uint8(0xa0 + length);\r\n  } else if (length <= 0xffff) {\r\n    this.bufferBuilder.append(0xda);\r\n    this.pack_uint16(length);\r\n  } else if (length <= 0xffffffff) {\r\n    this.bufferBuilder.append(0xdb);\r\n    this.pack_uint32(length);\r\n  } else {\r\n    throw new Error('Invalid length');\r\n  }\r\n  this.bufferBuilder.append(blob);\r\n};\r\n\r\nPacker.prototype.pack_string = function (str) {\r\n  var length = utf8Length(str);\r\n\r\n  if (length <= 0x0f) {\r\n    this.pack_uint8(0xb0 + length);\r\n  } else if (length <= 0xffff) {\r\n    this.bufferBuilder.append(0xd8);\r\n    this.pack_uint16(length);\r\n  } else if (length <= 0xffffffff) {\r\n    this.bufferBuilder.append(0xd9);\r\n    this.pack_uint32(length);\r\n  } else {\r\n    throw new Error('Invalid length');\r\n  }\r\n  this.bufferBuilder.append(str);\r\n};\r\n\r\nPacker.prototype.pack_array = function (ary) {\r\n  var length = ary.length;\r\n  if (length <= 0x0f) {\r\n    this.pack_uint8(0x90 + length);\r\n  } else if (length <= 0xffff) {\r\n    this.bufferBuilder.append(0xdc);\r\n    this.pack_uint16(length);\r\n  } else if (length <= 0xffffffff) {\r\n    this.bufferBuilder.append(0xdd);\r\n    this.pack_uint32(length);\r\n  } else {\r\n    throw new Error('Invalid length');\r\n  }\r\n  for (var i = 0; i < length; i++) {\r\n    this.pack(ary[i]);\r\n  }\r\n};\r\n\r\nPacker.prototype.pack_integer = function (num) {\r\n  if (num >= -0x20 && num <= 0x7f) {\r\n    this.bufferBuilder.append(num & 0xff);\r\n  } else if (num >= 0x00 && num <= 0xff) {\r\n    this.bufferBuilder.append(0xcc);\r\n    this.pack_uint8(num);\r\n  } else if (num >= -0x80 && num <= 0x7f) {\r\n    this.bufferBuilder.append(0xd0);\r\n    this.pack_int8(num);\r\n  } else if (num >= 0x0000 && num <= 0xffff) {\r\n    this.bufferBuilder.append(0xcd);\r\n    this.pack_uint16(num);\r\n  } else if (num >= -0x8000 && num <= 0x7fff) {\r\n    this.bufferBuilder.append(0xd1);\r\n    this.pack_int16(num);\r\n  } else if (num >= 0x00000000 && num <= 0xffffffff) {\r\n    this.bufferBuilder.append(0xce);\r\n    this.pack_uint32(num);\r\n  } else if (num >= -0x80000000 && num <= 0x7fffffff) {\r\n    this.bufferBuilder.append(0xd2);\r\n    this.pack_int32(num);\r\n  } else if (num >= -0x8000000000000000 && num <= 0x7FFFFFFFFFFFFFFF) {\r\n    this.bufferBuilder.append(0xd3);\r\n    this.pack_int64(num);\r\n  } else if (num >= 0x0000000000000000 && num <= 0xFFFFFFFFFFFFFFFF) {\r\n    this.bufferBuilder.append(0xcf);\r\n    this.pack_uint64(num);\r\n  } else {\r\n    throw new Error('Invalid integer');\r\n  }\r\n};\r\n\r\nPacker.prototype.pack_double = function (num) {\r\n  var sign = 0;\r\n  if (num < 0) {\r\n    sign = 1;\r\n    num = -num;\r\n  }\r\n  var exp = Math.floor(Math.log(num) / Math.LN2);\r\n  var frac0 = num / Math.pow(2, exp) - 1;\r\n  var frac1 = Math.floor(frac0 * Math.pow(2, 52));\r\n  var b32 = Math.pow(2, 32);\r\n  var h32 = (sign << 31) | ((exp + 1023) << 20) |\r\n    (frac1 / b32) & 0x0fffff;\r\n  var l32 = frac1 % b32;\r\n  this.bufferBuilder.append(0xcb);\r\n  this.pack_int32(h32);\r\n  this.pack_int32(l32);\r\n};\r\n\r\nPacker.prototype.pack_object = function (obj) {\r\n  var keys = Object.keys(obj);\r\n  var length = keys.length;\r\n  if (length <= 0x0f) {\r\n    this.pack_uint8(0x80 + length);\r\n  } else if (length <= 0xffff) {\r\n    this.bufferBuilder.append(0xde);\r\n    this.pack_uint16(length);\r\n  } else if (length <= 0xffffffff) {\r\n    this.bufferBuilder.append(0xdf);\r\n    this.pack_uint32(length);\r\n  } else {\r\n    throw new Error('Invalid length');\r\n  }\r\n  for (var prop in obj) {\r\n    if (obj.hasOwnProperty(prop)) {\r\n      this.pack(prop);\r\n      this.pack(obj[prop]);\r\n    }\r\n  }\r\n};\r\n\r\nPacker.prototype.pack_uint8 = function (num) {\r\n  this.bufferBuilder.append(num);\r\n};\r\n\r\nPacker.prototype.pack_uint16 = function (num) {\r\n  this.bufferBuilder.append(num >> 8);\r\n  this.bufferBuilder.append(num & 0xff);\r\n};\r\n\r\nPacker.prototype.pack_uint32 = function (num) {\r\n  var n = num & 0xffffffff;\r\n  this.bufferBuilder.append((n & 0xff000000) >>> 24);\r\n  this.bufferBuilder.append((n & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((n & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((n & 0x000000ff));\r\n};\r\n\r\nPacker.prototype.pack_uint64 = function (num) {\r\n  var high = num / Math.pow(2, 32);\r\n  var low = num % Math.pow(2, 32);\r\n  this.bufferBuilder.append((high & 0xff000000) >>> 24);\r\n  this.bufferBuilder.append((high & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((high & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((high & 0x000000ff));\r\n  this.bufferBuilder.append((low & 0xff000000) >>> 24);\r\n  this.bufferBuilder.append((low & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((low & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((low & 0x000000ff));\r\n};\r\n\r\nPacker.prototype.pack_int8 = function (num) {\r\n  this.bufferBuilder.append(num & 0xff);\r\n};\r\n\r\nPacker.prototype.pack_int16 = function (num) {\r\n  this.bufferBuilder.append((num & 0xff00) >> 8);\r\n  this.bufferBuilder.append(num & 0xff);\r\n};\r\n\r\nPacker.prototype.pack_int32 = function (num) {\r\n  this.bufferBuilder.append((num >>> 24) & 0xff);\r\n  this.bufferBuilder.append((num & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((num & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((num & 0x000000ff));\r\n};\r\n\r\nPacker.prototype.pack_int64 = function (num) {\r\n  var high = Math.floor(num / Math.pow(2, 32));\r\n  var low = num % Math.pow(2, 32);\r\n  this.bufferBuilder.append((high & 0xff000000) >>> 24);\r\n  this.bufferBuilder.append((high & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((high & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((high & 0x000000ff));\r\n  this.bufferBuilder.append((low & 0xff000000) >>> 24);\r\n  this.bufferBuilder.append((low & 0x00ff0000) >>> 16);\r\n  this.bufferBuilder.append((low & 0x0000ff00) >>> 8);\r\n  this.bufferBuilder.append((low & 0x000000ff));\r\n};\r\n\r\nfunction _utf8Replace (m) {\r\n  var code = m.charCodeAt(0);\r\n\r\n  if (code <= 0x7ff) return '00';\r\n  if (code <= 0xffff) return '000';\r\n  if (code <= 0x1fffff) return '0000';\r\n  if (code <= 0x3ffffff) return '00000';\r\n  return '000000';\r\n}\r\n\r\nfunction utf8Length (str) {\r\n  if (str.length > 600) {\r\n    // Blob method faster for large strings\r\n    return (new Blob([str])).size;\r\n  } else {\r\n    return str.replace(/[^\\u0000-\\u007F]/g, _utf8Replace).length;\r\n  }\r\n}\r\n", "'use strict';\n\nvar has = Object.prototype.hasOwnProperty\n  , prefix = '~';\n\n/**\n * Constructor to create a storage for our `EE` objects.\n * An `Events` instance is a plain object whose properties are event names.\n *\n * @constructor\n * @private\n */\nfunction Events() {}\n\n//\n// We try to not inherit from `Object.prototype`. In some engines creating an\n// instance in this way is faster than calling `Object.create(null)` directly.\n// If `Object.create(null)` is not supported we prefix the event names with a\n// character to make sure that the built-in object properties are not\n// overridden or used as an attack vector.\n//\nif (Object.create) {\n  Events.prototype = Object.create(null);\n\n  //\n  // This hack is needed because the `__proto__` property is still inherited in\n  // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.\n  //\n  if (!new Events().__proto__) prefix = false;\n}\n\n/**\n * Representation of a single event listener.\n *\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} [once=false] Specify if the listener is a one-time listener.\n * @constructor\n * @private\n */\nfunction EE(fn, context, once) {\n  this.fn = fn;\n  this.context = context;\n  this.once = once || false;\n}\n\n/**\n * Add a listener for a given event.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} context The context to invoke the listener with.\n * @param {Boolean} once Specify if the listener is a one-time listener.\n * @returns {EventEmitter}\n * @private\n */\nfunction addListener(emitter, event, fn, context, once) {\n  if (typeof fn !== 'function') {\n    throw new TypeError('The listener must be a function');\n  }\n\n  var listener = new EE(fn, context || emitter, once)\n    , evt = prefix ? prefix + event : event;\n\n  if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;\n  else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);\n  else emitter._events[evt] = [emitter._events[evt], listener];\n\n  return emitter;\n}\n\n/**\n * Clear event by name.\n *\n * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.\n * @param {(String|Symbol)} evt The Event name.\n * @private\n */\nfunction clearEvent(emitter, evt) {\n  if (--emitter._eventsCount === 0) emitter._events = new Events();\n  else delete emitter._events[evt];\n}\n\n/**\n * Minimal `EventEmitter` interface that is molded against the Node.js\n * `EventEmitter` interface.\n *\n * @constructor\n * @public\n */\nfunction EventEmitter() {\n  this._events = new Events();\n  this._eventsCount = 0;\n}\n\n/**\n * Return an array listing the events for which the emitter has registered\n * listeners.\n *\n * @returns {Array}\n * @public\n */\nEventEmitter.prototype.eventNames = function eventNames() {\n  var names = []\n    , events\n    , name;\n\n  if (this._eventsCount === 0) return names;\n\n  for (name in (events = this._events)) {\n    if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);\n  }\n\n  if (Object.getOwnPropertySymbols) {\n    return names.concat(Object.getOwnPropertySymbols(events));\n  }\n\n  return names;\n};\n\n/**\n * Return the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Array} The registered listeners.\n * @public\n */\nEventEmitter.prototype.listeners = function listeners(event) {\n  var evt = prefix ? prefix + event : event\n    , handlers = this._events[evt];\n\n  if (!handlers) return [];\n  if (handlers.fn) return [handlers.fn];\n\n  for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {\n    ee[i] = handlers[i].fn;\n  }\n\n  return ee;\n};\n\n/**\n * Return the number of listeners listening to a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Number} The number of listeners.\n * @public\n */\nEventEmitter.prototype.listenerCount = function listenerCount(event) {\n  var evt = prefix ? prefix + event : event\n    , listeners = this._events[evt];\n\n  if (!listeners) return 0;\n  if (listeners.fn) return 1;\n  return listeners.length;\n};\n\n/**\n * Calls each of the listeners registered for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @returns {Boolean} `true` if the event had listeners, else `false`.\n * @public\n */\nEventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return false;\n\n  var listeners = this._events[evt]\n    , len = arguments.length\n    , args\n    , i;\n\n  if (listeners.fn) {\n    if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);\n\n    switch (len) {\n      case 1: return listeners.fn.call(listeners.context), true;\n      case 2: return listeners.fn.call(listeners.context, a1), true;\n      case 3: return listeners.fn.call(listeners.context, a1, a2), true;\n      case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;\n      case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;\n      case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;\n    }\n\n    for (i = 1, args = new Array(len -1); i < len; i++) {\n      args[i - 1] = arguments[i];\n    }\n\n    listeners.fn.apply(listeners.context, args);\n  } else {\n    var length = listeners.length\n      , j;\n\n    for (i = 0; i < length; i++) {\n      if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);\n\n      switch (len) {\n        case 1: listeners[i].fn.call(listeners[i].context); break;\n        case 2: listeners[i].fn.call(listeners[i].context, a1); break;\n        case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;\n        case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;\n        default:\n          if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {\n            args[j - 1] = arguments[j];\n          }\n\n          listeners[i].fn.apply(listeners[i].context, args);\n      }\n    }\n  }\n\n  return true;\n};\n\n/**\n * Add a listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.on = function on(event, fn, context) {\n  return addListener(this, event, fn, context, false);\n};\n\n/**\n * Add a one-time listener for a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn The listener function.\n * @param {*} [context=this] The context to invoke the listener with.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.once = function once(event, fn, context) {\n  return addListener(this, event, fn, context, true);\n};\n\n/**\n * Remove the listeners of a given event.\n *\n * @param {(String|Symbol)} event The event name.\n * @param {Function} fn Only remove the listeners that match this function.\n * @param {*} context Only remove the listeners that have this context.\n * @param {Boolean} once Only remove one-time listeners.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {\n  var evt = prefix ? prefix + event : event;\n\n  if (!this._events[evt]) return this;\n  if (!fn) {\n    clearEvent(this, evt);\n    return this;\n  }\n\n  var listeners = this._events[evt];\n\n  if (listeners.fn) {\n    if (\n      listeners.fn === fn &&\n      (!once || listeners.once) &&\n      (!context || listeners.context === context)\n    ) {\n      clearEvent(this, evt);\n    }\n  } else {\n    for (var i = 0, events = [], length = listeners.length; i < length; i++) {\n      if (\n        listeners[i].fn !== fn ||\n        (once && !listeners[i].once) ||\n        (context && listeners[i].context !== context)\n      ) {\n        events.push(listeners[i]);\n      }\n    }\n\n    //\n    // Reset the array, or remove it completely if we have no more listeners.\n    //\n    if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;\n    else clearEvent(this, evt);\n  }\n\n  return this;\n};\n\n/**\n * Remove all listeners, or those of the specified event.\n *\n * @param {(String|Symbol)} [event] The event name.\n * @returns {EventEmitter} `this`.\n * @public\n */\nEventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {\n  var evt;\n\n  if (event) {\n    evt = prefix ? prefix + event : event;\n    if (this._events[evt]) clearEvent(this, evt);\n  } else {\n    this._events = new Events();\n    this._eventsCount = 0;\n  }\n\n  return this;\n};\n\n//\n// Alias methods names because people roll like that.\n//\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\nEventEmitter.prototype.addListener = EventEmitter.prototype.on;\n\n//\n// Expose the prefix.\n//\nEventEmitter.prefixed = prefix;\n\n//\n// Allow `EventEmitter` to be imported as module namespace.\n//\nEventEmitter.EventEmitter = EventEmitter;\n\n//\n// Expose the module.\n//\nif ('undefined' !== typeof module) {\n  module.exports = EventEmitter;\n}\n", "import * as BinaryPack from \"peerjs-js-binarypack\";\n\nconst DEFAULT_CONFIG = {\n\ticeServers: [\n\t\t{ urls: \"stun:stun.l.google.com:19302\" },\n\t\t{\n\t\t\turls: \"turn:0.peerjs.com:3478\",\n\t\t\tusername: \"peerjs\",\n\t\t\tcredential: \"peerjsp\",\n\t\t},\n\t],\n\tsdpSemantics: \"unified-plan\",\n};\n\nexport const Utils = new (class {\n\treadonly CLOUD_HOST = \"0.peerjs.com\";\n\treadonly CLOUD_PORT = 443;\n\n\treadonly chunkedMTU = 16300; // The original 60000 bytes setting does not work when sending data from Firefox to Chrome, which is \"cut off\" after 16384 bytes and delivered individually.\n\n\t// Returns browser-agnostic default config\n\treadonly defaultConfig = DEFAULT_CONFIG;\n\n\t// Ensure alphanumeric ids\n\tvalidateId(id: string): boolean {\n\t\t// Allow empty ids\n\t\treturn !id || /^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.test(id);\n\t}\n\n\tpack = BinaryPack.pack;\n\tunpack = BinaryPack.unpack;\n\n\t// Binary stuff\n\n\tprivate _dataCount: number = 1;\n\n\tchunk(\n\t\tblob: Blob,\n\t): { __peerData: number; n: number; total: number; data: Blob }[] {\n\t\tconst chunks = [];\n\t\tconst size = blob.size;\n\t\tconst total = Math.ceil(size / Utils.chunkedMTU);\n\n\t\tlet index = 0;\n\t\tlet start = 0;\n\n\t\twhile (start < size) {\n\t\t\tconst end = Math.min(size, start + Utils.chunkedMTU);\n\t\t\tconst b = blob.slice(start, end);\n\n\t\t\tconst chunk = {\n\t\t\t\t__peerData: this._dataCount,\n\t\t\t\tn: index,\n\t\t\t\tdata: b,\n\t\t\t\ttotal,\n\t\t\t};\n\n\t\t\tchunks.push(chunk);\n\n\t\t\tstart = end;\n\t\t\tindex++;\n\t\t}\n\n\t\tthis._dataCount++;\n\n\t\treturn chunks;\n\t}\n\n\tblobToArrayBuffer(\n\t\tFileReaderCtr: typeof FileReader,\n\t\tblob: Blob,\n\t\tcb: (arg: ArrayBuffer | null) => void,\n\t): FileReader {\n\t\tconst fr = new FileReaderCtr();\n\n\t\tfr.onload = function (evt) {\n\t\t\tif (evt.target) {\n\t\t\t\tcb(evt.target.result as ArrayBuffer);\n\t\t\t}\n\t\t};\n\n\t\tfr.readAsArrayBuffer(blob);\n\n\t\treturn fr;\n\t}\n\n\tbinaryStringToArrayBuffer(binary: string): ArrayBuffer | SharedArrayBuffer {\n\t\tconst byteArray = new Uint8Array(binary.length);\n\n\t\tfor (let i = 0; i < binary.length; i++) {\n\t\t\tbyteArray[i] = binary.charCodeAt(i) & 0xff;\n\t\t}\n\n\t\treturn byteArray.buffer;\n\t}\n\n\trandomToken(): string {\n\t\treturn Math.random().toString(36).substr(2);\n\t}\n\n\tisSecure(): boolean {\n\t\treturn location.protocol === \"https:\";\n\t}\n})();\n", "import { EventEmitter } from \"eventemitter3\";\nimport { Utils } from \"./utils\";\nimport logger, { LogLevel } from \"./logger\";\nimport { Socket } from \"./socket\";\nimport { MediaConnection } from \"./mediaconnection\";\nimport { DataConnection } from \"./dataconnection\";\nimport {\n\tConnectionType,\n\tPeerErrorType,\n\tPeerEventType,\n\tSocketEventType,\n\tServerMessageType,\n} from \"./enums\";\nimport { BaseConnection } from \"./baseconnection\";\nimport { ServerMessage } from \"./servermessage\";\nimport { API } from \"./api\";\nimport type { PeerConnectOption, PeerJSOption, Features } from \"..\";\nimport { Supports } from \"./supports\";\n\ninterface PeerOptions extends PeerJSOption {\n\tdebug?: LogLevel; // 1: Errors, 2: Warnings, 3: All logs\n\tlogFunction?: (logLevel: LogLevel, ...rest: any[]) => void;\n}\n\n/**\n * A peer who can initiate connections with other peers.\n */\nexport class Peer extends EventEmitter {\n\tprivate static readonly DEFAULT_KEY = \"peerjs\";\n\n\tprivate readonly _options: PeerOptions;\n\tprivate readonly _api: API;\n\tprivate readonly _socket: Socket;\n\n\tprivate _id: string | null = null;\n\tprivate _lastServerId: string | null = null;\n\n\t// States.\n\tprivate _destroyed = false; // Connections have been killed\n\tprivate _disconnected = false; // Connection to PeerServer killed but P2P connections still active\n\tprivate _open = false; // Sockets and such are not yet open.\n\tprivate readonly _connections: Map<string, BaseConnection[]> = new Map(); // All connections for this peer.\n\tprivate readonly _lostMessages: Map<string, ServerMessage[]> = new Map(); // src => [list of messages]\n\n\tget id() {\n\t\treturn this._id;\n\t}\n\n\tget options() {\n\t\treturn this._options;\n\t}\n\n\tget open() {\n\t\treturn this._open;\n\t}\n\n\tget socket() {\n\t\treturn this._socket;\n\t}\n\n\t/**\n\t * @deprecated\n\t * Return type will change from Object to Map<string,[]>\n\t */\n\tget connections(): Object {\n\t\tconst plainConnections = Object.create(null);\n\n\t\tfor (let [k, v] of this._connections) {\n\t\t\tplainConnections[k] = v;\n\t\t}\n\n\t\treturn plainConnections;\n\t}\n\n\tget destroyed() {\n\t\treturn this._destroyed;\n\t}\n\tget disconnected() {\n\t\treturn this._disconnected;\n\t}\n\n\treadonly features: Features;\n\n\tconstructor(id?: string | PeerOptions, options?: PeerOptions) {\n\t\tsuper();\n\n\t\tlet userId: string | undefined;\n\n\t\t// Deal with overloading\n\t\tif (id && id.constructor == Object) {\n\t\t\toptions = id as PeerOptions;\n\t\t} else if (id) {\n\t\t\tuserId = id.toString();\n\t\t}\n\n\t\t// Configure options\n\t\toptions = {\n\t\t\tdebug: 0, // 1: Errors, 2: Warnings, 3: All logs\n\t\t\thost: Utils.CLOUD_HOST,\n\t\t\tport: Utils.CLOUD_PORT,\n\t\t\tpath: \"/\",\n\t\t\tkey: Peer.DEFAULT_KEY,\n\t\t\ttoken: Utils.randomToken(),\n\t\t\tconfig: Utils.defaultConfig,\n\t\t\t...options,\n\t\t};\n\t\tthis._options = options;\n\n\t\t// Detect relative URL host.\n\t\tif (typeof window !== \"undefined\" && this._options.host === \"/\") {\n\t\t\tthis._options.host = window.location.hostname;\n\t\t}\n\n\t\t// Set path correctly.\n\t\tif (this._options.path) {\n\t\t\tif (this._options.path[0] !== \"/\") {\n\t\t\t\tthis._options.path = \"/\" + this._options.path;\n\t\t\t}\n\t\t\tif (this._options.path[this._options.path.length - 1] !== \"/\") {\n\t\t\t\tthis._options.path += \"/\";\n\t\t\t}\n\t\t}\n\n\t\t// Set whether we use SSL to same as current host\n\t\tif (\n\t\t\tthis._options.secure === undefined &&\n\t\t\tthis._options.host !== Utils.CLOUD_HOST\n\t\t) {\n\t\t\tthis._options.secure = Utils.isSecure();\n\t\t} else if (this._options.host == Utils.CLOUD_HOST) {\n\t\t\tthis._options.secure = true;\n\t\t}\n\t\t// Set a custom log function if present\n\t\tif (this._options.logFunction) {\n\t\t\tlogger.setLogFunction(this._options.logFunction);\n\t\t}\n\n\t\tlogger.logLevel = this._options.debug || 0;\n\n\t\tthis._api = new API(options);\n\t\tthis._socket = this._createServerConnection();\n\n\t\tthis.features = Peer.getFeatures(this._options.polyfills?.WebRTC);\n\n\t\t// Sanity checks\n\t\t// Ensure WebRTC supported\n\t\tif (!this.features.audioVideo && !this.features.data) {\n\t\t\tthis._delayedAbort(\n\t\t\t\tPeerErrorType.BrowserIncompatible,\n\t\t\t\t\"The current browser does not support WebRTC\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\t// Ensure alphanumeric id\n\t\tif (!!userId && !Utils.validateId(userId)) {\n\t\t\tthis._delayedAbort(PeerErrorType.InvalidID, `ID \"${userId}\" is invalid`);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.socket.alive = true;\n\n\t\tif (userId) {\n\t\t\tthis._initialize(userId);\n\t\t} else {\n\t\t\tthis._api\n\t\t\t\t.retrieveId()\n\t\t\t\t.then((id) => this._initialize(id))\n\t\t\t\t.catch((error) => this._abort(PeerErrorType.ServerError, error));\n\t\t}\n\t}\n\n\tprivate _createServerConnection(): Socket {\n\t\tconst socket = new Socket(this._options);\n\n\t\tsocket.on(SocketEventType.Message, (data: ServerMessage) => {\n\t\t\tthis._handleMessage(data);\n\t\t});\n\n\t\tsocket.on(SocketEventType.Error, (error: string) => {\n\t\t\tthis._abort(PeerErrorType.SocketError, error);\n\t\t});\n\n\t\tsocket.on(SocketEventType.Disconnected, () => {\n\t\t\tif (this.disconnected) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.emitError(PeerErrorType.Network, \"Lost connection to server.\");\n\t\t\tthis.disconnect();\n\t\t});\n\n\t\tsocket.on(SocketEventType.Close, () => {\n\t\t\tif (this.disconnected) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._abort(\n\t\t\t\tPeerErrorType.SocketClosed,\n\t\t\t\t\"Underlying socket is already closed.\",\n\t\t\t);\n\t\t});\n\n\t\treturn socket;\n\t}\n\n\t/** Initialize a connection with the server. */\n\tprivate _initialize(id: string): void {\n\t\tif (this.destroyed) return;\n\n\t\tthis._id = id;\n\t\tthis.socket.start(id, this._options.token!);\n\t}\n\n\t/** Handles messages from the server. */\n\tprivate _handleMessage(message: ServerMessage): void {\n\t\tconst type = message.type;\n\t\tconst payload = message.payload;\n\t\tconst peerId = message.src;\n\n\t\tswitch (type) {\n\t\t\tcase ServerMessageType.Open: // The connection to the server is open.\n\t\t\t\tthis._lastServerId = this.id;\n\t\t\t\tthis._open = true;\n\t\t\t\tthis.emit(PeerEventType.Open, this.id);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Error: // Server error.\n\t\t\t\tthis._abort(PeerErrorType.ServerError, payload.msg);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.IdTaken: // The selected ID is taken.\n\t\t\t\tthis._abort(PeerErrorType.UnavailableID, `ID \"${this.id}\" is taken`);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.InvalidKey: // The given API key cannot be found.\n\t\t\t\tthis._abort(\n\t\t\t\t\tPeerErrorType.InvalidKey,\n\t\t\t\t\t`API KEY \"${this._options.key}\" is invalid`,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Leave: // Another peer has closed its connection to this peer.\n\t\t\t\tlogger.log(`Received leave message from ${peerId}`);\n\t\t\t\tthis._cleanupPeer(peerId);\n\t\t\t\tthis._connections.delete(peerId);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Expire: // The offer sent to a peer has expired without response.\n\t\t\t\tthis.emitError(\n\t\t\t\t\tPeerErrorType.PeerUnavailable,\n\t\t\t\t\t`Could not connect to peer ${peerId}`,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Offer: {\n\t\t\t\t// we should consider switching this to CALL/CONNECT, but this is the least breaking option.\n\t\t\t\tconst connectionId = payload.connectionId;\n\t\t\t\tlet connection = this.getConnection(peerId, connectionId);\n\n\t\t\t\tif (connection) {\n\t\t\t\t\tconnection.close();\n\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t`Offer received for existing Connection ID:${connectionId}`,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// Create a new connection.\n\t\t\t\tif (payload.type === ConnectionType.Media) {\n\t\t\t\t\tconnection = new MediaConnection(peerId, this, {\n\t\t\t\t\t\tconnectionId: connectionId,\n\t\t\t\t\t\t_payload: payload,\n\t\t\t\t\t\tmetadata: payload.metadata,\n\t\t\t\t\t});\n\t\t\t\t\tthis._addConnection(peerId, connection);\n\t\t\t\t\tthis.emit(PeerEventType.Call, connection);\n\t\t\t\t} else if (payload.type === ConnectionType.Data) {\n\t\t\t\t\tconnection = new DataConnection(peerId, this, {\n\t\t\t\t\t\tconnectionId: connectionId,\n\t\t\t\t\t\t_payload: payload,\n\t\t\t\t\t\tmetadata: payload.metadata,\n\t\t\t\t\t\tlabel: payload.label,\n\t\t\t\t\t\tserialization: payload.serialization,\n\t\t\t\t\t\treliable: payload.reliable,\n\t\t\t\t\t});\n\t\t\t\t\tthis._addConnection(peerId, connection);\n\t\t\t\t\tthis.emit(PeerEventType.Connection, connection);\n\t\t\t\t} else {\n\t\t\t\t\tlogger.warn(`Received malformed connection type:${payload.type}`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Find messages.\n\t\t\t\tconst messages = this._getMessages(connectionId);\n\t\t\t\tfor (let message of messages) {\n\t\t\t\t\tconnection.handleMessage(message);\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tif (!payload) {\n\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t`You received a malformed message from ${peerId} of type ${type}`,\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst connectionId = payload.connectionId;\n\t\t\t\tconst connection = this.getConnection(peerId, connectionId);\n\n\t\t\t\tif (connection && connection.peerConnection) {\n\t\t\t\t\t// Pass it on.\n\t\t\t\t\tconnection.handleMessage(message);\n\t\t\t\t} else if (connectionId) {\n\t\t\t\t\t// Store for possible later use\n\t\t\t\t\tthis._storeMessage(connectionId, message);\n\t\t\t\t} else {\n\t\t\t\t\tlogger.warn(\"You received an unrecognized message:\", message);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Stores messages without a set up connection, to be claimed later. */\n\tprivate _storeMessage(connectionId: string, message: ServerMessage): void {\n\t\tif (!this._lostMessages.has(connectionId)) {\n\t\t\tthis._lostMessages.set(connectionId, []);\n\t\t}\n\n\t\tthis._lostMessages.get(connectionId).push(message);\n\t}\n\n\t/** Retrieve messages from lost message store */\n\t//TODO Change it to private\n\tpublic _getMessages(connectionId: string): ServerMessage[] {\n\t\tconst messages = this._lostMessages.get(connectionId);\n\n\t\tif (messages) {\n\t\t\tthis._lostMessages.delete(connectionId);\n\t\t\treturn messages;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t/**\n\t * Returns a DataConnection to the specified peer. See documentation for a\n\t * complete list of options.\n\t */\n\tconnect(peer: string, options: PeerConnectOption = {}): DataConnection {\n\t\tif (this.disconnected) {\n\t\t\tlogger.warn(\n\t\t\t\t\"You cannot connect to a new Peer because you called \" +\n\t\t\t\t\t\".disconnect() on this Peer and ended your connection with the \" +\n\t\t\t\t\t\"server. You can create a new Peer to reconnect, or call reconnect \" +\n\t\t\t\t\t\"on this peer if you believe its ID to still be available.\",\n\t\t\t);\n\t\t\tthis.emitError(\n\t\t\t\tPeerErrorType.Disconnected,\n\t\t\t\t\"Cannot connect to new Peer after disconnecting from server.\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tconst dataConnection = new DataConnection(peer, this, options);\n\t\tthis._addConnection(peer, dataConnection);\n\t\treturn dataConnection;\n\t}\n\n\t/**\n\t * Returns a MediaConnection to the specified peer. See documentation for a\n\t * complete list of options.\n\t */\n\tcall(peer: string, stream: MediaStream, options: any = {}): MediaConnection {\n\t\tif (this.disconnected) {\n\t\t\tlogger.warn(\n\t\t\t\t\"You cannot connect to a new Peer because you called \" +\n\t\t\t\t\t\".disconnect() on this Peer and ended your connection with the \" +\n\t\t\t\t\t\"server. You can create a new Peer to reconnect.\",\n\t\t\t);\n\t\t\tthis.emitError(\n\t\t\t\tPeerErrorType.Disconnected,\n\t\t\t\t\"Cannot connect to new Peer after disconnecting from server.\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!stream) {\n\t\t\tlogger.error(\n\t\t\t\t\"To call a peer, you must provide a stream from your browser's `getUserMedia`.\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\toptions._stream = stream;\n\n\t\tconst mediaConnection = new MediaConnection(peer, this, options);\n\t\tthis._addConnection(peer, mediaConnection);\n\t\treturn mediaConnection;\n\t}\n\n\t/** Add a data/media connection to this peer. */\n\tprivate _addConnection(peerId: string, connection: BaseConnection): void {\n\t\tlogger.log(\n\t\t\t`add connection ${connection.type}:${connection.connectionId} to peerId:${peerId}`,\n\t\t);\n\n\t\tif (!this._connections.has(peerId)) {\n\t\t\tthis._connections.set(peerId, []);\n\t\t}\n\t\tthis._connections.get(peerId).push(connection);\n\t}\n\n\t//TODO should be private\n\t_removeConnection(connection: BaseConnection): void {\n\t\tconst connections = this._connections.get(connection.peer);\n\n\t\tif (connections) {\n\t\t\tconst index = connections.indexOf(connection);\n\n\t\t\tif (index !== -1) {\n\t\t\t\tconnections.splice(index, 1);\n\n\t\t\t\tif (connections.length === 0) {\n\t\t\t\t\tthis._connections.delete(connection.peer);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t//remove from lost messages\n\t\tthis._lostMessages.delete(connection.connectionId);\n\t}\n\n\t/** Retrieve a data/media connection for this peer. */\n\tgetConnection(peerId: string, connectionId: string): null | BaseConnection {\n\t\tconst connections = this._connections.get(peerId);\n\t\tif (!connections) {\n\t\t\treturn null;\n\t\t}\n\n\t\tfor (let connection of connections) {\n\t\t\tif (connection.connectionId === connectionId) {\n\t\t\t\treturn connection;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _delayedAbort(type: PeerErrorType, message: string | Error): void {\n\t\tsetTimeout(() => {\n\t\t\tthis._abort(type, message);\n\t\t}, 0);\n\t}\n\n\t/**\n\t * Emits an error message and destroys the Peer.\n\t * The Peer is not destroyed if it's in a disconnected state, in which case\n\t * it retains its disconnected state and its existing connections.\n\t */\n\tprivate _abort(type: PeerErrorType, message: string | Error): void {\n\t\tlogger.error(\"Aborting!\");\n\n\t\tthis.emitError(type, message);\n\n\t\tif (!this._lastServerId) {\n\t\t\tthis.destroy();\n\t\t} else {\n\t\t\tthis.disconnect();\n\t\t}\n\t}\n\n\t/** Emits a typed error message. */\n\temitError(type: PeerErrorType, err: string | Error): void {\n\t\tlogger.error(\"Error:\", err);\n\n\t\tlet error: Error & { type?: PeerErrorType };\n\n\t\tif (typeof err === \"string\") {\n\t\t\terror = new Error(err);\n\t\t} else {\n\t\t\terror = err as Error;\n\t\t}\n\n\t\terror.type = type;\n\n\t\tthis.emit(PeerEventType.Error, error);\n\t}\n\n\t/**\n\t * Destroys the Peer: closes all active connections as well as the connection\n\t *  to the server.\n\t * Warning: The peer can no longer create or accept connections after being\n\t *  destroyed.\n\t */\n\tdestroy(): void {\n\t\tif (this.destroyed) {\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.log(`Destroy peer with ID:${this.id}`);\n\n\t\tthis.disconnect();\n\t\tthis._cleanup();\n\n\t\tthis.socket.destroy();\n\n\t\tthis._destroyed = true;\n\n\t\tthis.emit(PeerEventType.Close);\n\t}\n\n\t/** Disconnects every connection on this peer. */\n\tprivate _cleanup(): void {\n\t\tfor (let peerId of this._connections.keys()) {\n\t\t\tthis._cleanupPeer(peerId);\n\t\t\tthis._connections.delete(peerId);\n\t\t}\n\n\t\tthis.socket.removeAllListeners();\n\t}\n\n\t/** Closes all connections to this peer. */\n\tprivate _cleanupPeer(peerId: string): void {\n\t\tconst connections = this._connections.get(peerId);\n\n\t\tif (!connections) return;\n\n\t\tfor (let connection of connections) {\n\t\t\tconnection.close();\n\t\t}\n\t}\n\n\t/**\n\t * Disconnects the Peer's connection to the PeerServer. Does not close any\n\t *  active connections.\n\t * Warning: The peer can no longer create or accept connections after being\n\t *  disconnected. It also cannot reconnect to the server.\n\t */\n\tdisconnect(): void {\n\t\tif (this.disconnected) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentId = this.id;\n\n\t\tlogger.log(`Disconnect peer with ID:${currentId}`);\n\n\t\tthis._disconnected = true;\n\t\tthis._open = false;\n\n\t\tthis.socket.alive = false;\n\t\tthis.socket.close();\n\n\t\tthis._lastServerId = currentId;\n\t\tthis._id = null;\n\n\t\tthis.emit(PeerEventType.Disconnected, currentId);\n\t}\n\n\t/** Attempts to reconnect with the same ID. */\n\treconnect(): void {\n\t\tif (this.disconnected && !this.destroyed) {\n\t\t\tlogger.log(\n\t\t\t\t`Attempting reconnection to server with ID ${this._lastServerId}`,\n\t\t\t);\n\t\t\tthis._disconnected = false;\n\t\t\tthis.socket.alive = true;\n\t\t\tthis._initialize(this._lastServerId!);\n\t\t} else if (this.destroyed) {\n\t\t\tthrow new Error(\n\t\t\t\t\"This peer cannot reconnect to the server. It has already been destroyed.\",\n\t\t\t);\n\t\t} else if (!this.disconnected && !this.open) {\n\t\t\t// Do nothing. We're still connecting the first time.\n\t\t\tlogger.error(\n\t\t\t\t\"In a hurry? We're still trying to make the initial connection!\",\n\t\t\t);\n\t\t} else {\n\t\t\tthrow new Error(\n\t\t\t\t`Peer ${this.id} cannot reconnect because it is not disconnected from the server!`,\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Get a list of available peer IDs. If you're running your own server, you'll\n\t * want to set allow_discovery: true in the PeerServer options. If you're using\n\t * the cloud server, email team@peerjs.com to get the functionality enabled for\n\t * your key.\n\t */\n\tlistAllPeers(cb = (_: any[]) => {}): void {\n\t\tthis._api\n\t\t\t.listAllPeers()\n\t\t\t.then((peers) => cb(peers))\n\t\t\t.catch((error) => this._abort(PeerErrorType.ServerError, error));\n\t}\n\n\tstatic getFeatures(webRtc: any): Features {\n\t\tif (!webRtc && typeof window !== \"undefined\") {\n\t\t\twebRtc = window;\n\t\t}\n\n\t\tif (!Peer._features) {\n\t\t\tPeer._features = Peer.checkFeatures(webRtc);\n\t\t}\n\n\t\treturn Peer._features;\n\t}\n\n\tprivate static _features?: Features;\n\n\t// Lists which features are supported\n\tprivate static checkFeatures(webRtc: any): Features {\n\t\tif (!webRtc && typeof window !== \"undefined\") {\n\t\t\twebRtc = window;\n\t\t}\n\n\t\tconst supported: Features = {\n\t\t\twebRTC: typeof webRtc.RTCPeerConnection !== \"undefined\",\n\t\t\taudioVideo: true,\n\t\t\tdata: false,\n\t\t\tbinaryBlob: false,\n\t\t\treliable: false,\n\t\t\tunifiedPlan: false,\n\t\t};\n\n\t\tif (!supported.webRTC) return supported;\n\n\t\tlet pc: RTCPeerConnection;\n\n\t\ttry {\n\t\t\tpc = new webRtc.RTCPeerConnection(Utils.defaultConfig);\n\t\t\tlet dc: RTCDataChannel;\n\n\t\t\ttry {\n\t\t\t\tdc = pc.createDataChannel(\"_PEERJSTEST\", { ordered: true });\n\t\t\t\tsupported.data = true;\n\t\t\t\tsupported.reliable = !!dc.ordered;\n\n\t\t\t\t// Binary test\n\t\t\t\ttry {\n\t\t\t\t\tdc.binaryType = \"blob\";\n\t\t\t\t\tsupported.binaryBlob = true; //not works for iOS?\n\t\t\t\t} catch (e) {}\n\t\t\t} catch (e) {\n\t\t\t} finally {\n\t\t\t\tif (dc) {\n\t\t\t\t\tdc.close();\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t} finally {\n\t\t\tif (pc) {\n\t\t\t\tpc.close();\n\t\t\t}\n\t\t}\n\n\t\tsupported.unifiedPlan = Supports.isUnifiedPlanSupported(webRtc);\n\n\t\treturn supported;\n\t}\n}\n", "const LOG_PREFIX = \"PeerJS: \";\n\n/*\nPrints log messages depending on the debug level passed in. Defaults to 0.\n0  Prints no logs.\n1  Prints only errors.\n2  Prints errors and warnings.\n3  Prints all logs.\n*/\nexport enum LogLevel {\n\tDisabled,\n\tErrors,\n\tWarnings,\n\tAll,\n}\n\nclass Logger {\n\tprivate _logLevel = LogLevel.Disabled;\n\n\tget logLevel(): LogLevel {\n\t\treturn this._logLevel;\n\t}\n\n\tset logLevel(logLevel: LogLevel) {\n\t\tthis._logLevel = logLevel;\n\t}\n\n\tlog(...args: any[]) {\n\t\tif (this._logLevel >= LogLevel.All) {\n\t\t\tthis._print(LogLevel.All, ...args);\n\t\t}\n\t}\n\n\twarn(...args: any[]) {\n\t\tif (this._logLevel >= LogLevel.Warnings) {\n\t\t\tthis._print(LogLevel.Warnings, ...args);\n\t\t}\n\t}\n\n\terror(...args: any[]) {\n\t\tif (this._logLevel >= LogLevel.Errors) {\n\t\t\tthis._print(LogLevel.Errors, ...args);\n\t\t}\n\t}\n\n\tsetLogFunction(fn: (logLevel: LogLevel, ..._: any[]) => void): void {\n\t\tthis._print = fn;\n\t}\n\n\tprivate _print(logLevel: LogLevel, ...rest: any[]): void {\n\t\tconst copy = [LOG_PREFIX, ...rest];\n\n\t\tfor (let i in copy) {\n\t\t\tif (copy[i] instanceof Error) {\n\t\t\t\tcopy[i] = \"(\" + copy[i].name + \") \" + copy[i].message;\n\t\t\t}\n\t\t}\n\n\t\tif (logLevel >= LogLevel.All) {\n\t\t\tconsole.log(...copy);\n\t\t} else if (logLevel >= LogLevel.Warnings) {\n\t\t\tconsole.warn(\"WARNING\", ...copy);\n\t\t} else if (logLevel >= LogLevel.Errors) {\n\t\t\tconsole.error(\"ERROR\", ...copy);\n\t\t}\n\t}\n}\n\nexport default new Logger();\n", "import { EventEmitter } from \"eventemitter3\";\nimport logger from \"./logger\";\nimport {\n\tSocketEventType,\n\tServerMessageType,\n\ttype ConnectionType,\n} from \"./enums\";\nimport type { PeerJSOption } from \"../index\";\n\ntype MessageData = {\n\ttype: ServerMessageType;\n\tdst: string;\n\tpayload: {\n\t\ttype: ConnectionType;\n\t\tconnectionId: string;\n\t} & Record<string, any>;\n};\n/**\n * An abstraction on top of WebSockets to provide the fastest\n * possible connection for peers.\n */\nexport class Socket extends EventEmitter {\n\tprivate _disconnected: boolean = true;\n\tprivate _id: string | null = null;\n\tprivate _messagesQueue: Array<MessageData> = [];\n\tprivate _socket?: WebSocket;\n\tprivate _wsPingTimer?: any;\n\tprivate readonly _baseUrl: string;\n\n\tprivate readonly pingInterval: number;\n\tprivate readonly WebSocketConstructor: typeof WebSocket;\n\n\talive: boolean = false;\n\n\tprivate _destroyed = false;\n\n\tget messagesQueue(): ReadonlyArray<MessageData> {\n\t\treturn this._messagesQueue;\n\t}\n\n\tget destroyed() {\n\t\treturn this._destroyed;\n\t}\n\n\tconstructor({\n\t\tsecure,\n\t\thost,\n\t\tport,\n\t\tpath,\n\t\tkey,\n\t\tpingInterval = 5000,\n\t\tpolyfills,\n\t}: PeerJSOption) {\n\t\tsuper();\n\n\t\tthis.pingInterval = pingInterval;\n\n\t\tconst wsProtocol = secure ? \"wss://\" : \"ws://\";\n\n\t\tthis._baseUrl = wsProtocol + host + \":\" + port + path + \"peerjs?key=\" + key;\n\t\tthis.WebSocketConstructor = polyfills?.WebSocket ?? window.WebSocket;\n\t}\n\n\tstart(id: string, token: string): void {\n\t\tif (this._destroyed) throw new Error(\"Socket was destroyed!\");\n\n\t\tthis._id = id;\n\n\t\tif (!!this._socket || !this._disconnected) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst wsUrl = `${this._baseUrl}&id=${id}&token=${token}`;\n\n\t\tthis._socket = new this.WebSocketConstructor(wsUrl);\n\t\tthis._disconnected = false;\n\n\t\tthis._socket.onmessage = (event) => {\n\t\t\tif (this._destroyed) return;\n\n\t\t\tlet data;\n\n\t\t\ttry {\n\t\t\t\tdata = JSON.parse(event.data);\n\t\t\t\tlogger.log(\"Server message received:\", data);\n\t\t\t} catch (e) {\n\t\t\t\tlogger.log(\"Invalid server message\", event.data);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.emit(SocketEventType.Message, data);\n\t\t};\n\n\t\tthis._socket.onclose = (event) => {\n\t\t\tif (this._disconnected || this._destroyed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlogger.log(\"Socket closed.\", event);\n\n\t\t\tthis._cleanup();\n\t\t\tthis._disconnected = true;\n\n\t\t\tthis.emit(SocketEventType.Disconnected);\n\t\t};\n\n\t\t// Take care of the queue of connections if necessary and make sure Peer knows\n\t\t// socket is open.\n\t\tthis._socket.onopen = () => {\n\t\t\tif (this._disconnected || this._destroyed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlogger.log(\"Socket open\");\n\n\t\t\tthis.emit(SocketEventType.Open);\n\n\t\t\tthis._sendQueuedMessages();\n\n\t\t\tthis._scheduleHeartbeat();\n\t\t};\n\t}\n\n\tprivate _scheduleHeartbeat(): void {\n\t\tthis._wsPingTimer = setTimeout(() => {\n\t\t\tthis._sendHeartbeat();\n\t\t}, this.pingInterval);\n\t}\n\n\tprivate _sendHeartbeat(): void {\n\t\tif (this._destroyed) return;\n\n\t\tif (!this._wsOpen()) {\n\t\t\tlogger.log(`Cannot send heartbeat, because socket closed`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst message = JSON.stringify({ type: ServerMessageType.Heartbeat });\n\n\t\tthis._socket!.send(message);\n\n\t\tthis._scheduleHeartbeat();\n\t}\n\n\t/** Is the websocket currently open? */\n\tprivate _wsOpen(): boolean {\n\t\treturn !!this._socket && this._socket.readyState === 1;\n\t}\n\n\t/** Send queued messages. */\n\tprivate _sendQueuedMessages(): void {\n\t\t//Create copy of queue and clear it,\n\t\t//because send method push the message back to queue if something will go wrong\n\t\tconst copiedQueue = [...this._messagesQueue];\n\t\tthis._messagesQueue = [];\n\n\t\tfor (const message of copiedQueue) {\n\t\t\tthis.send(message);\n\t\t}\n\n\t\tif (copiedQueue.length > 0) {\n\t\t\tlogger.log(`${copiedQueue.length} queued messages was sent`);\n\t\t}\n\t}\n\n\t/** Exposed send for DC & Peer. */\n\tsend(data: MessageData): void {\n\t\tif (this._destroyed) throw new Error(\"Socket was destroyed!\");\n\n\t\tif (!data.type) {\n\t\t\tthis.emit(SocketEventType.Error, \"Invalid message\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.alive) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If we didn't get an ID yet, we can't yet send anything so we should queue\n\t\t// up these messages.\n\t\tif (this._id == null || !this._wsOpen()) {\n\t\t\tthis._messagesQueue.push(data);\n\t\t\treturn;\n\t\t}\n\n\t\tconst message = JSON.stringify(data);\n\n\t\tthis._socket!.send(message);\n\t}\n\n\tclose(): void {\n\t\tif (this._disconnected) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._cleanup();\n\n\t\tthis._id = null;\n\n\t\tthis._disconnected = true;\n\t}\n\n\tprivate _cleanup(): void {\n\t\tif (this._socket) {\n\t\t\tthis._socket.onopen =\n\t\t\t\tthis._socket.onmessage =\n\t\t\t\tthis._socket.onclose =\n\t\t\t\t\tnull;\n\t\t\tthis._socket.close();\n\t\t\tthis._socket = undefined;\n\t\t}\n\n\t\tclearTimeout(this._wsPingTimer!);\n\t}\n\n\tdestroy() {\n\t\tif (this._destroyed) return;\n\n\t\tthis.close();\n\t\tthis._messagesQueue.length = 0;\n\n\t\tthis._destroyed = true;\n\t}\n}\n", "import logger from \"./logger\";\nimport type { MediaConnection } from \"./mediaconnection\";\nimport type { DataConnection } from \"./dataconnection\";\nimport {\n\tConnectionType,\n\tPeerErrorType,\n\tConnectionEventType,\n\tServerMessageType,\n} from \"./enums\";\nimport { BaseConnection } from \"./baseconnection\";\n\nfunction noop(): void {}\n/**\n * Manages all negotiations between Peers.\n */\nexport class Negotiator {\n\tconstructor(readonly connection: BaseConnection) {}\n\n\tprivate get webRtc() {\n\t\treturn this.connection.provider.options.polyfills?.WebRTC ?? window;\n\t}\n\n\t/** Returns a PeerConnection object set up correctly (for data, media). */\n\tstartConnection(options: any) {\n\t\tconst peerConnection = this._startPeerConnection();\n\n\t\t// Set the connection's PC.\n\t\tthis.connection.peerConnection = peerConnection;\n\n\t\tif (this.connection.type === ConnectionType.Media && options._stream) {\n\t\t\tthis._addTracksToConnection(options._stream, peerConnection);\n\t\t}\n\n\t\t// What do we need to do now?\n\t\tif (options.originator) {\n\t\t\tif (this.connection.type === ConnectionType.Data) {\n\t\t\t\tconst dataConnection = this.connection as DataConnection;\n\n\t\t\t\tconst config: RTCDataChannelInit = { ordered: !!options.reliable };\n\n\t\t\t\tconst dataChannel = peerConnection.createDataChannel(\n\t\t\t\t\tdataConnection.label,\n\t\t\t\t\tconfig,\n\t\t\t\t);\n\t\t\t\tdataConnection.initialize(dataChannel);\n\t\t\t}\n\n\t\t\tthis._makeOffer();\n\t\t} else {\n\t\t\tthis.handleSDP(\"OFFER\", options.sdp);\n\t\t}\n\t}\n\n\t/** Start a PC. */\n\tprivate _startPeerConnection(): RTCPeerConnection {\n\t\tlogger.log(\"Creating RTCPeerConnection.\");\n\n\t\tconst ctr: typeof RTCPeerConnection = this.webRtc.RTCPeerConnection;\n\n\t\tconst peerConnection = new ctr(this.connection.provider.options.config);\n\n\t\tthis._setupListeners(peerConnection);\n\n\t\treturn peerConnection;\n\t}\n\n\t/** Set up various WebRTC listeners. */\n\tprivate _setupListeners(peerConnection: RTCPeerConnection) {\n\t\tconst peerId = this.connection.peer;\n\t\tconst connectionId = this.connection.connectionId;\n\t\tconst connectionType = this.connection.type;\n\t\tconst provider = this.connection.provider;\n\n\t\t// ICE CANDIDATES.\n\t\tlogger.log(\n\t\t\t\"Listening for ICE candidates, remote streams and data channels.\",\n\t\t);\n\n\t\tpeerConnection.onicecandidate = (evt) => {\n\t\t\tif (!evt.candidate || !evt.candidate.candidate) return;\n\n\t\t\tlogger.log(`Received ICE candidates for ${peerId}:`, evt.candidate);\n\n\t\t\tprovider.socket.send({\n\t\t\t\ttype: ServerMessageType.Candidate,\n\t\t\t\tpayload: {\n\t\t\t\t\tcandidate: evt.candidate,\n\t\t\t\t\ttype: connectionType,\n\t\t\t\t\tconnectionId: connectionId,\n\t\t\t\t},\n\t\t\t\tdst: peerId,\n\t\t\t});\n\t\t};\n\n\t\tpeerConnection.oniceconnectionstatechange = () => {\n\t\t\tswitch (peerConnection.iceConnectionState) {\n\t\t\t\tcase \"failed\":\n\t\t\t\t\tlogger.log(\n\t\t\t\t\t\t\"iceConnectionState is failed, closing connections to \" + peerId,\n\t\t\t\t\t);\n\t\t\t\t\tthis.connection.emit(\n\t\t\t\t\t\tConnectionEventType.Error,\n\t\t\t\t\t\tnew Error(\"Negotiation of connection to \" + peerId + \" failed.\"),\n\t\t\t\t\t);\n\t\t\t\t\tthis.connection.close();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"closed\":\n\t\t\t\t\tlogger.log(\n\t\t\t\t\t\t\"iceConnectionState is closed, closing connections to \" + peerId,\n\t\t\t\t\t);\n\t\t\t\t\tthis.connection.emit(\n\t\t\t\t\t\tConnectionEventType.Error,\n\t\t\t\t\t\tnew Error(\"Connection to \" + peerId + \" closed.\"),\n\t\t\t\t\t);\n\t\t\t\t\tthis.connection.close();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"connected\":\n\t\t\t\t\tlogger.log(\n\t\t\t\t\t\t\"iceConnectionState changed to connected on the connection with \" +\n\t\t\t\t\t\t\tpeerId,\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"disconnected\":\n\t\t\t\t\tlogger.log(\n\t\t\t\t\t\t\"iceConnectionState changed to disconnected on the connection with \" +\n\t\t\t\t\t\t\tpeerId,\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"completed\":\n\t\t\t\t\tlogger.log(\n\t\t\t\t\t\t\"iceConnectionState changed to completed on the connection with \" +\n\t\t\t\t\t\t\tpeerId,\n\t\t\t\t\t);\n\t\t\t\t\tpeerConnection.onicecandidate = noop;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tthis.connection.emit(\n\t\t\t\tConnectionEventType.IceStateChanged,\n\t\t\t\tpeerConnection.iceConnectionState,\n\t\t\t);\n\t\t};\n\n\t\t// Fired between offer and answer, so options should already be saved\n\t\t// in the options hash.\n\t\tpeerConnection.ondatachannel = (evt) => {\n\t\t\tlogger.log(\"Received data channel\");\n\n\t\t\tconst dataChannel = evt.channel;\n\t\t\tconst connection = provider.getConnection(\n\t\t\t\tpeerId,\n\t\t\t\tconnectionId,\n\t\t\t) as DataConnection;\n\n\t\t\tconnection.initialize(dataChannel);\n\t\t};\n\n\t\tpeerConnection.ontrack = (evt) => {\n\t\t\tlogger.log(\"Received remote stream\");\n\n\t\t\tconst stream = evt.streams[0];\n\t\t\tconst connection = provider.getConnection(peerId, connectionId);\n\n\t\t\tif (connection.type === ConnectionType.Media) {\n\t\t\t\tconst mediaConnection = connection as MediaConnection;\n\n\t\t\t\tthis._addStreamToMediaConnection(stream, mediaConnection);\n\t\t\t}\n\t\t};\n\t}\n\n\tcleanup(): void {\n\t\tlogger.log(\"Cleaning up PeerConnection to \" + this.connection.peer);\n\n\t\tconst peerConnection = this.connection.peerConnection;\n\n\t\tif (!peerConnection) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.connection.peerConnection = null;\n\n\t\t//unsubscribe from all PeerConnection's events\n\t\tpeerConnection.onicecandidate =\n\t\t\tpeerConnection.oniceconnectionstatechange =\n\t\t\tpeerConnection.ondatachannel =\n\t\t\tpeerConnection.ontrack =\n\t\t\t\tnull;\n\n\t\tconst peerConnectionNotClosed = peerConnection.signalingState !== \"closed\";\n\t\tlet dataChannelNotClosed = false;\n\n\t\tif (this.connection.type === ConnectionType.Data) {\n\t\t\tconst dataConnection = this.connection as DataConnection;\n\t\t\tconst dataChannel = dataConnection.dataChannel;\n\n\t\t\tif (dataChannel) {\n\t\t\t\tdataChannelNotClosed =\n\t\t\t\t\t!!dataChannel.readyState && dataChannel.readyState !== \"closed\";\n\t\t\t}\n\t\t}\n\n\t\tif (peerConnectionNotClosed || dataChannelNotClosed) {\n\t\t\tpeerConnection.close();\n\t\t}\n\t}\n\n\tprivate async _makeOffer(): Promise<void> {\n\t\tconst peerConnection = this.connection.peerConnection;\n\t\tconst provider = this.connection.provider;\n\n\t\ttry {\n\t\t\tconst offer = await peerConnection.createOffer(\n\t\t\t\tthis.connection.options.constraints,\n\t\t\t);\n\n\t\t\tif (peerConnection.signalingState === \"closed\") return;\n\n\t\t\tlogger.log(\"Created offer.\");\n\n\t\t\tif (\n\t\t\t\tthis.connection.options.sdpTransform &&\n\t\t\t\ttypeof this.connection.options.sdpTransform === \"function\"\n\t\t\t) {\n\t\t\t\toffer.sdp =\n\t\t\t\t\tthis.connection.options.sdpTransform(offer.sdp) || offer.sdp;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait peerConnection.setLocalDescription(offer);\n\n\t\t\t\tlogger.log(\n\t\t\t\t\t\"Set localDescription:\",\n\t\t\t\t\toffer,\n\t\t\t\t\t`for:${this.connection.peer}`,\n\t\t\t\t);\n\n\t\t\t\tlet payload: any = {\n\t\t\t\t\tsdp: offer,\n\t\t\t\t\ttype: this.connection.type,\n\t\t\t\t\tconnectionId: this.connection.connectionId,\n\t\t\t\t\tmetadata: this.connection.metadata,\n\t\t\t\t};\n\n\t\t\t\tif (this.connection.type === ConnectionType.Data) {\n\t\t\t\t\tconst dataConnection = this.connection as DataConnection;\n\n\t\t\t\t\tpayload = {\n\t\t\t\t\t\t...payload,\n\t\t\t\t\t\tlabel: dataConnection.label,\n\t\t\t\t\t\treliable: dataConnection.reliable,\n\t\t\t\t\t\tserialization: dataConnection.serialization,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tprovider.socket.send({\n\t\t\t\t\ttype: ServerMessageType.Offer,\n\t\t\t\t\tpayload,\n\t\t\t\t\tdst: this.connection.peer,\n\t\t\t\t});\n\t\t\t} catch (err) {\n\t\t\t\t// TODO: investigate why _makeOffer is being called from the answer\n\t\t\t\tif (\n\t\t\t\t\terr !=\n\t\t\t\t\t\"OperationError: Failed to set local offer sdp: Called in wrong state: kHaveRemoteOffer\"\n\t\t\t\t) {\n\t\t\t\t\tprovider.emitError(PeerErrorType.WebRTC, err);\n\t\t\t\t\tlogger.log(\"Failed to setLocalDescription, \", err);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err_1) {\n\t\t\tprovider.emitError(PeerErrorType.WebRTC, err_1);\n\t\t\tlogger.log(\"Failed to createOffer, \", err_1);\n\t\t}\n\t}\n\n\tprivate async _makeAnswer(): Promise<void> {\n\t\tconst peerConnection = this.connection.peerConnection;\n\t\tconst provider = this.connection.provider;\n\n\t\ttry {\n\t\t\tconst answer = await peerConnection.createAnswer();\n\n\t\t\tif (peerConnection.signalingState === \"closed\") return;\n\n\t\t\tlogger.log(\"Created answer.\");\n\n\t\t\tif (\n\t\t\t\tthis.connection.options.sdpTransform &&\n\t\t\t\ttypeof this.connection.options.sdpTransform === \"function\"\n\t\t\t) {\n\t\t\t\tanswer.sdp =\n\t\t\t\t\tthis.connection.options.sdpTransform(answer.sdp) || answer.sdp;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait peerConnection.setLocalDescription(answer);\n\n\t\t\t\tlogger.log(\n\t\t\t\t\t`Set localDescription:`,\n\t\t\t\t\tanswer,\n\t\t\t\t\t`for:${this.connection.peer}`,\n\t\t\t\t);\n\n\t\t\t\tprovider.socket.send({\n\t\t\t\t\ttype: ServerMessageType.Answer,\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tsdp: answer,\n\t\t\t\t\t\ttype: this.connection.type,\n\t\t\t\t\t\tconnectionId: this.connection.connectionId,\n\t\t\t\t\t},\n\t\t\t\t\tdst: this.connection.peer,\n\t\t\t\t});\n\t\t\t} catch (err) {\n\t\t\t\tprovider.emitError(PeerErrorType.WebRTC, err);\n\t\t\t\tlogger.log(\"Failed to setLocalDescription, \", err);\n\t\t\t}\n\t\t} catch (err_1) {\n\t\t\tprovider.emitError(PeerErrorType.WebRTC, err_1);\n\t\t\tlogger.log(\"Failed to create answer, \", err_1);\n\t\t}\n\t}\n\n\t/** Handle an SDP. */\n\tasync handleSDP(type: string, sdp: any): Promise<void> {\n\t\tconst ctr: typeof RTCSessionDescription = this.webRtc.RTCSessionDescription;\n\n\t\tsdp = new ctr(sdp);\n\t\tconst peerConnection = this.connection.peerConnection;\n\t\tconst provider = this.connection.provider;\n\n\t\tlogger.log(\"Setting remote description\", sdp);\n\n\t\tconst self = this;\n\n\t\ttry {\n\t\t\tawait peerConnection.setRemoteDescription(sdp);\n\t\t\tlogger.log(`Set remoteDescription:${type} for:${this.connection.peer}`);\n\t\t\tif (type === \"OFFER\") {\n\t\t\t\tawait self._makeAnswer();\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tprovider.emitError(PeerErrorType.WebRTC, err);\n\t\t\tlogger.log(\"Failed to setRemoteDescription, \", err);\n\t\t}\n\t}\n\n\t/** Handle a candidate. */\n\tasync handleCandidate(ice: any): Promise<void> {\n\t\tlogger.log(`handleCandidate:`, ice);\n\n\t\tconst candidate = ice.candidate;\n\t\tconst sdpMLineIndex = ice.sdpMLineIndex;\n\t\tconst sdpMid = ice.sdpMid;\n\t\tconst peerConnection = this.connection.peerConnection;\n\t\tconst provider = this.connection.provider;\n\n\t\ttry {\n\t\t\tconst ctr: typeof RTCIceCandidate = this.webRtc.RTCIceCandidate;\n\n\t\t\tawait peerConnection.addIceCandidate(\n\t\t\t\tnew ctr({\n\t\t\t\t\tsdpMid: sdpMid,\n\t\t\t\t\tsdpMLineIndex: sdpMLineIndex,\n\t\t\t\t\tcandidate: candidate,\n\t\t\t\t}),\n\t\t\t);\n\t\t\tlogger.log(`Added ICE candidate for:${this.connection.peer}`);\n\t\t} catch (err) {\n\t\t\tprovider.emitError(PeerErrorType.WebRTC, err);\n\t\t\tlogger.log(\"Failed to handleCandidate, \", err);\n\t\t}\n\t}\n\n\tprivate _addTracksToConnection(\n\t\tstream: MediaStream,\n\t\tpeerConnection: RTCPeerConnection,\n\t): void {\n\t\tlogger.log(`add tracks from stream ${stream.id} to peer connection`);\n\n\t\tif (!peerConnection.addTrack) {\n\t\t\treturn logger.error(\n\t\t\t\t`Your browser does't support RTCPeerConnection#addTrack. Ignored.`,\n\t\t\t);\n\t\t}\n\n\t\tstream.getTracks().forEach((track) => {\n\t\t\tpeerConnection.addTrack(track, stream);\n\t\t});\n\t}\n\n\tprivate _addStreamToMediaConnection(\n\t\tstream: MediaStream,\n\t\tmediaConnection: MediaConnection,\n\t): void {\n\t\tlogger.log(\n\t\t\t`add stream ${stream.id} to media connection ${mediaConnection.connectionId}`,\n\t\t);\n\n\t\tmediaConnection.addStream(stream);\n\t}\n}\n", "import { EventEmitter } from \"eventemitter3\";\nimport type { Peer } from \"./peer\";\nimport type { ServerMessage } from \"./servermessage\";\nimport type { ConnectionType } from \"./enums\";\n\nexport abstract class BaseConnection extends EventEmitter {\n\tprotected _open = false;\n\n\treadonly metadata: any;\n\tconnectionId: string;\n\n\tpeerConnection: RTCPeerConnection;\n\n\tabstract get type(): ConnectionType;\n\n\tget open() {\n\t\treturn this._open;\n\t}\n\n\tconstructor(\n\t\treadonly peer: string,\n\t\tpublic provider: Peer,\n\t\treadonly options: any,\n\t) {\n\t\tsuper();\n\n\t\tthis.metadata = options.metadata;\n\t}\n\n\tabstract close(): void;\n\n\tabstract handleMessage(message: ServerMessage): void;\n}\n", "import { Utils } from \"./utils\";\nimport logger from \"./logger\";\nimport { Negotiator } from \"./negotiator\";\nimport {\n\tConnectionType,\n\tConnectionEventType,\n\tServerMessageType,\n} from \"./enums\";\nimport type { Peer } from \"./peer\";\nimport { BaseConnection } from \"./baseconnection\";\nimport type { ServerMessage } from \"./servermessage\";\nimport type { AnswerOption } from \"..\";\n\n/**\n * Wraps the streaming interface between two Peers.\n */\nexport class MediaConnection extends BaseConnection {\n\tprivate static readonly ID_PREFIX = \"mc_\";\n\n\tprivate _negotiator: Negotiator;\n\tprivate _localStream: MediaStream;\n\tprivate _remoteStream: MediaStream;\n\n\tget type() {\n\t\treturn ConnectionType.Media;\n\t}\n\n\tget localStream(): MediaStream {\n\t\treturn this._localStream;\n\t}\n\tget remoteStream(): MediaStream {\n\t\treturn this._remoteStream;\n\t}\n\n\tconstructor(peerId: string, provider: Peer, options: any) {\n\t\tsuper(peerId, provider, options);\n\n\t\tthis._localStream = this.options._stream;\n\t\tthis.connectionId =\n\t\t\tthis.options.connectionId ||\n\t\t\tMediaConnection.ID_PREFIX + Utils.randomToken();\n\n\t\tthis._negotiator = new Negotiator(this);\n\n\t\tif (this._localStream) {\n\t\t\tthis._negotiator.startConnection({\n\t\t\t\t_stream: this._localStream,\n\t\t\t\toriginator: true,\n\t\t\t});\n\t\t}\n\t}\n\n\taddStream(remoteStream) {\n\t\tlogger.log(\"Receiving stream\", remoteStream);\n\n\t\tthis._remoteStream = remoteStream;\n\t\tsuper.emit(ConnectionEventType.Stream, remoteStream); // Should we call this `open`?\n\t}\n\n\thandleMessage(message: ServerMessage): void {\n\t\tconst type = message.type;\n\t\tconst payload = message.payload;\n\n\t\tswitch (message.type) {\n\t\t\tcase ServerMessageType.Answer:\n\t\t\t\t// Forward to negotiator\n\t\t\t\tthis._negotiator.handleSDP(type, payload.sdp);\n\t\t\t\tthis._open = true;\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Candidate:\n\t\t\t\tthis._negotiator.handleCandidate(payload.candidate);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.warn(`Unrecognized message type:${type} from peer:${this.peer}`);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tanswer(stream: MediaStream, options: AnswerOption = {}): void {\n\t\tif (this._localStream) {\n\t\t\tlogger.warn(\n\t\t\t\t\"Local stream already exists on this MediaConnection. Are you answering a call twice?\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tthis._localStream = stream;\n\n\t\tif (options && options.sdpTransform) {\n\t\t\tthis.options.sdpTransform = options.sdpTransform;\n\t\t}\n\n\t\tthis._negotiator.startConnection({\n\t\t\t...this.options._payload,\n\t\t\t_stream: stream,\n\t\t});\n\t\t// Retrieve lost messages stored because PeerConnection not set up.\n\t\tconst messages = this.provider._getMessages(this.connectionId);\n\n\t\tfor (let message of messages) {\n\t\t\tthis.handleMessage(message);\n\t\t}\n\n\t\tthis._open = true;\n\t}\n\n\t/**\n\t * Exposed functionality for users.\n\t */\n\n\t/** Allows user to close connection. */\n\tclose(): void {\n\t\tif (this._negotiator) {\n\t\t\tthis._negotiator.cleanup();\n\t\t\tthis._negotiator = null;\n\t\t}\n\n\t\tthis._localStream = null;\n\t\tthis._remoteStream = null;\n\n\t\tif (this.provider) {\n\t\t\tthis.provider._removeConnection(this);\n\n\t\t\tthis.provider = null;\n\t\t}\n\n\t\tif (this.options && this.options._stream) {\n\t\t\tthis.options._stream = null;\n\t\t}\n\n\t\tif (!this.open) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._open = false;\n\n\t\tsuper.emit(ConnectionEventType.Close);\n\t}\n}\n", "import { EventEmitter } from \"eventemitter3\";\nimport logger from \"./logger\";\n\nexport class EncodingQueue extends EventEmitter {\n\tprivate _queue: Blob[] = [];\n\tprivate _processing: boolean = false;\n\n\tconstructor(private readonly fileReader: FileReader) {\n\t\tsuper();\n\n\t\tthis.fileReader.onload = (evt) => {\n\t\t\tthis._processing = false;\n\n\t\t\tif (evt.target) {\n\t\t\t\tthis.emit(\"done\", evt.target.result as ArrayBuffer);\n\t\t\t}\n\n\t\t\tthis.doNextTask();\n\t\t};\n\n\t\tthis.fileReader.onerror = (evt) => {\n\t\t\tlogger.error(`EncodingQueue error:`, evt);\n\t\t\tthis._processing = false;\n\t\t\tthis.destroy();\n\t\t\tthis.emit(\"error\", evt);\n\t\t};\n\t}\n\n\tget queue(): Blob[] {\n\t\treturn this._queue;\n\t}\n\n\tget size(): number {\n\t\treturn this.queue.length;\n\t}\n\n\tget processing(): boolean {\n\t\treturn this._processing;\n\t}\n\n\tenque(blob: Blob): void {\n\t\tthis.queue.push(blob);\n\n\t\tif (this.processing) return;\n\n\t\tthis.doNextTask();\n\t}\n\n\tdestroy(): void {\n\t\tthis.fileReader.abort();\n\t\tthis._queue = [];\n\t}\n\n\tprivate doNextTask(): void {\n\t\tif (this.size === 0) return;\n\t\tif (this.processing) return;\n\n\t\tthis._processing = true;\n\n\t\tthis.fileReader.readAsArrayBuffer(this.queue.shift());\n\t}\n}\n", "import { Utils } from \"./utils\";\nimport logger from \"./logger\";\nimport { Negotiator } from \"./negotiator\";\nimport {\n\tConnectionType,\n\tConnectionEventType,\n\tSerializationType,\n\tServerMessageType,\n} from \"./enums\";\nimport type { Peer } from \"./peer\";\nimport { BaseConnection } from \"./baseconnection\";\nimport type { ServerMessage } from \"./servermessage\";\nimport { EncodingQueue } from \"./encodingQueue\";\nimport type { DataConnection as IDataConnection } from \"../index\";\n\n/**\n * Wraps a DataChannel between two Peers.\n */\nexport class DataConnection extends BaseConnection implements IDataConnection {\n\tprivate static readonly ID_PREFIX = \"dc_\";\n\tprivate static readonly MAX_BUFFERED_AMOUNT = 8 * 1024 * 1024;\n\n\tprivate _negotiator: Negotiator;\n\treadonly label: string;\n\treadonly serialization: SerializationType;\n\treadonly reliable: boolean;\n\tstringify: (data: any) => string = JSON.stringify;\n\tparse: (data: string) => any = JSON.parse;\n\n\tget type() {\n\t\treturn ConnectionType.Data;\n\t}\n\n\tprivate _buffer: any[] = [];\n\tprivate _bufferSize = 0;\n\tprivate _buffering = false;\n\tprivate _chunkedData: {\n\t\t[id: number]: {\n\t\t\tdata: Blob[];\n\t\t\tcount: number;\n\t\t\ttotal: number;\n\t\t};\n\t} = {};\n\n\tprivate _dc: RTCDataChannel;\n\tprivate _encodingQueue: EncodingQueue;\n\n\tget dataChannel(): RTCDataChannel {\n\t\treturn this._dc;\n\t}\n\n\tget bufferSize(): number {\n\t\treturn this._bufferSize;\n\t}\n\n\tprivate readonly FileReaderCtr: typeof FileReader;\n\n\tconstructor(peerId: string, provider: Peer, options: any) {\n\t\tsuper(peerId, provider, options);\n\n\t\tthis.connectionId =\n\t\t\tthis.options.connectionId ||\n\t\t\tDataConnection.ID_PREFIX + Utils.randomToken();\n\n\t\tthis.label = this.options.label || this.connectionId;\n\t\tthis.serialization = this.options.serialization || SerializationType.Binary;\n\t\tthis.reliable = !!this.options.reliable;\n\n\t\tthis.FileReaderCtr =\n\t\t\tprovider.options.polyfills?.FileReader ?? window.FileReader;\n\n\t\tthis._encodingQueue = new EncodingQueue(new this.FileReaderCtr());\n\n\t\tthis._encodingQueue.on(\"done\", (ab: ArrayBuffer) => {\n\t\t\tthis._bufferedSend(ab);\n\t\t});\n\n\t\tthis._encodingQueue.on(\"error\", () => {\n\t\t\tlogger.error(\n\t\t\t\t`DC#${this.connectionId}: Error occured in encoding from blob to arraybuffer, close DC`,\n\t\t\t);\n\t\t\tthis.close();\n\t\t});\n\n\t\tthis._negotiator = new Negotiator(this);\n\n\t\tthis._negotiator.startConnection(\n\t\t\tthis.options._payload || {\n\t\t\t\toriginator: true,\n\t\t\t},\n\t\t);\n\t}\n\n\t/** Called by the Negotiator when the DataChannel is ready. */\n\tinitialize(dc: RTCDataChannel): void {\n\t\tthis._dc = dc;\n\t\tthis._configureDataChannel();\n\t}\n\n\tprivate _configureDataChannel(): void {\n\t\tif (!this.provider.features.binaryBlob || this.provider.features.reliable) {\n\t\t\tthis.dataChannel.binaryType = \"arraybuffer\";\n\t\t}\n\n\t\tthis.dataChannel.onopen = () => {\n\t\t\tlogger.log(`DC#${this.connectionId} dc connection success`);\n\t\t\tthis._open = true;\n\t\t\tthis.emit(ConnectionEventType.Open);\n\t\t};\n\n\t\tthis.dataChannel.onmessage = (e) => {\n\t\t\tlogger.log(`DC#${this.connectionId} dc onmessage:`, e.data);\n\t\t\tthis._handleDataMessage(e);\n\t\t};\n\n\t\tthis.dataChannel.onclose = () => {\n\t\t\tlogger.log(`DC#${this.connectionId} dc closed for:`, this.peer);\n\t\t\tthis.close();\n\t\t};\n\t}\n\n\t// Handles a DataChannel message.\n\tprivate _handleDataMessage({\n\t\tdata,\n\t}: {\n\t\tdata: Blob | ArrayBuffer | string;\n\t}): void {\n\t\tconst datatype = data.constructor;\n\n\t\tconst isBinarySerialization =\n\t\t\tthis.serialization === SerializationType.Binary ||\n\t\t\tthis.serialization === SerializationType.BinaryUTF8;\n\n\t\tlet deserializedData: any = data;\n\n\t\tif (isBinarySerialization) {\n\t\t\tif (datatype === Blob) {\n\t\t\t\t// Datatype should never be Blob\n\t\t\t\tUtils.blobToArrayBuffer(this.FileReaderCtr, data as Blob, (ab) => {\n\t\t\t\t\tconst unpackedData = Utils.unpack(ab);\n\t\t\t\t\tthis.emit(ConnectionEventType.Data, unpackedData);\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t} else if (datatype === ArrayBuffer) {\n\t\t\t\tdeserializedData = Utils.unpack(data as ArrayBuffer);\n\t\t\t} else if (datatype === String) {\n\t\t\t\t// String fallback for binary data for browsers that don't support binary yet\n\t\t\t\tconst ab = Utils.binaryStringToArrayBuffer(data as string);\n\t\t\t\tdeserializedData = Utils.unpack(ab);\n\t\t\t}\n\t\t} else if (this.serialization === SerializationType.JSON) {\n\t\t\tdeserializedData = this.parse(data as string);\n\t\t}\n\n\t\t// Check if we've chunked--if so, piece things back together.\n\t\t// We're guaranteed that this isn't 0.\n\t\tif (deserializedData.__peerData) {\n\t\t\tthis._handleChunk(deserializedData);\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.emit(ConnectionEventType.Data, deserializedData);\n\t}\n\n\tprivate _handleChunk(data: {\n\t\t__peerData: number;\n\t\tn: number;\n\t\ttotal: number;\n\t\tdata: Blob;\n\t}): void {\n\t\tconst id = data.__peerData;\n\t\tconst chunkInfo = this._chunkedData[id] || {\n\t\t\tdata: [],\n\t\t\tcount: 0,\n\t\t\ttotal: data.total,\n\t\t};\n\n\t\tchunkInfo.data[data.n] = data.data;\n\t\tchunkInfo.count++;\n\t\tthis._chunkedData[id] = chunkInfo;\n\n\t\tif (chunkInfo.total === chunkInfo.count) {\n\t\t\t// Clean up before making the recursive call to `_handleDataMessage`.\n\t\t\tdelete this._chunkedData[id];\n\n\t\t\t// We've received all the chunks--time to construct the complete data.\n\t\t\tconst data = new Blob(chunkInfo.data);\n\t\t\tthis._handleDataMessage({ data });\n\t\t}\n\t}\n\n\t/**\n\t * Exposed functionality for users.\n\t */\n\n\t/** Allows user to close connection. */\n\tclose(): void {\n\t\tthis._buffer = [];\n\t\tthis._bufferSize = 0;\n\t\tthis._chunkedData = {};\n\n\t\tif (this._negotiator) {\n\t\t\tthis._negotiator.cleanup();\n\t\t\tthis._negotiator = null;\n\t\t}\n\n\t\tif (this.provider) {\n\t\t\tthis.provider._removeConnection(this);\n\n\t\t\tthis.provider = null;\n\t\t}\n\n\t\tif (this.dataChannel) {\n\t\t\tthis.dataChannel.onopen = null;\n\t\t\tthis.dataChannel.onmessage = null;\n\t\t\tthis.dataChannel.onclose = null;\n\t\t\tthis._dc = null;\n\t\t}\n\n\t\tif (this._encodingQueue) {\n\t\t\tthis._encodingQueue.destroy();\n\t\t\tthis._encodingQueue.removeAllListeners();\n\t\t\tthis._encodingQueue = null;\n\t\t}\n\n\t\tif (!this.open) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._open = false;\n\n\t\tsuper.emit(ConnectionEventType.Close);\n\t}\n\n\t/** Allows user to send data. */\n\tsend(data: any, chunked?: boolean): void {\n\t\tif (!this.open) {\n\t\t\tsuper.emit(\n\t\t\t\tConnectionEventType.Error,\n\t\t\t\tnew Error(\n\t\t\t\t\t\"Connection is not open. You should listen for the `open` event before sending messages.\",\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.serialization === SerializationType.JSON) {\n\t\t\tthis._bufferedSend(this.stringify(data));\n\t\t} else if (\n\t\t\tthis.serialization === SerializationType.Binary ||\n\t\t\tthis.serialization === SerializationType.BinaryUTF8\n\t\t) {\n\t\t\tconst blob = Utils.pack(data);\n\n\t\t\tif (!chunked && blob.size > Utils.chunkedMTU) {\n\t\t\t\tthis._sendChunks(blob);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.provider.features.binaryBlob) {\n\t\t\t\t// We only do this if we really need to (e.g. blobs are not supported),\n\t\t\t\t// because this conversion is costly.\n\t\t\t\tthis._encodingQueue.enque(blob);\n\t\t\t} else {\n\t\t\t\tthis._bufferedSend(blob);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._bufferedSend(data);\n\t\t}\n\t}\n\n\tprivate _bufferedSend(msg: any): void {\n\t\tif (this._buffering || !this._trySend(msg)) {\n\t\t\tthis._buffer.push(msg);\n\t\t\tthis._bufferSize = this._buffer.length;\n\t\t}\n\t}\n\n\t// Returns true if the send succeeds.\n\tprivate _trySend(msg: any): boolean {\n\t\tif (!this.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.dataChannel.bufferedAmount > DataConnection.MAX_BUFFERED_AMOUNT) {\n\t\t\tthis._buffering = true;\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis._buffering = false;\n\t\t\t\tthis._tryBuffer();\n\t\t\t}, 50);\n\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\tthis.dataChannel.send(msg);\n\t\t} catch (e) {\n\t\t\tlogger.error(`DC#:${this.connectionId} Error when sending:`, e);\n\t\t\tthis._buffering = true;\n\n\t\t\tthis.close();\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t// Try to send the first message in the buffer.\n\tprivate _tryBuffer(): void {\n\t\tif (!this.open) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._buffer.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msg = this._buffer[0];\n\n\t\tif (this._trySend(msg)) {\n\t\t\tthis._buffer.shift();\n\t\t\tthis._bufferSize = this._buffer.length;\n\t\t\tthis._tryBuffer();\n\t\t}\n\t}\n\n\tprivate _sendChunks(blob: Blob): void {\n\t\tconst blobs = Utils.chunk(blob);\n\t\tlogger.log(`DC#${this.connectionId} Try to send ${blobs.length} chunks...`);\n\n\t\tfor (let blob of blobs) {\n\t\t\tthis.send(blob, true);\n\t\t}\n\t}\n\n\thandleMessage(message: ServerMessage): void {\n\t\tconst payload = message.payload;\n\n\t\tswitch (message.type) {\n\t\t\tcase ServerMessageType.Answer:\n\t\t\t\tthis._negotiator.handleSDP(message.type, payload.sdp);\n\t\t\t\tbreak;\n\t\t\tcase ServerMessageType.Candidate:\n\t\t\t\tthis._negotiator.handleCandidate(payload.candidate);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.warn(\n\t\t\t\t\t\"Unrecognized message type:\",\n\t\t\t\t\tmessage.type,\n\t\t\t\t\t\"from peer:\",\n\t\t\t\t\tthis.peer,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n", "import { Utils } from \"./utils\";\nimport logger from \"./logger\";\nimport { PeerJSOption } from \"..\";\n\nexport class API {\n\tconstructor(private readonly _options: PeerJSOption) {}\n\n\tprivate _request(url: string) {\n\t\treturn (this._options.polyfills?.fetch ?? window.fetch)(url);\n\t}\n\n\tprivate _buildUrl(method: string): string {\n\t\tconst protocol = this._options.secure ? \"https://\" : \"http://\";\n\t\tlet url =\n\t\t\tprotocol +\n\t\t\tthis._options.host +\n\t\t\t\":\" +\n\t\t\tthis._options.port +\n\t\t\tthis._options.path +\n\t\t\tthis._options.key +\n\t\t\t\"/\" +\n\t\t\tmethod;\n\t\tconst queryString = \"?ts=\" + new Date().getTime() + \"\" + Math.random();\n\t\turl += queryString;\n\n\t\treturn url;\n\t}\n\n\t/** Get a unique ID from the server via XHR and initialize with it. */\n\tasync retrieveId(): Promise<string> {\n\t\tconst url = this._buildUrl(\"id\");\n\n\t\ttry {\n\t\t\tconst response = await this._request(url);\n\n\t\t\tif (response.status !== 200) {\n\t\t\t\tthrow new Error(`Error. Status:${response.status}`);\n\t\t\t}\n\n\t\t\treturn response.text();\n\t\t} catch (error) {\n\t\t\tlogger.error(\"Error retrieving ID\", error);\n\n\t\t\tlet pathError = \"\";\n\n\t\t\tif (\n\t\t\t\tthis._options.path === \"/\" &&\n\t\t\t\tthis._options.host !== Utils.CLOUD_HOST\n\t\t\t) {\n\t\t\t\tpathError =\n\t\t\t\t\t\" If you passed in a `path` to your self-hosted PeerServer, \" +\n\t\t\t\t\t\"you'll also need to pass in that same path when creating a new \" +\n\t\t\t\t\t\"Peer.\";\n\t\t\t}\n\n\t\t\tthrow new Error(\"Could not get an ID from the server.\" + pathError);\n\t\t}\n\t}\n\n\t/** @deprecated */\n\tasync listAllPeers(): Promise<any[]> {\n\t\tconst url = this._buildUrl(\"peers\");\n\n\t\ttry {\n\t\t\tconst response = await this._request(url);\n\n\t\t\tif (response.status !== 200) {\n\t\t\t\tif (response.status === 401) {\n\t\t\t\t\tlet helpfulError = \"\";\n\n\t\t\t\t\tif (this._options.host === Utils.CLOUD_HOST) {\n\t\t\t\t\t\thelpfulError =\n\t\t\t\t\t\t\t\"It looks like you're using the cloud server. You can email \" +\n\t\t\t\t\t\t\t\"team@peerjs.com to enable peer listing for your API key.\";\n\t\t\t\t\t} else {\n\t\t\t\t\t\thelpfulError =\n\t\t\t\t\t\t\t\"You need to enable `allow_discovery` on your self-hosted \" +\n\t\t\t\t\t\t\t\"PeerServer to use this feature.\";\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\"It doesn't look like you have permission to list peers IDs. \" +\n\t\t\t\t\t\t\thelpfulError,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tthrow new Error(`Error. Status:${response.status}`);\n\t\t\t}\n\n\t\t\treturn response.json();\n\t\t} catch (error) {\n\t\t\tlogger.error(\"Error retrieving list peers\", error);\n\n\t\t\tthrow new Error(\"Could not get list peers from the server.\" + error);\n\t\t}\n\t}\n}\n", "export const Supports = {\n\tisUnifiedPlanSupported(webRtc: any): boolean {\n\t\tif (!webRtc && typeof window !== \"undefined\") {\n\t\t\twebRtc = window;\n\t\t}\n\n\t\tif (\n\t\t\ttypeof webRtc.RTCRtpTransceiver === \"undefined\" ||\n\t\t\t!(\"currentDirection\" in webRtc.RTCRtpTransceiver.prototype)\n\t\t) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet tempPc: RTCPeerConnection;\n\t\tlet supported = false;\n\n\t\ttry {\n\t\t\ttempPc = new webRtc.RTCPeerConnection();\n\t\t\ttempPc.addTransceiver(\"audio\");\n\t\t\tsupported = true;\n\t\t} catch (e) {\n\t\t} finally {\n\t\t\tif (tempPc) {\n\t\t\t\ttempPc.close();\n\t\t\t}\n\t\t}\n\n\t\treturn supported;\n\t},\n} as const;\n", "import { Utils } from \"./utils\";\nimport { Peer } from \"./peer\";\n\nexport { Peer, Utils };\n\nexport default Peer;\n\nif (typeof window !== \"undefined\") {\n\t// @ts-expect-error\n\twindow.Peer = Peer;\n}\n"],
  "mappings": "mkCAAA,IAAAA,EAAAC,EAAA,CAAAC,GAAAC,IAAA,KAAIC,EAAiB,CAAC,EACtBA,EAAe,eAAkB,UAAY,CAC3C,GAAI,CACF,WAAI,KAAK,CAAC,CAAC,EACJ,EACT,OAASC,EAAP,CACA,MAAO,EACT,CACF,EAAG,EAEHD,EAAe,mBAAqB,CAACA,EAAe,gBAAmB,UAAY,CACjF,GAAI,CACF,OAAQ,IAAI,KAAK,CAAC,IAAI,WAAW,CAAC,CAAC,CAAC,CAAC,EAAG,OAAS,CACnD,OAASC,EAAP,CACA,MAAO,EACT,CACF,EAAG,EAEHF,EAAO,QAAQ,eAAiBC,EAChC,IAAIE,EAAcH,EAAO,QAAQ,YAC7B,OAAO,QAAW,cACpBG,EAAcH,EAAO,QAAQ,YAAc,OAAO,mBAChD,OAAO,gBAAkB,OAAO,eAAiB,OAAO,aAG5D,SAASI,GAAiB,CACxB,KAAK,QAAU,CAAC,EAChB,KAAK,OAAS,CAAC,CACjB,CAEAA,EAAc,UAAU,OAAS,SAAUC,EAAM,CAC3C,OAAOA,GAAS,SAClB,KAAK,QAAQ,KAAKA,CAAI,GAEtB,KAAK,MAAM,EACX,KAAK,OAAO,KAAKA,CAAI,EAEzB,EAEAD,EAAc,UAAU,MAAQ,UAAY,CAC1C,GAAI,KAAK,QAAQ,OAAS,EAAG,CAC3B,IAAIE,EAAM,IAAI,WAAW,KAAK,OAAO,EAChCL,EAAe,qBAClBK,EAAMA,EAAI,QAEZ,KAAK,OAAO,KAAKA,CAAG,EACpB,KAAK,QAAU,CAAC,CAClB,CACF,EAEAF,EAAc,UAAU,UAAY,UAAY,CAE9C,GADA,KAAK,MAAM,EACPH,EAAe,eAAgB,CAEjC,QADIM,EAAU,IAAIJ,EACTK,EAAI,EAAGC,EAAK,KAAK,OAAO,OAAQD,EAAIC,EAAID,IAC/CD,EAAQ,OAAO,KAAK,OAAOC,EAAE,EAE/B,OAAOD,EAAQ,QAAQ,CACzB,KACE,QAAO,IAAI,KAAK,KAAK,MAAM,CAE/B,EAEAP,EAAO,QAAQ,cAAgBI,IC/D/B,IAAAM,GAAAC,EAAA,CAAAC,GAAAC,IAAA,KAAIC,GAAgB,IAA2B,cAC3CC,EAAiB,IAA2B,eAE5CC,GAAa,CACf,OAAQ,SAAUC,EAAM,CACtB,IAAIC,EAAW,IAAIC,EAASF,CAAI,EAChC,OAAOC,EAAS,OAAO,CACzB,EACA,KAAM,SAAUD,EAAM,CACpB,IAAIG,EAAS,IAAIC,EACjBD,EAAO,KAAKH,CAAI,EAChB,IAAIK,EAASF,EAAO,UAAU,EAC9B,OAAOE,CACT,CACF,EAEAT,EAAO,QAAUG,GAEjB,SAASG,EAAUF,EAAM,CAEvB,KAAK,MAAQ,EACb,KAAK,WAAaA,EAClB,KAAK,SAAW,IAAI,WAAW,KAAK,UAAU,EAC9C,KAAK,OAAS,KAAK,WAAW,UAChC,CAEAE,EAAS,UAAU,OAAS,UAAY,CACtC,IAAII,EAAO,KAAK,aAAa,EAC7B,GAAIA,EAAO,IACT,OAAOA,EACF,IAAKA,EAAO,KAAQ,GACzB,OAAQA,EAAO,KAAQ,GAGzB,IAAIC,EACJ,IAAKA,EAAOD,EAAO,MAAS,GAC1B,OAAO,KAAK,WAAWC,CAAI,EACtB,IAAKA,EAAOD,EAAO,MAAS,GACjC,OAAO,KAAK,cAAcC,CAAI,EACzB,IAAKA,EAAOD,EAAO,MAAS,GACjC,OAAO,KAAK,aAAaC,CAAI,EACxB,IAAKA,EAAOD,EAAO,MAAS,GACjC,OAAO,KAAK,WAAWC,CAAI,EAG7B,OAAQD,OACD,KACH,OAAO,SACJ,KACH,WACG,KACH,MAAO,OACJ,KACH,MAAO,OACJ,KACH,OAAO,KAAK,aAAa,MACtB,KACH,OAAO,KAAK,cAAc,MACvB,KACH,OAAO,KAAK,aAAa,MACtB,KACH,OAAO,KAAK,cAAc,MACvB,KACH,OAAO,KAAK,cAAc,MACvB,KACH,OAAO,KAAK,cAAc,MACvB,KACH,OAAO,KAAK,YAAY,MACrB,KACH,OAAO,KAAK,aAAa,MACtB,KACH,OAAO,KAAK,aAAa,MACtB,KACH,OAAO,KAAK,aAAa,MACtB,KACH,WACG,KACH,WACG,KACH,WACG,KACH,WACG,KACH,OAAAC,EAAO,KAAK,cAAc,EACnB,KAAK,cAAcA,CAAI,MAC3B,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,cAAcA,CAAI,MAC3B,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,WAAWA,CAAI,MACxB,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,WAAWA,CAAI,MACxB,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,aAAaA,CAAI,MAC1B,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,aAAaA,CAAI,MAC1B,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,WAAWA,CAAI,MACxB,KACH,OAAAA,EAAO,KAAK,cAAc,EACnB,KAAK,WAAWA,CAAI,EAEjC,EAEAL,EAAS,UAAU,aAAe,UAAY,CAC5C,IAAIM,EAAO,KAAK,SAAS,KAAK,OAAS,IACvC,YAAK,QACEA,CACT,EAEAN,EAAS,UAAU,cAAgB,UAAY,CAC7C,IAAIO,EAAQ,KAAK,KAAK,CAAC,EACnBC,GACAD,EAAM,GAAK,KAAQ,KAAQA,EAAM,GAAK,KAC1C,YAAK,OAAS,EACPC,CACT,EAEAR,EAAS,UAAU,cAAgB,UAAY,CAC7C,IAAIO,EAAQ,KAAK,KAAK,CAAC,EACnBE,IACAF,EAAM,GAAK,IACXA,EAAM,IAAM,IACZA,EAAM,IAAM,IACdA,EAAM,GACR,YAAK,OAAS,EACPE,CACT,EAEAT,EAAS,UAAU,cAAgB,UAAY,CAC7C,IAAIO,EAAQ,KAAK,KAAK,CAAC,EACnBG,QACIH,EAAM,GAAK,IACfA,EAAM,IAAM,IACZA,EAAM,IAAM,IACZA,EAAM,IAAM,IACZA,EAAM,IAAM,IACZA,EAAM,IAAM,IACZA,EAAM,IAAM,IACdA,EAAM,GACR,YAAK,OAAS,EACPG,CACT,EAEAV,EAAS,UAAU,YAAc,UAAY,CAC3C,IAAIW,EAAQ,KAAK,aAAa,EAC9B,OAAQA,EAAQ,IAAQA,EAAQA,GAAS,GAAK,EAChD,EAEAX,EAAS,UAAU,aAAe,UAAY,CAC5C,IAAIQ,EAAS,KAAK,cAAc,EAChC,OAAQA,EAAS,MAAUA,EAASA,GAAU,GAAK,GACrD,EAEAR,EAAS,UAAU,aAAe,UAAY,CAC5C,IAAIS,EAAS,KAAK,cAAc,EAChC,OAAQA,EAAS,KAAK,IAAI,EAAG,EAAE,EAAKA,EAChCA,EAAS,KAAK,IAAI,EAAG,EAAE,CAC7B,EAEAT,EAAS,UAAU,aAAe,UAAY,CAC5C,IAAIU,EAAS,KAAK,cAAc,EAChC,OAAQA,EAAS,KAAK,IAAI,EAAG,EAAE,EAAKA,EAChCA,EAAS,KAAK,IAAI,EAAG,EAAE,CAC7B,EAEAV,EAAS,UAAU,WAAa,SAAUK,EAAM,CAC9C,GAAI,KAAK,OAAS,KAAK,MAAQA,EAC7B,MAAM,IAAI,MAAM,4CACR,KAAK,MAAQ,IAAMA,EAAO,IAAM,KAAK,MAAM,EAErD,IAAIO,EAAM,KAAK,WAAW,MAAM,KAAK,MAAO,KAAK,MAAQP,CAAI,EAC7D,YAAK,OAASA,EAIPO,CACT,EAEAZ,EAAS,UAAU,cAAgB,SAAUK,EAAM,CAOjD,QANIE,EAAQ,KAAK,KAAKF,CAAI,EACtBQ,EAAI,EACJC,EAAM,GACNC,EACAC,EAEGH,EAAIR,GACTU,EAAIR,EAAMM,GACNE,EAAI,KACND,GAAO,OAAO,aAAaC,CAAC,EAC5BF,MACUE,EAAI,KAAQ,IACtBC,GAASD,EAAI,MAAS,EAAMR,EAAMM,EAAI,GAAK,GAC3CC,GAAO,OAAO,aAAaE,CAAI,EAC/BH,GAAK,IAELG,GAASD,EAAI,KAAO,IAAQR,EAAMM,EAAI,GAAK,KAAO,EAC/CN,EAAMM,EAAI,GAAK,GAClBC,GAAO,OAAO,aAAaE,CAAI,EAC/BH,GAAK,GAIT,YAAK,OAASR,EACPS,CACT,EAEAd,EAAS,UAAU,aAAe,SAAUK,EAAM,CAEhD,QADIY,EAAU,IAAI,MAAMZ,CAAI,EACnBQ,EAAI,EAAGA,EAAIR,EAAMQ,IACxBI,EAAQJ,GAAK,KAAK,OAAO,EAE3B,OAAOI,CACT,EAEAjB,EAAS,UAAU,WAAa,SAAUK,EAAM,CAE9C,QADIa,EAAM,CAAC,EACFL,EAAI,EAAGA,EAAIR,EAAMQ,IAAK,CAC7B,IAAIM,EAAM,KAAK,OAAO,EAClBC,EAAQ,KAAK,OAAO,EACxBF,EAAIC,GAAOC,CACb,CACA,OAAOF,CACT,EAEAlB,EAAS,UAAU,aAAe,UAAY,CAC5C,IAAIS,EAAS,KAAK,cAAc,EAC5BY,EAAOZ,GAAU,GACjBa,GAAQb,GAAU,GAAM,KAAQ,IAChCc,EAAYd,EAAS,QAAY,QACrC,OAAQY,IAAS,EAAI,EAAI,IACvBE,EAAW,KAAK,IAAI,EAAGD,EAAM,EAAE,CACnC,EAEAtB,EAAS,UAAU,cAAgB,UAAY,CAC7C,IAAIwB,EAAM,KAAK,cAAc,EACzBC,EAAM,KAAK,cAAc,EACzBJ,EAAOG,GAAO,GACdF,GAAQE,GAAO,GAAM,MAAS,KAC9BE,EAASF,EAAM,QAAW,QAC1BG,EAAOD,EAAQ,KAAK,IAAI,EAAGJ,EAAM,EAAE,EACrCG,EAAM,KAAK,IAAI,EAAGH,EAAM,EAAE,EAC5B,OAAQD,IAAS,EAAI,EAAI,IAAMM,CACjC,EAEA3B,EAAS,UAAU,KAAO,SAAU4B,EAAQ,CAC1C,IAAIC,EAAI,KAAK,MACb,GAAIA,EAAID,GAAU,KAAK,OACrB,OAAO,KAAK,SAAS,SAASC,EAAGA,EAAID,CAAM,EAE3C,MAAM,IAAI,MAAM,4CAA4C,CAEhE,EAEA,SAAS1B,GAAU,CACjB,KAAK,cAAgB,IAAIP,EAC3B,CAEAO,EAAO,UAAU,UAAY,UAAY,CACvC,OAAO,KAAK,cAAc,UAAU,CACtC,EAEAA,EAAO,UAAU,KAAO,SAAUkB,EAAO,CACvC,IAAIhB,EAAO,OAAQgB,EACnB,GAAIhB,IAAS,SACX,KAAK,YAAYgB,CAAK,UACbhB,IAAS,SACd,KAAK,MAAMgB,CAAK,IAAMA,EACxB,KAAK,aAAaA,CAAK,EAEvB,KAAK,YAAYA,CAAK,UAEfhB,IAAS,UACdgB,IAAU,GACZ,KAAK,cAAc,OAAO,GAAI,EACrBA,IAAU,IACnB,KAAK,cAAc,OAAO,GAAI,UAEvBhB,IAAS,YAClB,KAAK,cAAc,OAAO,GAAI,UACrBA,IAAS,SAClB,GAAIgB,IAAU,KACZ,KAAK,cAAc,OAAO,GAAI,MACzB,CACL,IAAIU,EAAcV,EAAM,YACxB,GAAIU,GAAe,MACjB,KAAK,WAAWV,CAAK,UACZU,GAAe,MAAQA,GAAe,MAAQV,aAAiB,MAAQA,aAAiB,KACjG,KAAK,SAASA,CAAK,UACVU,GAAe,YACpBlC,EAAe,mBACjB,KAAK,SAAS,IAAI,WAAWwB,CAAK,CAAC,EAEnC,KAAK,SAASA,CAAK,UAEZ,sBAAuBA,EAC5BxB,EAAe,mBACjB,KAAK,SAAS,IAAI,WAAWwB,EAAM,MAAM,CAAC,EAE1C,KAAK,SAASA,EAAM,MAAM,UAElBU,GAAe,QAAYA,EAAY,SAAS,EAAE,WAAW,OAAO,EAC9E,KAAK,YAAYV,CAAK,UACbU,GAAe,KACxB,KAAK,YAAYV,EAAM,SAAS,CAAC,UACxB,OAAOA,EAAM,cAAiB,WACvC,KAAK,cAAc,OAAOA,EAAM,aAAa,CAAC,MAE9C,OAAM,IAAI,MAAM,SAAWU,EAAY,SAAS,EAAI,qBAAqB,CAE7E,KAEA,OAAM,IAAI,MAAM,SAAW1B,EAAO,qBAAqB,EAEzD,KAAK,cAAc,MAAM,CAC3B,EAEAF,EAAO,UAAU,SAAW,SAAU6B,EAAM,CAC1C,IAAIH,EAASG,EAAK,QAAUA,EAAK,YAAcA,EAAK,KACpD,GAAIH,GAAU,GACZ,KAAK,WAAW,IAAOA,CAAM,UACpBA,GAAU,MACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,UACdA,GAAU,WACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,MAEvB,OAAM,IAAI,MAAM,gBAAgB,EAElC,KAAK,cAAc,OAAOG,CAAI,CAChC,EAEA7B,EAAO,UAAU,YAAc,SAAUY,EAAK,CAC5C,IAAIc,EAASI,GAAWlB,CAAG,EAE3B,GAAIc,GAAU,GACZ,KAAK,WAAW,IAAOA,CAAM,UACpBA,GAAU,MACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,UACdA,GAAU,WACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,MAEvB,OAAM,IAAI,MAAM,gBAAgB,EAElC,KAAK,cAAc,OAAOd,CAAG,CAC/B,EAEAZ,EAAO,UAAU,WAAa,SAAU+B,EAAK,CAC3C,IAAIL,EAASK,EAAI,OACjB,GAAIL,GAAU,GACZ,KAAK,WAAW,IAAOA,CAAM,UACpBA,GAAU,MACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,UACdA,GAAU,WACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,MAEvB,OAAM,IAAI,MAAM,gBAAgB,EAElC,QAASf,EAAI,EAAGA,EAAIe,EAAQf,IAC1B,KAAK,KAAKoB,EAAIpB,EAAE,CAEpB,EAEAX,EAAO,UAAU,aAAe,SAAUgC,EAAK,CAC7C,GAAIA,GAAO,KAASA,GAAO,IACzB,KAAK,cAAc,OAAOA,EAAM,GAAI,UAC3BA,GAAO,GAAQA,GAAO,IAC/B,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,WAAWA,CAAG,UACVA,GAAO,MAASA,GAAO,IAChC,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,UAAUA,CAAG,UACTA,GAAO,GAAUA,GAAO,MACjC,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAG,UACXA,GAAO,QAAWA,GAAO,MAClC,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,WAAWA,CAAG,UACVA,GAAO,GAAcA,GAAO,WACrC,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAG,UACXA,GAAO,aAAeA,GAAO,WACtC,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,WAAWA,CAAG,UACVA,GAAO,qBAAuBA,GAAO,mBAC9C,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,WAAWA,CAAG,UACVA,GAAO,GAAsBA,GAAO,oBAC7C,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAG,MAEpB,OAAM,IAAI,MAAM,iBAAiB,CAErC,EAEAhC,EAAO,UAAU,YAAc,SAAUgC,EAAK,CAC5C,IAAIb,EAAO,EACPa,EAAM,IACRb,EAAO,EACPa,EAAM,CAACA,GAET,IAAIZ,EAAM,KAAK,MAAM,KAAK,IAAIY,CAAG,EAAI,KAAK,GAAG,EACzCC,EAAQD,EAAM,KAAK,IAAI,EAAGZ,CAAG,EAAI,EACjCc,EAAQ,KAAK,MAAMD,EAAQ,KAAK,IAAI,EAAG,EAAE,CAAC,EAC1CE,EAAM,KAAK,IAAI,EAAG,EAAE,EACpBb,EAAOH,GAAQ,GAAQC,EAAM,MAAS,GACvCc,EAAQC,EAAO,QACdZ,EAAMW,EAAQC,EAClB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,WAAWb,CAAG,EACnB,KAAK,WAAWC,CAAG,CACrB,EAEAvB,EAAO,UAAU,YAAc,SAAUoC,EAAK,CAC5C,IAAIC,EAAO,OAAO,KAAKD,CAAG,EACtBV,EAASW,EAAK,OAClB,GAAIX,GAAU,GACZ,KAAK,WAAW,IAAOA,CAAM,UACpBA,GAAU,MACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,UACdA,GAAU,WACnB,KAAK,cAAc,OAAO,GAAI,EAC9B,KAAK,YAAYA,CAAM,MAEvB,OAAM,IAAI,MAAM,gBAAgB,EAElC,QAASY,KAAQF,EACXA,EAAI,eAAeE,CAAI,IACzB,KAAK,KAAKA,CAAI,EACd,KAAK,KAAKF,EAAIE,EAAK,EAGzB,EAEAtC,EAAO,UAAU,WAAa,SAAUgC,EAAK,CAC3C,KAAK,cAAc,OAAOA,CAAG,CAC/B,EAEAhC,EAAO,UAAU,YAAc,SAAUgC,EAAK,CAC5C,KAAK,cAAc,OAAOA,GAAO,CAAC,EAClC,KAAK,cAAc,OAAOA,EAAM,GAAI,CACtC,EAEAhC,EAAO,UAAU,YAAc,SAAUgC,EAAK,CAC5C,IAAIO,EAAIP,EAAM,WACd,KAAK,cAAc,QAAQO,EAAI,cAAgB,EAAE,EACjD,KAAK,cAAc,QAAQA,EAAI,YAAgB,EAAE,EACjD,KAAK,cAAc,QAAQA,EAAI,SAAgB,CAAC,EAChD,KAAK,cAAc,OAAQA,EAAI,GAAW,CAC5C,EAEAvC,EAAO,UAAU,YAAc,SAAUgC,EAAK,CAC5C,IAAIQ,EAAOR,EAAM,KAAK,IAAI,EAAG,EAAE,EAC3BS,EAAMT,EAAM,KAAK,IAAI,EAAG,EAAE,EAC9B,KAAK,cAAc,QAAQQ,EAAO,cAAgB,EAAE,EACpD,KAAK,cAAc,QAAQA,EAAO,YAAgB,EAAE,EACpD,KAAK,cAAc,QAAQA,EAAO,SAAgB,CAAC,EACnD,KAAK,cAAc,OAAQA,EAAO,GAAW,EAC7C,KAAK,cAAc,QAAQC,EAAM,cAAgB,EAAE,EACnD,KAAK,cAAc,QAAQA,EAAM,YAAgB,EAAE,EACnD,KAAK,cAAc,QAAQA,EAAM,SAAgB,CAAC,EAClD,KAAK,cAAc,OAAQA,EAAM,GAAW,CAC9C,EAEAzC,EAAO,UAAU,UAAY,SAAUgC,EAAK,CAC1C,KAAK,cAAc,OAAOA,EAAM,GAAI,CACtC,EAEAhC,EAAO,UAAU,WAAa,SAAUgC,EAAK,CAC3C,KAAK,cAAc,QAAQA,EAAM,QAAW,CAAC,EAC7C,KAAK,cAAc,OAAOA,EAAM,GAAI,CACtC,EAEAhC,EAAO,UAAU,WAAa,SAAUgC,EAAK,CAC3C,KAAK,cAAc,OAAQA,IAAQ,GAAM,GAAI,EAC7C,KAAK,cAAc,QAAQA,EAAM,YAAgB,EAAE,EACnD,KAAK,cAAc,QAAQA,EAAM,SAAgB,CAAC,EAClD,KAAK,cAAc,OAAQA,EAAM,GAAW,CAC9C,EAEAhC,EAAO,UAAU,WAAa,SAAUgC,EAAK,CAC3C,IAAIQ,EAAO,KAAK,MAAMR,EAAM,KAAK,IAAI,EAAG,EAAE,CAAC,EACvCS,EAAMT,EAAM,KAAK,IAAI,EAAG,EAAE,EAC9B,KAAK,cAAc,QAAQQ,EAAO,cAAgB,EAAE,EACpD,KAAK,cAAc,QAAQA,EAAO,YAAgB,EAAE,EACpD,KAAK,cAAc,QAAQA,EAAO,SAAgB,CAAC,EACnD,KAAK,cAAc,OAAQA,EAAO,GAAW,EAC7C,KAAK,cAAc,QAAQC,EAAM,cAAgB,EAAE,EACnD,KAAK,cAAc,QAAQA,EAAM,YAAgB,EAAE,EACnD,KAAK,cAAc,QAAQA,EAAM,SAAgB,CAAC,EAClD,KAAK,cAAc,OAAQA,EAAM,GAAW,CAC9C,EAEA,SAASC,GAAcC,EAAG,CACxB,IAAI7B,EAAO6B,EAAE,WAAW,CAAC,EAEzB,OAAI7B,GAAQ,KAAc,KACtBA,GAAQ,MAAe,MACvBA,GAAQ,QAAiB,OACzBA,GAAQ,SAAkB,QACvB,QACT,CAEA,SAASgB,GAAYlB,EAAK,CACxB,OAAIA,EAAI,OAAS,IAEP,IAAI,KAAK,CAACA,CAAG,CAAC,EAAG,KAElBA,EAAI,QAAQ,oBAAqB8B,EAAY,EAAE,MAE1D,ICzgBA,IAAAE,EAAAC,EAAA,CAAAC,GAAAC,IAAA,cAEA,IAAIC,GAAM,OAAO,UAAU,eACvBC,EAAS,IASb,SAASC,GAAS,CAAC,CASf,OAAO,SACTA,EAAO,UAAY,OAAO,OAAO,IAAI,EAMhC,IAAIA,EAAO,EAAE,YAAWD,EAAS,KAYxC,SAASE,GAAGC,EAAIC,EAASC,EAAM,CAC7B,KAAK,GAAKF,EACV,KAAK,QAAUC,EACf,KAAK,KAAOC,GAAQ,EACtB,CAaA,SAASC,GAAYC,EAASC,EAAOL,EAAIC,EAASC,EAAM,CACtD,GAAI,OAAOF,GAAO,WAChB,MAAM,IAAI,UAAU,iCAAiC,EAGvD,IAAIM,EAAW,IAAIP,GAAGC,EAAIC,GAAWG,EAASF,CAAI,EAC9CK,EAAMV,EAASA,EAASQ,EAAQA,EAEpC,OAAKD,EAAQ,QAAQG,GACXH,EAAQ,QAAQG,GAAK,GAC1BH,EAAQ,QAAQG,GAAO,CAACH,EAAQ,QAAQG,GAAMD,CAAQ,EADxBF,EAAQ,QAAQG,GAAK,KAAKD,CAAQ,GAD1CF,EAAQ,QAAQG,GAAOD,EAAUF,EAAQ,gBAI7DA,CACT,CASA,SAASI,EAAWJ,EAASG,EAAK,CAC5B,EAAEH,EAAQ,eAAiB,EAAGA,EAAQ,QAAU,IAAIN,EACnD,OAAOM,EAAQ,QAAQG,EAC9B,CASA,SAASE,GAAe,CACtB,KAAK,QAAU,IAAIX,EACnB,KAAK,aAAe,CACtB,CASAW,EAAa,UAAU,WAAa,UAAsB,CACxD,IAAIC,EAAQ,CAAC,EACTC,EACAC,EAEJ,GAAI,KAAK,eAAiB,EAAG,OAAOF,EAEpC,IAAKE,KAASD,EAAS,KAAK,QACtBf,GAAI,KAAKe,EAAQC,CAAI,GAAGF,EAAM,KAAKb,EAASe,EAAK,MAAM,CAAC,EAAIA,CAAI,EAGtE,OAAI,OAAO,sBACFF,EAAM,OAAO,OAAO,sBAAsBC,CAAM,CAAC,EAGnDD,CACT,EASAD,EAAa,UAAU,UAAY,SAAmBJ,EAAO,CAC3D,IAAIE,EAAMV,EAASA,EAASQ,EAAQA,EAChCQ,EAAW,KAAK,QAAQN,GAE5B,GAAI,CAACM,EAAU,MAAO,CAAC,EACvB,GAAIA,EAAS,GAAI,MAAO,CAACA,EAAS,EAAE,EAEpC,QAASC,EAAI,EAAGC,EAAIF,EAAS,OAAQG,EAAK,IAAI,MAAMD,CAAC,EAAGD,EAAIC,EAAGD,IAC7DE,EAAGF,GAAKD,EAASC,GAAG,GAGtB,OAAOE,CACT,EASAP,EAAa,UAAU,cAAgB,SAAuBJ,EAAO,CACnE,IAAIE,EAAMV,EAASA,EAASQ,EAAQA,EAChCY,EAAY,KAAK,QAAQV,GAE7B,OAAKU,EACDA,EAAU,GAAW,EAClBA,EAAU,OAFM,CAGzB,EASAR,EAAa,UAAU,KAAO,SAAcJ,EAAOa,EAAIC,EAAIC,EAAIC,EAAIC,EAAI,CACrE,IAAIf,EAAMV,EAASA,EAASQ,EAAQA,EAEpC,GAAI,CAAC,KAAK,QAAQE,GAAM,MAAO,GAE/B,IAAIU,EAAY,KAAK,QAAQV,GACzBgB,EAAM,UAAU,OAChBC,EACAV,EAEJ,GAAIG,EAAU,GAAI,CAGhB,OAFIA,EAAU,MAAM,KAAK,eAAeZ,EAAOY,EAAU,GAAI,OAAW,EAAI,EAEpEM,OACD,GAAG,OAAON,EAAU,GAAG,KAAKA,EAAU,OAAO,EAAG,OAChD,GAAG,OAAOA,EAAU,GAAG,KAAKA,EAAU,QAASC,CAAE,EAAG,OACpD,GAAG,OAAOD,EAAU,GAAG,KAAKA,EAAU,QAASC,EAAIC,CAAE,EAAG,OACxD,GAAG,OAAOF,EAAU,GAAG,KAAKA,EAAU,QAASC,EAAIC,EAAIC,CAAE,EAAG,OAC5D,GAAG,OAAOH,EAAU,GAAG,KAAKA,EAAU,QAASC,EAAIC,EAAIC,EAAIC,CAAE,EAAG,OAChE,GAAG,OAAOJ,EAAU,GAAG,KAAKA,EAAU,QAASC,EAAIC,EAAIC,EAAIC,EAAIC,CAAE,EAAG,GAG3E,IAAKR,EAAI,EAAGU,EAAO,IAAI,MAAMD,EAAK,CAAC,EAAGT,EAAIS,EAAKT,IAC7CU,EAAKV,EAAI,GAAK,UAAUA,GAG1BG,EAAU,GAAG,MAAMA,EAAU,QAASO,CAAI,CAC5C,KAAO,CACL,IAAIC,GAASR,EAAU,OACnBS,EAEJ,IAAKZ,EAAI,EAAGA,EAAIW,GAAQX,IAGtB,OAFIG,EAAUH,GAAG,MAAM,KAAK,eAAeT,EAAOY,EAAUH,GAAG,GAAI,OAAW,EAAI,EAE1ES,OACD,GAAGN,EAAUH,GAAG,GAAG,KAAKG,EAAUH,GAAG,OAAO,EAAG,UAC/C,GAAGG,EAAUH,GAAG,GAAG,KAAKG,EAAUH,GAAG,QAASI,CAAE,EAAG,UACnD,GAAGD,EAAUH,GAAG,GAAG,KAAKG,EAAUH,GAAG,QAASI,EAAIC,CAAE,EAAG,UACvD,GAAGF,EAAUH,GAAG,GAAG,KAAKG,EAAUH,GAAG,QAASI,EAAIC,EAAIC,CAAE,EAAG,cAE9D,GAAI,CAACI,EAAM,IAAKE,EAAI,EAAGF,EAAO,IAAI,MAAMD,EAAK,CAAC,EAAGG,EAAIH,EAAKG,IACxDF,EAAKE,EAAI,GAAK,UAAUA,GAG1BT,EAAUH,GAAG,GAAG,MAAMG,EAAUH,GAAG,QAASU,CAAI,EAGxD,CAEA,MAAO,EACT,EAWAf,EAAa,UAAU,GAAK,SAAYJ,EAAOL,EAAIC,EAAS,CAC1D,OAAOE,GAAY,KAAME,EAAOL,EAAIC,EAAS,EAAK,CACpD,EAWAQ,EAAa,UAAU,KAAO,SAAcJ,EAAOL,EAAIC,EAAS,CAC9D,OAAOE,GAAY,KAAME,EAAOL,EAAIC,EAAS,EAAI,CACnD,EAYAQ,EAAa,UAAU,eAAiB,SAAwBJ,EAAOL,EAAIC,EAASC,EAAM,CACxF,IAAIK,EAAMV,EAASA,EAASQ,EAAQA,EAEpC,GAAI,CAAC,KAAK,QAAQE,GAAM,OAAO,KAC/B,GAAI,CAACP,EACH,OAAAQ,EAAW,KAAMD,CAAG,EACb,KAGT,IAAIU,EAAY,KAAK,QAAQV,GAE7B,GAAIU,EAAU,GAEVA,EAAU,KAAOjB,IAChB,CAACE,GAAQe,EAAU,QACnB,CAAChB,GAAWgB,EAAU,UAAYhB,IAEnCO,EAAW,KAAMD,CAAG,MAEjB,CACL,QAASO,EAAI,EAAGH,EAAS,CAAC,EAAGc,EAASR,EAAU,OAAQH,EAAIW,EAAQX,KAEhEG,EAAUH,GAAG,KAAOd,GACnBE,GAAQ,CAACe,EAAUH,GAAG,MACtBb,GAAWgB,EAAUH,GAAG,UAAYb,IAErCU,EAAO,KAAKM,EAAUH,EAAE,EAOxBH,EAAO,OAAQ,KAAK,QAAQJ,GAAOI,EAAO,SAAW,EAAIA,EAAO,GAAKA,EACpEH,EAAW,KAAMD,CAAG,CAC3B,CAEA,OAAO,IACT,EASAE,EAAa,UAAU,mBAAqB,SAA4BJ,EAAO,CAC7E,IAAIE,EAEJ,OAAIF,GACFE,EAAMV,EAASA,EAASQ,EAAQA,EAC5B,KAAK,QAAQE,IAAMC,EAAW,KAAMD,CAAG,IAE3C,KAAK,QAAU,IAAIT,EACnB,KAAK,aAAe,GAGf,IACT,EAKAW,EAAa,UAAU,IAAMA,EAAa,UAAU,eACpDA,EAAa,UAAU,YAAcA,EAAa,UAAU,GAK5DA,EAAa,SAAWZ,EAKxBY,EAAa,aAAeA,EAKR,OAAOd,GAAvB,cACFA,EAAO,QAAUc,KC9UnB,IAAAkB,EAA4B,QAEtBC,GAAiB,CACtB,WAAY,CACX,CAAE,KAAM,8BAA+B,EACvC,CACC,KAAM,yBACN,SAAU,SACV,WAAY,SACb,CACD,EACA,aAAc,cACf,EAEaC,EAAQ,IAAK,KAAM,CAAN,cACzB,KAAS,WAAa,eACtB,KAAS,WAAa,IAEtB,KAAS,WAAa,MAGtB,KAAS,cAAgBD,GAQzB,UAAkB,OAClB,YAAoB,SAIpB,KAAQ,WAAqB,EAV7B,WAAWE,EAAqB,CAE/B,MAAO,CAACA,GAAM,uCAAuC,KAAKA,CAAE,CAC7D,CASA,MACCC,EACiE,CACjE,IAAMC,EAAS,CAAC,EACVC,EAAOF,EAAK,KACZG,EAAQ,KAAK,KAAKD,EAAOJ,EAAM,UAAU,EAE3CM,EAAQ,EACRC,EAAQ,EAEZ,KAAOA,EAAQH,GAAM,CACpB,IAAMI,EAAM,KAAK,IAAIJ,EAAMG,EAAQP,EAAM,UAAU,EAC7CS,EAAIP,EAAK,MAAMK,EAAOC,CAAG,EAEzBE,EAAQ,CACb,WAAY,KAAK,WACjB,EAAGJ,EACH,KAAMG,EACN,MAAAJ,CACD,EAEAF,EAAO,KAAKO,CAAK,EAEjBH,EAAQC,EACRF,GACD,CAEA,YAAK,aAEEH,CACR,CAEA,kBACCQ,EACAT,EACAU,EACa,CACb,IAAMC,EAAK,IAAIF,EAEf,OAAAE,EAAG,OAAS,SAAUC,EAAK,CACtBA,EAAI,QACPF,EAAGE,EAAI,OAAO,MAAqB,CAErC,EAEAD,EAAG,kBAAkBX,CAAI,EAElBW,CACR,CAEA,0BAA0BE,EAAiD,CAC1E,IAAMC,EAAY,IAAI,WAAWD,EAAO,MAAM,EAE9C,QAASE,EAAI,EAAGA,EAAIF,EAAO,OAAQE,IAClCD,EAAUC,GAAKF,EAAO,WAAWE,CAAC,EAAI,IAGvC,OAAOD,EAAU,MAClB,CAEA,aAAsB,CACrB,OAAO,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,CAAC,CAC3C,CAEA,UAAoB,CACnB,OAAO,SAAS,WAAa,QAC9B,CACD,ECvGA,IAAAE,GAA6B,OCA7B,IAAMC,GAAa,WAgBnB,IAAMC,EAAN,KAAa,CAAb,cACC,KAAQ,UAAY,EAEpB,IAAI,UAAqB,CACxB,OAAO,KAAK,SACb,CAEA,IAAI,SAASC,EAAoB,CAChC,KAAK,UAAYA,CAClB,CAEA,OAAOC,EAAa,CACf,KAAK,WAAa,GACrB,KAAK,OAAO,EAAc,GAAGA,CAAI,CAEnC,CAEA,QAAQA,EAAa,CAChB,KAAK,WAAa,GACrB,KAAK,OAAO,EAAmB,GAAGA,CAAI,CAExC,CAEA,SAASA,EAAa,CACjB,KAAK,WAAa,GACrB,KAAK,OAAO,EAAiB,GAAGA,CAAI,CAEtC,CAEA,eAAeC,EAAqD,CACnE,KAAK,OAASA,CACf,CAEQ,OAAOF,KAAuBG,EAAmB,CACxD,IAAMC,EAAO,CAACC,GAAY,GAAGF,CAAI,EAEjC,QAASG,KAAKF,EACTA,EAAKE,aAAc,QACtBF,EAAKE,GAAK,IAAMF,EAAKE,GAAG,KAAO,KAAOF,EAAKE,GAAG,SAI5CN,GAAY,EACf,QAAQ,IAAI,GAAGI,CAAI,EACTJ,GAAY,EACtB,QAAQ,KAAK,UAAW,GAAGI,CAAI,EACrBJ,GAAY,GACtB,QAAQ,MAAM,QAAS,GAAGI,CAAI,CAEhC,CACD,EAEOG,EAAQ,IAAIR,ECpEnB,IAAAS,GAA6B,OAqBtB,IAAMC,EAAN,cAAqB,eAAa,CAuBxC,YAAY,CACX,OAAAC,EACA,KAAAC,EACA,KAAAC,EACA,KAAAC,EACA,IAAAC,EACA,aAAAC,EAAe,IACf,UAAAC,CACD,EAAiB,CApDlB,IAAAC,EAqDE,MAAM,EA/BP,KAAQ,cAAyB,GACjC,KAAQ,IAAqB,KAC7B,KAAQ,eAAqC,CAAC,EAQ9C,WAAiB,GAEjB,KAAQ,WAAa,GAqBpB,KAAK,aAAeF,EAEpB,IAAMG,EAAaR,EAAS,SAAW,QAEvC,KAAK,SAAWQ,EAAaP,EAAO,IAAMC,EAAOC,EAAO,cAAgBC,EACxE,KAAK,sBAAuBG,EAAAD,GAAA,YAAAA,EAAW,YAAX,KAAAC,EAAwB,OAAO,SAC5D,CAzBA,IAAI,eAA4C,CAC/C,OAAO,KAAK,cACb,CAEA,IAAI,WAAY,CACf,OAAO,KAAK,UACb,CAqBA,MAAME,EAAYC,EAAqB,CACtC,GAAI,KAAK,WAAY,MAAM,IAAI,MAAM,uBAAuB,EAI5D,GAFA,KAAK,IAAMD,EAEP,CAAC,CAAC,KAAK,SAAW,CAAC,KAAK,cAC3B,OAGD,IAAME,EAAQ,GAAG,KAAK,eAAeF,WAAYC,IAEjD,KAAK,QAAU,IAAI,KAAK,qBAAqBC,CAAK,EAClD,KAAK,cAAgB,GAErB,KAAK,QAAQ,UAAaC,GAAU,CACnC,GAAI,KAAK,WAAY,OAErB,IAAIC,EAEJ,GAAI,CACHA,EAAO,KAAK,MAAMD,EAAM,IAAI,EAC5BE,EAAO,IAAI,2BAA4BD,CAAI,CAC5C,OAASE,EAAP,CACDD,EAAO,IAAI,yBAA0BF,EAAM,IAAI,EAC/C,MACD,CAEA,KAAK,eAA8BC,CAAI,CACxC,EAEA,KAAK,QAAQ,QAAWD,GAAU,CAC7B,KAAK,eAAiB,KAAK,aAI/BE,EAAO,IAAI,iBAAkBF,CAAK,EAElC,KAAK,SAAS,EACd,KAAK,cAAgB,GAErB,KAAK,mBAAiC,EACvC,EAIA,KAAK,QAAQ,OAAS,IAAM,CACvB,KAAK,eAAiB,KAAK,aAI/BE,EAAO,IAAI,aAAa,EAExB,KAAK,WAAyB,EAE9B,KAAK,oBAAoB,EAEzB,KAAK,mBAAmB,EACzB,CACD,CAEQ,oBAA2B,CAClC,KAAK,aAAe,WAAW,IAAM,CACpC,KAAK,eAAe,CACrB,EAAG,KAAK,YAAY,CACrB,CAEQ,gBAAuB,CAC9B,GAAI,KAAK,WAAY,OAErB,GAAI,CAAC,KAAK,QAAQ,EAAG,CACpBA,EAAO,IAAI,8CAA8C,EACzD,MACD,CAEA,IAAME,EAAU,KAAK,UAAU,CAAE,gBAAkC,CAAC,EAEpE,KAAK,QAAS,KAAKA,CAAO,EAE1B,KAAK,mBAAmB,CACzB,CAGQ,SAAmB,CAC1B,MAAO,CAAC,CAAC,KAAK,SAAW,KAAK,QAAQ,aAAe,CACtD,CAGQ,qBAA4B,CAGnC,IAAMC,EAAc,CAAC,GAAG,KAAK,cAAc,EAC3C,KAAK,eAAiB,CAAC,EAEvB,QAAWD,KAAWC,EACrB,KAAK,KAAKD,CAAO,EAGdC,EAAY,OAAS,GACxBH,EAAO,IAAI,GAAGG,EAAY,iCAAiC,CAE7D,CAGA,KAAKJ,EAAyB,CAC7B,GAAI,KAAK,WAAY,MAAM,IAAI,MAAM,uBAAuB,EAE5D,GAAI,CAACA,EAAK,KAAM,CACf,KAAK,aAA4B,iBAAiB,EAClD,MACD,CAEA,GAAI,CAAC,KAAK,MACT,OAKD,GAAI,KAAK,KAAO,MAAQ,CAAC,KAAK,QAAQ,EAAG,CACxC,KAAK,eAAe,KAAKA,CAAI,EAC7B,MACD,CAEA,IAAMG,EAAU,KAAK,UAAUH,CAAI,EAEnC,KAAK,QAAS,KAAKG,CAAO,CAC3B,CAEA,OAAc,CACT,KAAK,gBAIT,KAAK,SAAS,EAEd,KAAK,IAAM,KAEX,KAAK,cAAgB,GACtB,CAEQ,UAAiB,CACpB,KAAK,UACR,KAAK,QAAQ,OACZ,KAAK,QAAQ,UACb,KAAK,QAAQ,QACZ,KACF,KAAK,QAAQ,MAAM,EACnB,KAAK,QAAU,QAGhB,aAAa,KAAK,YAAa,CAChC,CAEA,SAAU,CACL,KAAK,aAET,KAAK,MAAM,EACX,KAAK,eAAe,OAAS,EAE7B,KAAK,WAAa,GACnB,CACD,ECpNA,SAASE,IAAa,CAAC,CAIhB,IAAMC,EAAN,KAAiB,CACvB,YAAqBC,EAA4B,CAA5B,gBAAAA,CAA6B,CAElD,IAAY,QAAS,CAlBtB,IAAAC,EAAAC,EAmBE,OAAOA,GAAAD,EAAA,KAAK,WAAW,SAAS,QAAQ,YAAjC,YAAAA,EAA4C,SAA5C,KAAAC,EAAsD,MAC9D,CAGA,gBAAgBC,EAAc,CAC7B,IAAMC,EAAiB,KAAK,qBAAqB,EAUjD,GAPA,KAAK,WAAW,eAAiBA,EAE7B,KAAK,WAAW,gBAAiCD,EAAQ,SAC5D,KAAK,uBAAuBA,EAAQ,QAASC,CAAc,EAIxDD,EAAQ,WAAY,CACvB,GAAI,KAAK,WAAW,cAA8B,CACjD,IAAME,EAAiB,KAAK,WAEtBC,EAA6B,CAAE,QAAS,CAAC,CAACH,EAAQ,QAAS,EAE3DI,EAAcH,EAAe,kBAClCC,EAAe,MACfC,CACD,EACAD,EAAe,WAAWE,CAAW,CACtC,CAEA,KAAK,WAAW,CACjB,MACC,KAAK,UAAU,QAASJ,EAAQ,GAAG,CAErC,CAGQ,sBAA0C,CACjDK,EAAO,IAAI,6BAA6B,EAExC,IAAMC,EAAgC,KAAK,OAAO,kBAE5CL,EAAiB,IAAIK,EAAI,KAAK,WAAW,SAAS,QAAQ,MAAM,EAEtE,YAAK,gBAAgBL,CAAc,EAE5BA,CACR,CAGQ,gBAAgBA,EAAmC,CAC1D,IAAMM,EAAS,KAAK,WAAW,KACzBC,EAAe,KAAK,WAAW,aAC/BC,EAAiB,KAAK,WAAW,KACjCC,EAAW,KAAK,WAAW,SAGjCL,EAAO,IACN,iEACD,EAEAJ,EAAe,eAAkBU,GAAQ,CACpC,CAACA,EAAI,WAAa,CAACA,EAAI,UAAU,YAErCN,EAAO,IAAI,+BAA+BE,KAAWI,EAAI,SAAS,EAElED,EAAS,OAAO,KAAK,CACpB,iBACA,QAAS,CACR,UAAWC,EAAI,UACf,KAAMF,EACN,aAAcD,CACf,EACA,IAAKD,CACN,CAAC,EACF,EAEAN,EAAe,2BAA6B,IAAM,CACjD,OAAQA,EAAe,wBACjB,SACJI,EAAO,IACN,wDAA0DE,CAC3D,EACA,KAAK,WAAW,aAEf,IAAI,MAAM,gCAAkCA,EAAS,UAAU,CAChE,EACA,KAAK,WAAW,MAAM,EACtB,UACI,SACJF,EAAO,IACN,wDAA0DE,CAC3D,EACA,KAAK,WAAW,aAEf,IAAI,MAAM,iBAAmBA,EAAS,UAAU,CACjD,EACA,KAAK,WAAW,MAAM,EACtB,UACI,YACJF,EAAO,IACN,kEACCE,CACF,EACA,UACI,eACJF,EAAO,IACN,qEACCE,CACF,EACA,UACI,YACJF,EAAO,IACN,kEACCE,CACF,EACAN,EAAe,eAAiBN,GAChC,MAGF,KAAK,WAAW,uBAEfM,EAAe,kBAChB,CACD,EAIAA,EAAe,cAAiBU,GAAQ,CACvCN,EAAO,IAAI,uBAAuB,EAElC,IAAMD,EAAcO,EAAI,QACLD,EAAS,cAC3BH,EACAC,CACD,EAEW,WAAWJ,CAAW,CAClC,EAEAH,EAAe,QAAWU,GAAQ,CACjCN,EAAO,IAAI,wBAAwB,EAEnC,IAAMO,EAASD,EAAI,QAAQ,GACrBd,EAAaa,EAAS,cAAcH,EAAQC,CAAY,EAE9D,GAAIX,EAAW,eAA+B,CAC7C,IAAMgB,EAAkBhB,EAExB,KAAK,4BAA4Be,EAAQC,CAAe,CACzD,CACD,CACD,CAEA,SAAgB,CACfR,EAAO,IAAI,iCAAmC,KAAK,WAAW,IAAI,EAElE,IAAMJ,EAAiB,KAAK,WAAW,eAEvC,GAAI,CAACA,EACJ,OAGD,KAAK,WAAW,eAAiB,KAGjCA,EAAe,eACdA,EAAe,2BACfA,EAAe,cACfA,EAAe,QACd,KAEF,IAAMa,EAA0Bb,EAAe,iBAAmB,SAC9Dc,EAAuB,GAE3B,GAAI,KAAK,WAAW,cAA8B,CAEjD,IAAMX,EADiB,KAAK,WACO,YAE/BA,IACHW,EACC,CAAC,CAACX,EAAY,YAAcA,EAAY,aAAe,SAE1D,EAEIU,GAA2BC,IAC9Bd,EAAe,MAAM,CAEvB,CAEc,YAA4B,QAAAe,EAAA,sBACzC,IAAMf,EAAiB,KAAK,WAAW,eACjCS,EAAW,KAAK,WAAW,SAEjC,GAAI,CACH,IAAMO,EAAQ,MAAMhB,EAAe,YAClC,KAAK,WAAW,QAAQ,WACzB,EAEA,GAAIA,EAAe,iBAAmB,SAAU,OAEhDI,EAAO,IAAI,gBAAgB,EAG1B,KAAK,WAAW,QAAQ,cACxB,OAAO,KAAK,WAAW,QAAQ,cAAiB,aAEhDY,EAAM,IACL,KAAK,WAAW,QAAQ,aAAaA,EAAM,GAAG,GAAKA,EAAM,KAG3D,GAAI,CACH,MAAMhB,EAAe,oBAAoBgB,CAAK,EAE9CZ,EAAO,IACN,wBACAY,EACA,OAAO,KAAK,WAAW,MACxB,EAEA,IAAIC,EAAe,CAClB,IAAKD,EACL,KAAM,KAAK,WAAW,KACtB,aAAc,KAAK,WAAW,aAC9B,SAAU,KAAK,WAAW,QAC3B,EAEA,GAAI,KAAK,WAAW,cAA8B,CACjD,IAAMf,EAAiB,KAAK,WAE5BgB,EAAUC,EAAAC,EAAA,GACNF,GADM,CAET,MAAOhB,EAAe,MACtB,SAAUA,EAAe,SACzB,cAAeA,EAAe,aAC/B,EACD,CAEAQ,EAAS,OAAO,KAAK,CACpB,aACA,QAAAQ,EACA,IAAK,KAAK,WAAW,IACtB,CAAC,CACF,OAASG,EAAP,CAGAA,GACA,2FAEAX,EAAS,mBAAgCW,CAAG,EAC5ChB,EAAO,IAAI,kCAAmCgB,CAAG,EAEnD,CACD,OAASC,EAAP,CACDZ,EAAS,mBAAgCY,CAAK,EAC9CjB,EAAO,IAAI,0BAA2BiB,CAAK,CAC5C,CACD,GAEc,aAA6B,QAAAN,EAAA,sBAC1C,IAAMf,EAAiB,KAAK,WAAW,eACjCS,EAAW,KAAK,WAAW,SAEjC,GAAI,CACH,IAAMa,EAAS,MAAMtB,EAAe,aAAa,EAEjD,GAAIA,EAAe,iBAAmB,SAAU,OAEhDI,EAAO,IAAI,iBAAiB,EAG3B,KAAK,WAAW,QAAQ,cACxB,OAAO,KAAK,WAAW,QAAQ,cAAiB,aAEhDkB,EAAO,IACN,KAAK,WAAW,QAAQ,aAAaA,EAAO,GAAG,GAAKA,EAAO,KAG7D,GAAI,CACH,MAAMtB,EAAe,oBAAoBsB,CAAM,EAE/ClB,EAAO,IACN,wBACAkB,EACA,OAAO,KAAK,WAAW,MACxB,EAEAb,EAAS,OAAO,KAAK,CACpB,cACA,QAAS,CACR,IAAKa,EACL,KAAM,KAAK,WAAW,KACtB,aAAc,KAAK,WAAW,YAC/B,EACA,IAAK,KAAK,WAAW,IACtB,CAAC,CACF,OAASF,EAAP,CACDX,EAAS,mBAAgCW,CAAG,EAC5ChB,EAAO,IAAI,kCAAmCgB,CAAG,CAClD,CACD,OAASC,EAAP,CACDZ,EAAS,mBAAgCY,CAAK,EAC9CjB,EAAO,IAAI,4BAA6BiB,CAAK,CAC9C,CACD,GAGM,UAAUE,EAAcC,EAAyB,QAAAT,EAAA,sBACtD,IAAMV,EAAoC,KAAK,OAAO,sBAEtDmB,EAAM,IAAInB,EAAImB,CAAG,EACjB,IAAMxB,EAAiB,KAAK,WAAW,eACjCS,EAAW,KAAK,WAAW,SAEjCL,EAAO,IAAI,6BAA8BoB,CAAG,EAE5C,IAAMC,EAAO,KAEb,GAAI,CACH,MAAMzB,EAAe,qBAAqBwB,CAAG,EAC7CpB,EAAO,IAAI,yBAAyBmB,SAAY,KAAK,WAAW,MAAM,EAClEA,IAAS,UACZ,MAAME,EAAK,YAAY,EAEzB,OAASL,EAAP,CACDX,EAAS,mBAAgCW,CAAG,EAC5ChB,EAAO,IAAI,mCAAoCgB,CAAG,CACnD,CACD,GAGM,gBAAgBM,EAAyB,QAAAX,EAAA,sBAC9CX,EAAO,IAAI,mBAAoBsB,CAAG,EAElC,IAAMC,EAAYD,EAAI,UAChBE,EAAgBF,EAAI,cACpBG,EAASH,EAAI,OACb1B,EAAiB,KAAK,WAAW,eACjCS,EAAW,KAAK,WAAW,SAEjC,GAAI,CACH,IAAMJ,EAA8B,KAAK,OAAO,gBAEhD,MAAML,EAAe,gBACpB,IAAIK,EAAI,CACP,OAAQwB,EACR,cAAeD,EACf,UAAWD,CACZ,CAAC,CACF,EACAvB,EAAO,IAAI,2BAA2B,KAAK,WAAW,MAAM,CAC7D,OAASgB,EAAP,CACDX,EAAS,mBAAgCW,CAAG,EAC5ChB,EAAO,IAAI,8BAA+BgB,CAAG,CAC9C,CACD,GAEQ,uBACPT,EACAX,EACO,CAGP,GAFAI,EAAO,IAAI,0BAA0BO,EAAO,uBAAuB,EAE/D,CAACX,EAAe,SACnB,OAAOI,EAAO,MACb,kEACD,EAGDO,EAAO,UAAU,EAAE,QAASmB,GAAU,CACrC9B,EAAe,SAAS8B,EAAOnB,CAAM,CACtC,CAAC,CACF,CAEQ,4BACPA,EACAC,EACO,CACPR,EAAO,IACN,cAAcO,EAAO,0BAA0BC,EAAgB,cAChE,EAEAA,EAAgB,UAAUD,CAAM,CACjC,CACD,ECjZA,IAAAoB,GAA6B,OAKPC,EAAf,cAAsC,eAAa,CAczD,YACUC,EACFC,EACEC,EACR,CACD,MAAM,EAJG,UAAAF,EACF,cAAAC,EACE,aAAAC,EAhBV,KAAU,MAAQ,GAoBjB,KAAK,SAAWA,EAAQ,QACzB,CAZA,IAAI,MAAO,CACV,OAAO,KAAK,KACb,CAeD,EChBO,IAAMC,EAAN,cAA8BC,CAAe,CAkBnD,YAAYC,EAAgBC,EAAgBC,EAAc,CACzD,MAAMF,EAAQC,EAAUC,CAAO,EAE/B,KAAK,aAAe,KAAK,QAAQ,QACjC,KAAK,aACJ,KAAK,QAAQ,cACbJ,EAAgB,UAAYK,EAAM,YAAY,EAE/C,KAAK,YAAc,IAAIC,EAAW,IAAI,EAElC,KAAK,cACR,KAAK,YAAY,gBAAgB,CAChC,QAAS,KAAK,aACd,WAAY,EACb,CAAC,CAEH,CA3BA,IAAI,MAAO,CACV,aACD,CAEA,IAAI,aAA2B,CAC9B,OAAO,KAAK,YACb,CACA,IAAI,cAA4B,CAC/B,OAAO,KAAK,aACb,CAoBA,UAAUC,EAAc,CACvBC,EAAO,IAAI,mBAAoBD,CAAY,EAE3C,KAAK,cAAgBA,EACrB,MAAM,cAAiCA,CAAY,CACpD,CAEA,cAAcE,EAA8B,CAC3C,IAAMC,EAAOD,EAAQ,KACfE,EAAUF,EAAQ,QAExB,OAAQA,EAAQ,mBAGd,KAAK,YAAY,UAAUC,EAAMC,EAAQ,GAAG,EAC5C,KAAK,MAAQ,GACb,sBAEA,KAAK,YAAY,gBAAgBA,EAAQ,SAAS,EAClD,cAEAH,EAAO,KAAK,6BAA6BE,eAAkB,KAAK,MAAM,EACtE,MAEH,CAEA,OAAOE,EAAqBR,EAAwB,CAAC,EAAS,CAC7D,GAAI,KAAK,aAAc,CACtBI,EAAO,KACN,sFACD,EACA,MACD,CAEA,KAAK,aAAeI,EAEhBR,GAAWA,EAAQ,eACtB,KAAK,QAAQ,aAAeA,EAAQ,cAGrC,KAAK,YAAY,gBAAgBS,EAAAC,EAAA,GAC7B,KAAK,QAAQ,UADgB,CAEhC,QAASF,CACV,EAAC,EAED,IAAMG,EAAW,KAAK,SAAS,aAAa,KAAK,YAAY,EAE7D,QAASN,KAAWM,EACnB,KAAK,cAAcN,CAAO,EAG3B,KAAK,MAAQ,EACd,CAOA,OAAc,CACT,KAAK,cACR,KAAK,YAAY,QAAQ,EACzB,KAAK,YAAc,MAGpB,KAAK,aAAe,KACpB,KAAK,cAAgB,KAEjB,KAAK,WACR,KAAK,SAAS,kBAAkB,IAAI,EAEpC,KAAK,SAAW,MAGb,KAAK,SAAW,KAAK,QAAQ,UAChC,KAAK,QAAQ,QAAU,MAGnB,KAAK,OAIV,KAAK,MAAQ,GAEb,MAAM,YAA8B,EACrC,CACD,EA1HaO,EAANhB,EAAMgB,EACY,UAAY,MCjBrC,IAAAC,GAA6B,OAGtB,IAAMC,EAAN,cAA4B,eAAa,CAI/C,YAA6BC,EAAwB,CACpD,MAAM,EADsB,gBAAAA,EAH7B,KAAQ,OAAiB,CAAC,EAC1B,KAAQ,YAAuB,GAK9B,KAAK,WAAW,OAAUC,GAAQ,CACjC,KAAK,YAAc,GAEfA,EAAI,QACP,KAAK,KAAK,OAAQA,EAAI,OAAO,MAAqB,EAGnD,KAAK,WAAW,CACjB,EAEA,KAAK,WAAW,QAAWA,GAAQ,CAClCC,EAAO,MAAM,uBAAwBD,CAAG,EACxC,KAAK,YAAc,GACnB,KAAK,QAAQ,EACb,KAAK,KAAK,QAASA,CAAG,CACvB,CACD,CAEA,IAAI,OAAgB,CACnB,OAAO,KAAK,MACb,CAEA,IAAI,MAAe,CAClB,OAAO,KAAK,MAAM,MACnB,CAEA,IAAI,YAAsB,CACzB,OAAO,KAAK,WACb,CAEA,MAAME,EAAkB,CACvB,KAAK,MAAM,KAAKA,CAAI,EAEhB,MAAK,YAET,KAAK,WAAW,CACjB,CAEA,SAAgB,CACf,KAAK,WAAW,MAAM,EACtB,KAAK,OAAS,CAAC,CAChB,CAEQ,YAAmB,CACtB,KAAK,OAAS,IACd,KAAK,aAET,KAAK,YAAc,GAEnB,KAAK,WAAW,kBAAkB,KAAK,MAAM,MAAM,CAAC,GACrD,CACD,EC3CO,IAAMC,EAAN,cAA6BC,CAA0C,CAuC7E,YAAYC,EAAgBC,EAAgBC,EAAc,CAzD3D,IAAAC,EAAAC,EA0DE,MAAMJ,EAAQC,EAAUC,CAAO,EAhChC,eAAmC,KAAK,UACxC,WAA+B,KAAK,MAMpC,KAAQ,QAAiB,CAAC,EAC1B,KAAQ,YAAc,EACtB,KAAQ,WAAa,GACrB,KAAQ,aAMJ,CAAC,EAkBJ,KAAK,aACJ,KAAK,QAAQ,cACbJ,EAAe,UAAYO,EAAM,YAAY,EAE9C,KAAK,MAAQ,KAAK,QAAQ,OAAS,KAAK,aACxC,KAAK,cAAgB,KAAK,QAAQ,wBAClC,KAAK,SAAW,CAAC,CAAC,KAAK,QAAQ,SAE/B,KAAK,eACJD,GAAAD,EAAAF,EAAS,QAAQ,YAAjB,YAAAE,EAA4B,aAA5B,KAAAC,EAA0C,OAAO,WAElD,KAAK,eAAiB,IAAIE,EAAc,IAAI,KAAK,aAAe,EAEhE,KAAK,eAAe,GAAG,OAASC,GAAoB,CACnD,KAAK,cAAcA,CAAE,CACtB,CAAC,EAED,KAAK,eAAe,GAAG,QAAS,IAAM,CACrCC,EAAO,MACN,MAAM,KAAK,4EACZ,EACA,KAAK,MAAM,CACZ,CAAC,EAED,KAAK,YAAc,IAAIC,EAAW,IAAI,EAEtC,KAAK,YAAY,gBAChB,KAAK,QAAQ,UAAY,CACxB,WAAY,EACb,CACD,CACD,CA9DA,IAAI,MAAO,CACV,YACD,CAgBA,IAAI,aAA8B,CACjC,OAAO,KAAK,GACb,CAEA,IAAI,YAAqB,CACxB,OAAO,KAAK,WACb,CAyCA,WAAWC,EAA0B,CACpC,KAAK,IAAMA,EACX,KAAK,sBAAsB,CAC5B,CAEQ,uBAA8B,EACjC,CAAC,KAAK,SAAS,SAAS,YAAc,KAAK,SAAS,SAAS,YAChE,KAAK,YAAY,WAAa,eAG/B,KAAK,YAAY,OAAS,IAAM,CAC/BF,EAAO,IAAI,MAAM,KAAK,oCAAoC,EAC1D,KAAK,MAAQ,GACb,KAAK,WAA6B,CACnC,EAEA,KAAK,YAAY,UAAa,GAAM,CACnCA,EAAO,IAAI,MAAM,KAAK,6BAA8B,EAAE,IAAI,EAC1D,KAAK,mBAAmB,CAAC,CAC1B,EAEA,KAAK,YAAY,QAAU,IAAM,CAChCA,EAAO,IAAI,MAAM,KAAK,8BAA+B,KAAK,IAAI,EAC9D,KAAK,MAAM,CACZ,CACD,CAGQ,mBAAmB,CAC1B,KAAAG,CACD,EAES,CACR,IAAMC,EAAWD,EAAK,YAEhBE,EACL,KAAK,0BACL,KAAK,8BAEFC,EAAwBH,EAE5B,GAAIE,GACH,GAAID,IAAa,KAAM,CAEtBP,EAAM,kBAAkB,KAAK,cAAeM,EAAeJ,GAAO,CACjE,IAAMQ,EAAeV,EAAM,OAAOE,CAAE,EACpC,KAAK,YAA+BQ,CAAY,CACjD,CAAC,EACD,MACD,SAAWH,IAAa,YACvBE,EAAmBT,EAAM,OAAOM,CAAmB,UACzCC,IAAa,OAAQ,CAE/B,IAAML,EAAKF,EAAM,0BAA0BM,CAAc,EACzDG,EAAmBT,EAAM,OAAOE,CAAE,CACnC,OACU,KAAK,yBACfO,EAAmB,KAAK,MAAMH,CAAc,GAK7C,GAAIG,EAAiB,WAAY,CAChC,KAAK,aAAaA,CAAgB,EAClC,MACD,CAEA,MAAM,YAA+BA,CAAgB,CACtD,CAEQ,aAAaH,EAKZ,CACR,IAAMK,EAAKL,EAAK,WACVM,EAAY,KAAK,aAAaD,IAAO,CAC1C,KAAM,CAAC,EACP,MAAO,EACP,MAAOL,EAAK,KACb,EAMA,GAJAM,EAAU,KAAKN,EAAK,GAAKA,EAAK,KAC9BM,EAAU,QACV,KAAK,aAAaD,GAAMC,EAEpBA,EAAU,QAAUA,EAAU,MAAO,CAExC,OAAO,KAAK,aAAaD,GAGzB,IAAML,EAAO,IAAI,KAAKM,EAAU,IAAI,EACpC,KAAK,mBAAmB,CAAE,KAAAN,CAAK,CAAC,CACjC,CACD,CAOA,OAAc,CACb,KAAK,QAAU,CAAC,EAChB,KAAK,YAAc,EACnB,KAAK,aAAe,CAAC,EAEjB,KAAK,cACR,KAAK,YAAY,QAAQ,EACzB,KAAK,YAAc,MAGhB,KAAK,WACR,KAAK,SAAS,kBAAkB,IAAI,EAEpC,KAAK,SAAW,MAGb,KAAK,cACR,KAAK,YAAY,OAAS,KAC1B,KAAK,YAAY,UAAY,KAC7B,KAAK,YAAY,QAAU,KAC3B,KAAK,IAAM,MAGR,KAAK,iBACR,KAAK,eAAe,QAAQ,EAC5B,KAAK,eAAe,mBAAmB,EACvC,KAAK,eAAiB,MAGlB,KAAK,OAIV,KAAK,MAAQ,GAEb,MAAM,YAA8B,EACrC,CAGA,KAAKA,EAAWO,EAAyB,CACxC,GAAI,CAAC,KAAK,KAAM,CACf,MAAM,aAEL,IAAI,MACH,yFACD,CACD,EACA,MACD,CAEA,GAAI,KAAK,uBACR,KAAK,cAAc,KAAK,UAAUP,CAAI,CAAC,UAEvC,KAAK,0BACL,KAAK,8BACJ,CACD,IAAMQ,EAAOd,EAAM,KAAKM,CAAI,EAE5B,GAAI,CAACO,GAAWC,EAAK,KAAOd,EAAM,WAAY,CAC7C,KAAK,YAAYc,CAAI,EACrB,MACD,CAEK,KAAK,SAAS,SAAS,WAK3B,KAAK,cAAcA,CAAI,EAFvB,KAAK,eAAe,MAAMA,CAAI,CAIhC,MACC,KAAK,cAAcR,CAAI,CAEzB,CAEQ,cAAcS,EAAgB,EACjC,KAAK,YAAc,CAAC,KAAK,SAASA,CAAG,KACxC,KAAK,QAAQ,KAAKA,CAAG,EACrB,KAAK,YAAc,KAAK,QAAQ,OAElC,CAGQ,SAASA,EAAmB,CACnC,GAAI,CAAC,KAAK,KACT,MAAO,GAGR,GAAI,KAAK,YAAY,eAAiBtB,EAAe,oBACpD,YAAK,WAAa,GAClB,WAAW,IAAM,CAChB,KAAK,WAAa,GAClB,KAAK,WAAW,CACjB,EAAG,EAAE,EAEE,GAGR,GAAI,CACH,KAAK,YAAY,KAAKsB,CAAG,CAC1B,OAASC,EAAP,CACD,OAAAb,EAAO,MAAM,OAAO,KAAK,mCAAoCa,CAAC,EAC9D,KAAK,WAAa,GAElB,KAAK,MAAM,EAEJ,EACR,CAEA,MAAO,EACR,CAGQ,YAAmB,CAK1B,GAJI,CAAC,KAAK,MAIN,KAAK,QAAQ,SAAW,EAC3B,OAGD,IAAMD,EAAM,KAAK,QAAQ,GAErB,KAAK,SAASA,CAAG,IACpB,KAAK,QAAQ,MAAM,EACnB,KAAK,YAAc,KAAK,QAAQ,OAChC,KAAK,WAAW,EAElB,CAEQ,YAAYD,EAAkB,CACrC,IAAMG,EAAQjB,EAAM,MAAMc,CAAI,EAC9BX,EAAO,IAAI,MAAM,KAAK,4BAA4Bc,EAAM,kBAAkB,EAE1E,QAASH,KAAQG,EAChB,KAAK,KAAKH,EAAM,EAAI,CAEtB,CAEA,cAAcI,EAA8B,CAC3C,IAAMC,EAAUD,EAAQ,QAExB,OAAQA,EAAQ,mBAEd,KAAK,YAAY,UAAUA,EAAQ,KAAMC,EAAQ,GAAG,EACpD,sBAEA,KAAK,YAAY,gBAAgBA,EAAQ,SAAS,EAClD,cAEAhB,EAAO,KACN,6BACAe,EAAQ,KACR,aACA,KAAK,IACN,EACA,MAEH,CACD,EAlVaE,EAAN3B,EAAM2B,EACY,UAAY,MADxBA,EAEY,oBAAsB,EAAI,KAAO,KChBnD,IAAMC,EAAN,KAAU,CAChB,YAA6BC,EAAwB,CAAxB,cAAAA,CAAyB,CAE9C,SAASC,EAAa,CAP/B,IAAAC,EAAAC,EAQE,QAAQA,GAAAD,EAAA,KAAK,SAAS,YAAd,YAAAA,EAAyB,QAAzB,KAAAC,EAAkC,OAAO,OAAOF,CAAG,CAC5D,CAEQ,UAAUG,EAAwB,CAEzC,IAAIH,GADa,KAAK,SAAS,OAAS,WAAa,WAGpD,KAAK,SAAS,KACd,IACA,KAAK,SAAS,KACd,KAAK,SAAS,KACd,KAAK,SAAS,IACd,IACAG,EAED,OAAAH,GADoB,OAAS,IAAI,KAAK,EAAE,QAAQ,EAAS,KAAK,OAAO,EAG9DA,CACR,CAGM,YAA8B,QAAAI,EAAA,sBACnC,IAAMJ,EAAM,KAAK,UAAU,IAAI,EAE/B,GAAI,CACH,IAAMK,EAAW,MAAM,KAAK,SAASL,CAAG,EAExC,GAAIK,EAAS,SAAW,IACvB,MAAM,IAAI,MAAM,iBAAiBA,EAAS,QAAQ,EAGnD,OAAOA,EAAS,KAAK,CACtB,OAASC,EAAP,CACDC,EAAO,MAAM,sBAAuBD,CAAK,EAEzC,IAAIE,EAAY,GAEhB,MACC,KAAK,SAAS,OAAS,KACvB,KAAK,SAAS,OAASC,EAAM,aAE7BD,EACC,mIAKI,IAAI,MAAM,uCAAyCA,CAAS,CACnE,CACD,GAGM,cAA+B,QAAAJ,EAAA,sBACpC,IAAMJ,EAAM,KAAK,UAAU,OAAO,EAElC,GAAI,CACH,IAAMK,EAAW,MAAM,KAAK,SAASL,CAAG,EAExC,GAAIK,EAAS,SAAW,IAAK,CAC5B,GAAIA,EAAS,SAAW,IAAK,CAC5B,IAAIK,EAAe,GAEnB,MAAI,KAAK,SAAS,OAASD,EAAM,WAChCC,EACC,sHAGDA,EACC,2FAII,IAAI,MACT,+DACCA,CACF,CACD,CAEA,MAAM,IAAI,MAAM,iBAAiBL,EAAS,QAAQ,CACnD,CAEA,OAAOA,EAAS,KAAK,CACtB,OAASC,EAAP,CACD,MAAAC,EAAO,MAAM,8BAA+BD,CAAK,EAE3C,IAAI,MAAM,4CAA8CA,CAAK,CACpE,CACD,GACD,EChGO,IAAMK,GAAW,CACvB,uBAAuBC,EAAsB,CAK5C,GAJI,CAACA,GAAU,OAAO,QAAW,cAChCA,EAAS,QAIT,OAAOA,EAAO,mBAAsB,aACpC,EAAE,qBAAsBA,EAAO,kBAAkB,WAEjD,MAAO,GAGR,IAAIC,EACAC,EAAY,GAEhB,GAAI,CACHD,EAAS,IAAID,EAAO,kBACpBC,EAAO,eAAe,OAAO,EAC7BC,EAAY,EACb,OAASC,EAAP,CACF,QAAE,CACGF,GACHA,EAAO,MAAM,CAEf,CAEA,OAAOC,CACR,CACD,ETFO,IAAME,EAAN,cAAmB,eAAa,CAwDtC,YAAYC,EAA2BC,EAAuB,CAnF/D,IAAAC,EAoFE,MAAM,EAlDP,KAAQ,IAAqB,KAC7B,KAAQ,cAA+B,KAGvC,KAAQ,WAAa,GACrB,KAAQ,cAAgB,GACxB,KAAQ,MAAQ,GAChB,KAAiB,aAA8C,IAAI,IACnE,KAAiB,cAA8C,IAAI,IA4ClE,IAAIC,EA4DJ,GAzDIH,GAAMA,EAAG,aAAe,OAC3BC,EAAUD,EACAA,IACVG,EAASH,EAAG,SAAS,GAItBC,EAAUG,EAAA,CACT,MAAO,EACP,KAAMC,EAAM,WACZ,KAAMA,EAAM,WACZ,KAAM,IACN,IAAKN,EAAK,YACV,MAAOM,EAAM,YAAY,EACzB,OAAQA,EAAM,eACXJ,GAEJ,KAAK,SAAWA,EAGZ,OAAO,QAAW,aAAe,KAAK,SAAS,OAAS,MAC3D,KAAK,SAAS,KAAO,OAAO,SAAS,UAIlC,KAAK,SAAS,OACb,KAAK,SAAS,KAAK,KAAO,MAC7B,KAAK,SAAS,KAAO,IAAM,KAAK,SAAS,MAEtC,KAAK,SAAS,KAAK,KAAK,SAAS,KAAK,OAAS,KAAO,MACzD,KAAK,SAAS,MAAQ,MAMvB,KAAK,SAAS,SAAW,QACzB,KAAK,SAAS,OAASI,EAAM,WAE7B,KAAK,SAAS,OAASA,EAAM,SAAS,EAC5B,KAAK,SAAS,MAAQA,EAAM,aACtC,KAAK,SAAS,OAAS,IAGpB,KAAK,SAAS,aACjBC,EAAO,eAAe,KAAK,SAAS,WAAW,EAGhDA,EAAO,SAAW,KAAK,SAAS,OAAS,EAEzC,KAAK,KAAO,IAAIC,EAAIN,CAAO,EAC3B,KAAK,QAAU,KAAK,wBAAwB,EAE5C,KAAK,SAAWF,EAAK,aAAYG,EAAA,KAAK,SAAS,YAAd,YAAAA,EAAyB,MAAM,EAI5D,CAAC,KAAK,SAAS,YAAc,CAAC,KAAK,SAAS,KAAM,CACrD,KAAK,qCAEJ,6CACD,EACA,MACD,CAGA,GAAI,CAAC,CAACC,GAAU,CAACE,EAAM,WAAWF,CAAM,EAAG,CAC1C,KAAK,2BAAuC,OAAOA,eAAoB,EACvE,MACD,CAEA,KAAK,OAAO,MAAQ,GAEhBA,EACH,KAAK,YAAYA,CAAM,EAEvB,KAAK,KACH,WAAW,EACX,KAAMH,GAAO,KAAK,YAAYA,CAAE,CAAC,EACjC,MAAOQ,GAAU,KAAK,sBAAkCA,CAAK,CAAC,CAElE,CA9HA,IAAI,IAAK,CACR,OAAO,KAAK,GACb,CAEA,IAAI,SAAU,CACb,OAAO,KAAK,QACb,CAEA,IAAI,MAAO,CACV,OAAO,KAAK,KACb,CAEA,IAAI,QAAS,CACZ,OAAO,KAAK,OACb,CAMA,IAAI,aAAsB,CACzB,IAAMC,EAAmB,OAAO,OAAO,IAAI,EAE3C,OAAS,CAACC,EAAGC,CAAC,IAAK,KAAK,aACvBF,EAAiBC,GAAKC,EAGvB,OAAOF,CACR,CAEA,IAAI,WAAY,CACf,OAAO,KAAK,UACb,CACA,IAAI,cAAe,CAClB,OAAO,KAAK,aACb,CA6FQ,yBAAkC,CACzC,IAAMG,EAAS,IAAIC,EAAO,KAAK,QAAQ,EAEvC,OAAAD,EAAO,aAA6BE,GAAwB,CAC3D,KAAK,eAAeA,CAAI,CACzB,CAAC,EAEDF,EAAO,WAA2BJ,GAAkB,CACnD,KAAK,sBAAkCA,CAAK,CAC7C,CAAC,EAEDI,EAAO,kBAAiC,IAAM,CACzC,KAAK,eAIT,KAAK,oBAAiC,4BAA4B,EAClE,KAAK,WAAW,EACjB,CAAC,EAEDA,EAAO,WAA0B,IAAM,CAClC,KAAK,cAIT,KAAK,uBAEJ,sCACD,CACD,CAAC,EAEMA,CACR,CAGQ,YAAYZ,EAAkB,CACjC,KAAK,YAET,KAAK,IAAMA,EACX,KAAK,OAAO,MAAMA,EAAI,KAAK,SAAS,KAAM,EAC3C,CAGQ,eAAee,EAA8B,CACpD,IAAMC,EAAOD,EAAQ,KACfE,EAAUF,EAAQ,QAClBG,EAASH,EAAQ,IAEvB,OAAQC,cAEN,KAAK,cAAgB,KAAK,GAC1B,KAAK,MAAQ,GACb,KAAK,YAAyB,KAAK,EAAE,EACrC,kBAEA,KAAK,sBAAkCC,EAAQ,GAAG,EAClD,qBAEA,KAAK,wBAAoC,OAAO,KAAK,cAAc,EACnE,wBAEA,KAAK,qBAEJ,YAAY,KAAK,SAAS,iBAC3B,EACA,kBAEAX,EAAO,IAAI,+BAA+BY,GAAQ,EAClD,KAAK,aAAaA,CAAM,EACxB,KAAK,aAAa,OAAOA,CAAM,EAC/B,mBAEA,KAAK,6BAEJ,6BAA6BA,GAC9B,EACA,kBAC6B,CAE7B,IAAMC,EAAeF,EAAQ,aACzBG,EAAa,KAAK,cAAcF,EAAQC,CAAY,EAUxD,GARIC,IACHA,EAAW,MAAM,EACjBd,EAAO,KACN,6CAA6Ca,GAC9C,GAIGF,EAAQ,eACXG,EAAa,IAAIC,EAAgBH,EAAQ,KAAM,CAC9C,aAAcC,EACd,SAAUF,EACV,SAAUA,EAAQ,QACnB,CAAC,EACD,KAAK,eAAeC,EAAQE,CAAU,EACtC,KAAK,YAAyBA,CAAU,UAC9BH,EAAQ,cAClBG,EAAa,IAAIE,EAAeJ,EAAQ,KAAM,CAC7C,aAAcC,EACd,SAAUF,EACV,SAAUA,EAAQ,SAClB,MAAOA,EAAQ,MACf,cAAeA,EAAQ,cACvB,SAAUA,EAAQ,QACnB,CAAC,EACD,KAAK,eAAeC,EAAQE,CAAU,EACtC,KAAK,kBAA+BA,CAAU,MACxC,CACNd,EAAO,KAAK,sCAAsCW,EAAQ,MAAM,EAChE,MACD,CAGA,IAAMM,EAAW,KAAK,aAAaJ,CAAY,EAC/C,QAASJ,KAAWQ,EACnBH,EAAW,cAAcL,CAAO,EAGjC,KACD,SACS,CACR,GAAI,CAACE,EAAS,CACbX,EAAO,KACN,yCAAyCY,aAAkBF,GAC5D,EACA,MACD,CAEA,IAAMG,EAAeF,EAAQ,aACvBG,EAAa,KAAK,cAAcF,EAAQC,CAAY,EAEtDC,GAAcA,EAAW,eAE5BA,EAAW,cAAcL,CAAO,EACtBI,EAEV,KAAK,cAAcA,EAAcJ,CAAO,EAExCT,EAAO,KAAK,wCAAyCS,CAAO,EAE7D,KACD,EAEF,CAGQ,cAAcI,EAAsBJ,EAA8B,CACpE,KAAK,cAAc,IAAII,CAAY,GACvC,KAAK,cAAc,IAAIA,EAAc,CAAC,CAAC,EAGxC,KAAK,cAAc,IAAIA,CAAY,EAAE,KAAKJ,CAAO,CAClD,CAIO,aAAaI,EAAuC,CAC1D,IAAMI,EAAW,KAAK,cAAc,IAAIJ,CAAY,EAEpD,OAAII,GACH,KAAK,cAAc,OAAOJ,CAAY,EAC/BI,GAGD,CAAC,CACT,CAMA,QAAQC,EAAcvB,EAA6B,CAAC,EAAmB,CACtE,GAAI,KAAK,aAAc,CACtBK,EAAO,KACN,+OAID,EACA,KAAK,yBAEJ,6DACD,EACA,MACD,CAEA,IAAMmB,EAAiB,IAAIH,EAAeE,EAAM,KAAMvB,CAAO,EAC7D,YAAK,eAAeuB,EAAMC,CAAc,EACjCA,CACR,CAMA,KAAKD,EAAcE,EAAqBzB,EAAe,CAAC,EAAoB,CAC3E,GAAI,KAAK,aAAc,CACtBK,EAAO,KACN,mKAGD,EACA,KAAK,yBAEJ,6DACD,EACA,MACD,CAEA,GAAI,CAACoB,EAAQ,CACZpB,EAAO,MACN,+EACD,EACA,MACD,CAEAL,EAAQ,QAAUyB,EAElB,IAAMC,EAAkB,IAAIN,EAAgBG,EAAM,KAAMvB,CAAO,EAC/D,YAAK,eAAeuB,EAAMG,CAAe,EAClCA,CACR,CAGQ,eAAeT,EAAgBE,EAAkC,CACxEd,EAAO,IACN,kBAAkBc,EAAW,QAAQA,EAAW,0BAA0BF,GAC3E,EAEK,KAAK,aAAa,IAAIA,CAAM,GAChC,KAAK,aAAa,IAAIA,EAAQ,CAAC,CAAC,EAEjC,KAAK,aAAa,IAAIA,CAAM,EAAE,KAAKE,CAAU,CAC9C,CAGA,kBAAkBA,EAAkC,CACnD,IAAMQ,EAAc,KAAK,aAAa,IAAIR,EAAW,IAAI,EAEzD,GAAIQ,EAAa,CAChB,IAAMC,EAAQD,EAAY,QAAQR,CAAU,EAExCS,IAAU,KACbD,EAAY,OAAOC,EAAO,CAAC,EAEvBD,EAAY,SAAW,GAC1B,KAAK,aAAa,OAAOR,EAAW,IAAI,EAG3C,CAGA,KAAK,cAAc,OAAOA,EAAW,YAAY,CAClD,CAGA,cAAcF,EAAgBC,EAA6C,CAC1E,IAAMS,EAAc,KAAK,aAAa,IAAIV,CAAM,EAChD,GAAI,CAACU,EACJ,OAAO,KAGR,QAASR,KAAcQ,EACtB,GAAIR,EAAW,eAAiBD,EAC/B,OAAOC,EAIT,OAAO,IACR,CAEQ,cAAcJ,EAAqBD,EAA+B,CACzE,WAAW,IAAM,CAChB,KAAK,OAAOC,EAAMD,CAAO,CAC1B,EAAG,CAAC,CACL,CAOQ,OAAOC,EAAqBD,EAA+B,CAClET,EAAO,MAAM,WAAW,EAExB,KAAK,UAAUU,EAAMD,CAAO,EAEvB,KAAK,cAGT,KAAK,WAAW,EAFhB,KAAK,QAAQ,CAIf,CAGA,UAAUC,EAAqBc,EAA2B,CACzDxB,EAAO,MAAM,SAAUwB,CAAG,EAE1B,IAAItB,EAEA,OAAOsB,GAAQ,SAClBtB,EAAQ,IAAI,MAAMsB,CAAG,EAErBtB,EAAQsB,EAGTtB,EAAM,KAAOQ,EAEb,KAAK,aAA0BR,CAAK,CACrC,CAQA,SAAgB,CACX,KAAK,YAITF,EAAO,IAAI,wBAAwB,KAAK,IAAI,EAE5C,KAAK,WAAW,EAChB,KAAK,SAAS,EAEd,KAAK,OAAO,QAAQ,EAEpB,KAAK,WAAa,GAElB,KAAK,YAAwB,EAC9B,CAGQ,UAAiB,CACxB,QAASY,KAAU,KAAK,aAAa,KAAK,EACzC,KAAK,aAAaA,CAAM,EACxB,KAAK,aAAa,OAAOA,CAAM,EAGhC,KAAK,OAAO,mBAAmB,CAChC,CAGQ,aAAaA,EAAsB,CAC1C,IAAMU,EAAc,KAAK,aAAa,IAAIV,CAAM,EAEhD,GAAI,EAACU,EAEL,QAASR,KAAcQ,EACtBR,EAAW,MAAM,CAEnB,CAQA,YAAmB,CAClB,GAAI,KAAK,aACR,OAGD,IAAMW,EAAY,KAAK,GAEvBzB,EAAO,IAAI,2BAA2ByB,GAAW,EAEjD,KAAK,cAAgB,GACrB,KAAK,MAAQ,GAEb,KAAK,OAAO,MAAQ,GACpB,KAAK,OAAO,MAAM,EAElB,KAAK,cAAgBA,EACrB,KAAK,IAAM,KAEX,KAAK,oBAAiCA,CAAS,CAChD,CAGA,WAAkB,CACjB,GAAI,KAAK,cAAgB,CAAC,KAAK,UAC9BzB,EAAO,IACN,6CAA6C,KAAK,eACnD,EACA,KAAK,cAAgB,GACrB,KAAK,OAAO,MAAQ,GACpB,KAAK,YAAY,KAAK,aAAc,MAC9B,IAAI,KAAK,UACf,MAAM,IAAI,MACT,0EACD,EACM,GAAI,CAAC,KAAK,cAAgB,CAAC,KAAK,KAEtCA,EAAO,MACN,gEACD,MAEA,OAAM,IAAI,MACT,QAAQ,KAAK,qEACd,EAEF,CAQA,aAAa0B,EAAMC,GAAa,CAAC,EAAS,CACzC,KAAK,KACH,aAAa,EACb,KAAMC,GAAUF,EAAGE,CAAK,CAAC,EACzB,MAAO1B,GAAU,KAAK,sBAAkCA,CAAK,CAAC,CACjE,CAEA,OAAO,YAAY2B,EAAuB,CACzC,MAAI,CAACA,GAAU,OAAO,QAAW,cAChCA,EAAS,QAGLpC,EAAK,YACTA,EAAK,UAAYA,EAAK,cAAcoC,CAAM,GAGpCpC,EAAK,SACb,CAKA,OAAe,cAAcoC,EAAuB,CAC/C,CAACA,GAAU,OAAO,QAAW,cAChCA,EAAS,QAGV,IAAMC,EAAsB,CAC3B,OAAQ,OAAOD,EAAO,mBAAsB,YAC5C,WAAY,GACZ,KAAM,GACN,WAAY,GACZ,SAAU,GACV,YAAa,EACd,EAEA,GAAI,CAACC,EAAU,OAAQ,OAAOA,EAE9B,IAAIC,EAEJ,GAAI,CACHA,EAAK,IAAIF,EAAO,kBAAkB9B,EAAM,aAAa,EACrD,IAAIiC,EAEJ,GAAI,CACHA,EAAKD,EAAG,kBAAkB,cAAe,CAAE,QAAS,EAAK,CAAC,EAC1DD,EAAU,KAAO,GACjBA,EAAU,SAAW,CAAC,CAACE,EAAG,QAG1B,GAAI,CACHA,EAAG,WAAa,OAChBF,EAAU,WAAa,EACxB,OAASG,EAAP,CAAW,CACd,OAASA,EAAP,CACF,QAAE,CACGD,GACHA,EAAG,MAAM,CAEX,CACD,OAASC,EAAP,CACF,QAAE,CACGF,GACHA,EAAG,MAAM,CAEX,CAEA,OAAAD,EAAU,YAAcI,GAAS,uBAAuBL,CAAM,EAEvDC,CACR,CACD,EAvnBaK,EAAN1C,EAAM0C,EACY,YAAc,SUvBvC,IAAOC,GAAQC,EAEX,OAAO,QAAW,cAErB,OAAO,KAAOA",
  "names": ["require_bufferbuilder", "__commonJSMin", "exports", "module", "binaryFeatures", "e", "BlobBuilder", "BufferBuilder", "data", "buf", "builder", "i", "ii", "require_binarypack", "__commonJSMin", "exports", "module", "BufferBuilder", "binaryFeatures", "BinaryPack", "data", "unpacker", "Unpacker", "packer", "Packer", "buffer", "type", "size", "byte", "bytes", "uint16", "uint32", "uint64", "uint8", "buf", "i", "str", "c", "code", "objects", "map", "key", "value", "sign", "exp", "fraction", "h32", "l32", "hfrac", "frac", "length", "j", "constructor", "blob", "utf8Length", "ary", "num", "frac0", "frac1", "b32", "obj", "keys", "prop", "n", "high", "low", "_utf8Replace", "m", "require_eventemitter3", "__commonJSMin", "exports", "module", "has", "prefix", "Events", "EE", "fn", "context", "once", "addListener", "emitter", "event", "listener", "evt", "clearEvent", "EventEmitter", "names", "events", "name", "handlers", "i", "l", "ee", "listeners", "a1", "a2", "a3", "a4", "a5", "len", "args", "length", "j", "BinaryPack", "DEFAULT_CONFIG", "Utils", "id", "blob", "chunks", "size", "total", "index", "start", "end", "b", "chunk", "FileReaderCtr", "cb", "fr", "evt", "binary", "byteArray", "i", "import_eventemitter3", "LOG_PREFIX", "Logger", "logLevel", "args", "fn", "rest", "copy", "LOG_PREFIX", "i", "logger_default", "import_eventemitter3", "Socket", "secure", "host", "port", "path", "key", "pingInterval", "polyfills", "_a", "wsProtocol", "id", "token", "wsUrl", "event", "data", "logger_default", "e", "message", "copiedQueue", "noop", "Negotiator", "connection", "_a", "_b", "options", "peerConnection", "dataConnection", "config", "dataChannel", "logger_default", "ctr", "peerId", "connectionId", "connectionType", "provider", "evt", "stream", "mediaConnection", "peerConnectionNotClosed", "dataChannelNotClosed", "__async", "offer", "payload", "__spreadProps", "__spreadValues", "err", "err_1", "answer", "type", "sdp", "self", "ice", "candidate", "sdpMLineIndex", "sdpMid", "track", "import_eventemitter3", "BaseConnection", "peer", "provider", "options", "_MediaConnection", "BaseConnection", "peerId", "provider", "options", "Utils", "Negotiator", "remoteStream", "logger_default", "message", "type", "payload", "stream", "__spreadProps", "__spreadValues", "messages", "MediaConnection", "import_eventemitter3", "EncodingQueue", "fileReader", "evt", "logger_default", "blob", "_DataConnection", "BaseConnection", "peerId", "provider", "options", "_a", "_b", "Utils", "EncodingQueue", "ab", "logger_default", "Negotiator", "dc", "data", "datatype", "isBinarySerialization", "deserializedData", "unpackedData", "id", "chunkInfo", "chunked", "blob", "msg", "e", "blobs", "message", "payload", "DataConnection", "API", "_options", "url", "_a", "_b", "method", "__async", "response", "error", "logger_default", "pathError", "Utils", "helpfulError", "Supports", "webRtc", "tempPc", "supported", "e", "_Peer", "id", "options", "_a", "userId", "__spreadValues", "Utils", "logger_default", "API", "error", "plainConnections", "k", "v", "socket", "Socket", "data", "message", "type", "payload", "peerId", "connectionId", "connection", "MediaConnection", "DataConnection", "messages", "peer", "dataConnection", "stream", "mediaConnection", "connections", "index", "err", "currentId", "cb", "_", "peers", "webRtc", "supported", "pc", "dc", "e", "Supports", "Peer", "lib_default", "Peer"]
}
